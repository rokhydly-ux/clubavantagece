<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    

    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
                url("https://deegreez.fr/wp-content/uploads/2023/10/quel-budget-pour-une-cuisine-professionnelle-scaled.jpeg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(34, 168, 220, 0.3); }
            to { box-shadow: 0 0 40px rgba(34, 168, 220, 0.6), 0 0 60px rgba(253, 216, 53, 0.3); }
        }
        
        .card-shine {
            position: relative;
            overflow: hidden;
        }
        
        .card-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .points-counter {
            animation: pointsGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pointsGlow {
            from { text-shadow: 0 0 10px #fdd835; }
            to { text-shadow: 0 0 20px #fdd835, 0 0 30px #fbc02d; }
        }
        
        .qr-container {
            background: linear-gradient(45deg, #ffffff, #f8f9fa);
            border: 3px solid #22a8dc;
            animation: qrPulse 3s ease-in-out infinite;
        }
        
        @keyframes qrPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- √âcran de chargement -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner w-16 h-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Club Avantage CE</h2>
            <p class="text-blue-200">Chargement de votre espace membre...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg p-4 text-center">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="w-10"></div>
            <div class="flex items-center space-x-3">
                <img src="https://jokkootech.com/wp-content/uploads/elementor/thumbs/CENTRAL_EQUIPEMENT-1-removebg-preview-qmtu95vg6ca8in6ds4b6xx9yzi550nl7zpyzehgycc.webp" 
                     alt="Central Equipements" 
                     class="h-10 w-auto object-contain"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 class="text-xl font-bold text-black hidden cursor-pointer hover:opacity-80 transition-opacity" 
                    style="color: #22a8dc;">CENTRAL EQUIPEMENTS</h1>
                <div class="text-center">
                    <h2 class="text-lg font-bold text-black">Club Avantage CE</h2>
                    <p class="text-xs text-gray-600">Votre fid√©lit√© r√©compens√©e</p>
                </div>
            </div>
            <button id="logout-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2 text-sm font-semibold" style="display: none;">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                </svg>
                <span>D√©connexion</span>
            </button>
        </div>
    </header>

    <!-- √âCRAN D'AUTHENTIFICATION -->
    <div id="auth-screen" class="min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-8">
            <!-- Titre d'accueil -->
            <div class="text-center space-y-4 fade-in">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-3xl font-black text-white">Rejoignez le Club Avantage CE !</h2>
                <p class="text-xl text-white/90 font-semibold">
                    Inscrivez-vous maintenant et recevez votre cadeau de bienvenue : <span class="text-yellow-300 font-black">-5% sur votre achat d'aujourd'hui !</span>
                </p>
            </div>

            <!-- B√©n√©fices -->
            <div class="glass-effect rounded-2xl p-6 pulse-glow">
                <h3 class="text-xl font-bold text-center mb-4" style="color: #22a8dc;">üéØ Vos Avantages Exclusifs</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3 p-2 bg-green-50 rounded-lg">
                        <div class="bg-green-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Un bonus de -5% imm√©diat</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Cumulez des points √† chaque visite</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-purple-50 rounded-lg">
                        <div class="bg-purple-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Acc√©dez √† des r√©compenses exclusives</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-yellow-50 rounded-lg">
                        <div class="bg-yellow-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Obtenez votre carte de fid√©lit√© virtuelle</span>
                    </div>
                </div>
            </div>

            <!-- Onglets Inscription/Connexion -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button id="signup-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-blue-500 text-white" onclick="switchTab('signup')">
                        Inscription
                    </button>
                    <button id="signin-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-600 hover:text-gray-800" onclick="switchTab('signin')">
                        Connexion
                    </button>
                </div>

                <!-- Formulaire d'inscription -->
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="signup-prenom" placeholder="Pr√©nom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                        <input type="text" id="signup-nom" placeholder="Nom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    </div>
                    <input type="email" id="signup-email" placeholder="Email (pour vous connecter)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <input type="tel" id="signup-telephone" placeholder="T√©l√©phone" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <input type="text" id="signup-ticket" placeholder="N¬∞ de facture (ex: S01032 ou 00000-003-0012)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                           pattern="^(S\d{5}|\d{5}-\d{3}-\d{4})$"
                           title="Format requis: S suivi de 5 chiffres (ex: S01032) ou format 00000-003-0012">
                    <input type="password" id="signup-password" placeholder="Mot de passe (min. 6 caract√®res)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="signup-terms" required class="rounded border-gray-300 text-blue-600">
                        <label for="signup-terms" class="text-xs text-gray-700">
                            J'accepte les conditions et de recevoir les offres exclusives
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 card-shine">
                        üéÅ Je m'inscris et je re√ßois mon bonus !
                    </button>
                </form>

                <!-- Formulaire de connexion -->
                <form id="signin-form" class="space-y-4 hidden">
                    <input type="email" id="signin-email" placeholder="Email" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <input type="password" id="signin-password" placeholder="Mot de passe" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                        üîë Me connecter √† mon compte
                    </button>
                </form>
                
                <div id="auth-message" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- √âCRAN DE LA CARTE MEMBRE -->
    <div id="card-screen" class="hidden min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-4">
            <!-- Carte de membre virtuelle -->
            <div class="glass-effect rounded-2xl p-6 card-shine">
                <div class="text-center space-y-4">
                    <div class="flex items-center justify-center space-x-2 mb-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <h2 class="text-2xl font-bold" style="color: #22a8dc;">Carte Membre VIP</h2>
                        <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                        </svg>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-white">
                        <h3 class="text-lg font-bold" id="member-name">Membre CE</h3>
                        <p class="text-sm opacity-90" id="member-email">email@example.com</p>
                        <div class="mt-3 flex justify-between items-center">
                            <div>
                                <p class="text-xs opacity-75">Niveau</p>
                                <p class="font-bold" id="member-tier">Bronze</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs opacity-75">Membre depuis</p>
                                <p class="font-bold text-sm" id="member-since">2024</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solde de points -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">üí∞ Vos Points</h3>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-6 text-white">
                        <div class="text-4xl font-black points-counter" id="points-balance">0</div>
                        <p class="text-sm opacity-90 mt-1">Points disponibles</p>
                    </div>
                    
                    <!-- Barre de progression niveau -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm font-semibold text-gray-600">
                            <span>Niveau: <span id="current-level">Bronze</span></span>
                            <span>Prochain: <span id="next-level">Argent</span></span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-yellow-500 h-full rounded-full transition-all duration-1000" 
                                 id="level-progress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-600 text-center" id="points-to-next">50 points pour le niveau suivant</p>
                    </div>
                </div>
            </div>

            <!-- QR Code personnel avec validation ticket -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">üì± Votre QR Code Personnel</h3>
                    
                    <!-- Formulaire de validation ticket -->
                    <div id="ticket-validation-form" class="space-y-4">
                        <p class="text-sm text-gray-600">Pour obtenir votre r√©duction, saisissez d'abord votre nouveau num√©ro de facture :</p>
                        <div class="space-y-3">
                            <input type="text" id="new-ticket-number" placeholder="N¬∞ de facture (ex: S01032 ou 00000-003-0012)" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                                   pattern="^(S\d{5}|\d{5}-\d{3}-\d{4})$">
                            <button onclick="validateTicketAndShowQR()" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-xl transition-all">
                                üé´ Valider et obtenir mon QR Code
                            </button>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-xs text-yellow-800 font-medium">
                                ‚ö†Ô∏è Chaque num√©ro de facture ne peut √™tre utilis√© qu'une seule fois. Votre QR Code sera valable 24h apr√®s validation.
                            </p>
                        </div>
                    </div>
                    
                    <!-- QR Code (masqu√© par d√©faut) -->
                    <div id="qr-code-section" class="hidden space-y-4">
                        <p class="text-sm text-green-600 font-semibold">‚úÖ Ticket valid√© ! Pr√©sentez ce code en caisse :</p>
                        
                        <div class="qr-container rounded-xl p-4 mx-auto w-fit">
                            <div id="qrcode-container" class="mx-auto"></div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-xs text-green-800 font-medium">
                                üîí QR Code valable jusqu'√† <span id="qr-expiry"></span>
                            </p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-xs text-blue-800 font-medium">
                                üí° Ce code est unique et s√©curis√©. Il permet au personnel de vous identifier et d'appliquer votre r√©duction de 5%.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="space-y-3">
                <button onclick="refreshData()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all">
                    üîÑ Actualiser mes donn√©es
                </button>
                
                <button onclick="shareApp()" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all">
                    üë• Partager l'application
                </button>
            </div>

            <!-- Historique r√©cent -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4" style="color: #22a8dc;">üìä Activit√© R√©cente</h3>
                <div id="recent-activity" class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium">Inscription</span>
                        </div>
                        <span class="text-sm text-gray-600">+50 pts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be",
            measurementId: "G-Y0187YGWCT"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Maintenant on peut initialiser auth et db
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales - d√©clar√©es mais pas encore assign√©es
        let currentUser = null;
        let userDataListener = null;
        let loadingScreen;
        let authScreen;
        let cardScreen;
        let logoutBtn;
        let signupForm;
        let signinForm;
        let authMessage;

        // Point d'entr√©e unique - Attendre que TOUT soit charg√© (HTML, CSS, Firebase, images)
        window.onload = function() {
            console.log('üöÄ Page compl√®tement charg√©e, initialisation de l\'application...');
            
            try {
                // 1. ASSIGNATION DES VARIABLES DOM (maintenant qu'elles existent)
                loadingScreen = document.getElementById('loading-screen');
                authScreen = document.getElementById('auth-screen');
                cardScreen = document.getElementById('card-screen');
                logoutBtn = document.getElementById('logout-btn');
                signupForm = document.getElementById('signup-form');
                signinForm = document.getElementById('signin-form');
                authMessage = document.getElementById('auth-message');
                
                // V√©rifications de s√©curit√©
                if (!loadingScreen || !authScreen || !cardScreen) {
                    console.error('‚ùå √âl√©ments DOM critiques manquants');
                    return;
                }
                
                console.log('‚úÖ Tous les √©l√©ments DOM trouv√©s');
                
                // 2. AFFICHAGE DE L'√âCRAN DE CHARGEMENT
                showLoadingScreen();
                
                // 3. ATTACHEMENT DES √âV√âNEMENTS
                attachEventListeners();
                
                // 4. D√âMARRAGE DE L'√âCOUTEUR D'AUTHENTIFICATION FIREBASE
                console.log('üî• D√©marrage de l\'√©couteur Firebase...');
                startAuthListener();
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                hideLoadingScreen();
                showMessage('Erreur de chargement. Veuillez actualiser la page.', 'error');
            }
        };

        // Fonction pour attacher tous les √©v√©nements
        function attachEventListeners() {
            console.log('üîó Attachement des √©v√©nements...');
            
            // Formulaires
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('‚úÖ √âv√©nement inscription attach√©');
            }
            
            if (signinForm) {
                signinForm.addEventListener('submit', handleSignin);
                console.log('‚úÖ √âv√©nement connexion attach√©');
            }
            
            // Bouton de d√©connexion
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
                console.log('‚úÖ √âv√©nement d√©connexion attach√©');
            }
            
            // Formatage du t√©l√©phone
            const phoneInput = document.getElementById('signup-telephone');
            if (phoneInput) {
                phoneInput.addEventListener('input', formatPhoneNumber);
                console.log('‚úÖ Formatage t√©l√©phone attach√©');
            }
        }

        // √âcouteur d'√©tat d'authentification - Optimis√©
        function startAuthListener() {
            auth.onAuthStateChanged((user) => {
                console.log('üîê Changement d\'√©tat d\'authentification:', user ? 'Utilisateur connect√©' : 'Utilisateur d√©connect√©');
                
                // Masquer l'√©cran de chargement dans tous les cas
                hideLoadingScreen();
                
                if (user) {
                    console.log('üë§ Utilisateur connect√©:', user.email);
                    currentUser = user;
                    
                    // S√©quence d'affichage pour utilisateur connect√©
                    showCardScreen();
                    showLogoutButton();
                    loadUserData(user);
                    
                } else {
                    console.log('üëã Aucun utilisateur connect√©');
                    currentUser = null;
                    
                    // Nettoyer les donn√©es utilisateur
                    if (userDataListener) {
                        userDataListener();
                        userDataListener = null;
                    }
                    
                    // S√©quence d'affichage pour utilisateur d√©connect√©
                    showAuthScreen();
                    hideLogoutButton();
                }
            });
        }

        // Fonctions d'affichage/masquage du bouton de d√©connexion
        function showLogoutButton() {
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
                console.log('‚úÖ Bouton de d√©connexion affich√©');
            }
        }

        function hideLogoutButton() {
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
                console.log('‚úÖ Bouton de d√©connexion masqu√©');
            }
        }

        // Gestion des onglets
        function switchTab(tab) {
            const signupTab = document.getElementById('signup-tab');
            const signinTab = document.getElementById('signin-tab');
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            
            if (tab === 'signup') {
                signupTab.classList.add('bg-blue-500', 'text-white');
                signupTab.classList.remove('text-gray-600');
                signinTab.classList.remove('bg-blue-500', 'text-white');
                signinTab.classList.add('text-gray-600');
                signupForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
            } else {
                signinTab.classList.add('bg-blue-500', 'text-white');
                signinTab.classList.remove('text-gray-600');
                signupTab.classList.remove('bg-blue-500', 'text-white');
                signupTab.classList.add('text-gray-600');
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            }
        }

        // Fonction d'inscription
        async function handleSignup(e) {
            e.preventDefault();
            
            const prenom = document.getElementById('signup-prenom').value.trim();
            const nom = document.getElementById('signup-nom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const telephone = document.getElementById('signup-telephone').value.trim();
            const ticketNumber = document.getElementById('signup-ticket').value.trim();
            const password = document.getElementById('signup-password').value;
            const terms = document.getElementById('signup-terms').checked;
            
            if (!terms) {
                showAuthMessage('Veuillez accepter les conditions.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Le mot de passe doit contenir au moins 6 caract√®res.', 'error');
                return;
            }
            
            // --- BLOC DE VALIDATION DU TICKET ---
            const formatS = /^S\d{5}$/i; // Commence par S (insensible √† la casse), suivi par EXACTEMENT 5 chiffres.
            const formatLong = /^\d{5}-\d{3}-\d{4}$/; // Format 00000-003-0012

            if (!formatS.test(ticketNumber) && !formatLong.test(ticketNumber)) {
                showAuthMessage('Format du N¬∞ de facture invalide. Ex: S01234 ou 00000-003-0012', 'error');
                return; // Arr√™te la fonction si le format est incorrect
            }
            // --- FIN DU BLOC DE VALIDATION ---
            
            // V√©rifier si le ticket existe d√©j√†
            const ticketExists = await checkTicketExists(ticketNumber);
            if (ticketExists) {
                showAuthMessage('Ce num√©ro de facture a d√©j√† √©t√© utilis√©.', 'error');
                return;
            }
            
            try {
                showAuthMessage('Cr√©ation de votre compte...', 'info');
                
                // Cr√©er le compte utilisateur
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Mettre √† jour le profil
                await user.updateProfile({
                    displayName: `${prenom} ${nom}`
                });
                
                // Cr√©er le document utilisateur dans Firestore
                await db.collection('users').doc(user.uid).set({
                    nom: nom,
                    prenom: prenom,
                    email: email,
                    telephone: telephone,
                    points: 50,
                    lastTicket: ticketNumber,
                    tier: 'Bronze',
                    welcomeCode: 'CE' + Math.floor(Math.random() * 900 + 100),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    qrCodeExpiry: null,
                    lastQRGeneration: null
                });
                
                // Enregistrer le ticket comme utilis√©
                await db.collection('usedTickets').doc(ticketNumber).set({
                    userId: user.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'inscription'
                });
                
                // Ajouter l'√©v√©nement d'inscription √† l'historique
                await db.collection('users').doc(user.uid).collection('history').add({
                    type: 'inscription',
                    points: 50,
                    description: 'Inscription au Club Avantage CE',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showAuthMessage('üéâ Compte cr√©√© avec succ√®s ! Bienvenue dans le Club Avantage CE !', 'success');
                
            } catch (error) {
                console.error('Erreur inscription:', error);
                let message = 'Erreur lors de l\'inscription.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Cette adresse email est d√©j√† utilis√©e.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Le mot de passe est trop faible.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Adresse email invalide.';
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Fonction de connexion
        async function handleSignin(e) {
            e.preventDefault();
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            
            try {
                showAuthMessage('Connexion en cours...', 'info');
                
                await auth.signInWithEmailAndPassword(email, password);
                
                // Mettre √† jour la derni√®re activit√©
                if (auth.currentUser) {
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showAuthMessage('Connexion r√©ussie !', 'success');
                
            } catch (error) {
                console.error('Erreur connexion:', error);
                let message = 'Erreur lors de la connexion.';
                
                if (error.code === 'auth/user-not-found') {
                    message = 'Aucun compte trouv√© avec cette adresse email.';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Mot de passe incorrect.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Adresse email invalide.';
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Charger les donn√©es utilisateur - Version avec gestion des permissions
        async function loadUserData(user) {
            if (!user) {
                console.error('‚ùå Aucun utilisateur fourni pour loadUserData');
                return;
            }
            
            console.log('üìä Chargement des donn√©es utilisateur pour:', user.email);
            
            // Nettoyer l'ancien √©couteur s'il existe
            if (userDataListener) {
                userDataListener();
                userDataListener = null;
            }
            
            try {
                // D'abord, essayer de lire le document une seule fois pour tester les permissions
                console.log('üîç Test de lecture du document utilisateur...');
                const docRef = db.collection('users').doc(user.uid);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) {
                    console.log('üìù Document utilisateur inexistant, cr√©ation en cours...');
                    
                    // Cr√©er le document utilisateur
                    const displayName = user.displayName || 'Membre CE';
                    const nameParts = displayName.split(' ');
                    
                    const newUserData = {
                        nom: nameParts[1] || 'CE',
                        prenom: nameParts[0] || 'Membre',
                        email: user.email,
                        telephone: '',
                        points: 50,
                        lastTicket: '',
                        tier: 'Bronze',
                        welcomeCode: 'CE' + Math.floor(Math.random() * 900 + 100),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await docRef.set(newUserData);
                    console.log('‚úÖ Document utilisateur cr√©√© avec succ√®s');
                    
                    // Mettre √† jour l'interface avec les nouvelles donn√©es
                    updateUserInterface({
                        ...newUserData,
                        createdAt: new Date() // Pour l'affichage imm√©diat
                    });
                    
                    // Ajouter l'√©v√©nement d'inscription √† l'historique
                    try {
                        await docRef.collection('history').add({
                            type: 'inscription',
                            points: 50,
                            description: 'Inscription au Club Avantage CE',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('‚úÖ Historique d\'inscription ajout√©');
                    } catch (historyError) {
                        console.error('‚ö†Ô∏è Erreur ajout historique:', historyError);
                        // Ne pas bloquer pour l'historique
                    }
                    
                } else {
                    console.log('‚úÖ Document utilisateur trouv√©');
                    const userData = docSnapshot.data();
                    updateUserInterface(userData);
                }
                
                // Maintenant configurer l'√©couteur en temps r√©el
                console.log('üëÇ Configuration de l\'√©couteur temps r√©el...');
                userDataListener = docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        console.log('üîÑ Mise √† jour temps r√©el re√ßue');
                        const userData = doc.data();
                        updateUserInterface(userData);
                    }
                }, (error) => {
                    console.error('‚ùå Erreur √©couteur temps r√©el:', error);
                    // Ne pas afficher d'erreur pour l'√©couteur, les donn√©es sont d√©j√† charg√©es
                });
                
                // Charger l'activit√© r√©cente
                loadRecentActivity();
                
                // V√©rifier l'√©tat du QR Code
                checkQRCodeStatus();
                
                showMessage('‚úÖ Donn√©es charg√©es avec succ√®s !', 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                
                let errorMessage = 'Erreur de chargement des donn√©es';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permissions insuffisantes. Veuillez vous reconnecter.';
                    console.log('üîÑ Tentative de reconnexion automatique...');
                    
                    // Essayer de se reconnecter
                    setTimeout(() => {
                        auth.signOut().then(() => {
                            showMessage('Reconnexion n√©cessaire, veuillez vous connecter √† nouveau.', 'info');
                        });
                    }, 2000);
                    
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Service temporairement indisponible. R√©essayez dans quelques instants.';
                } else {
                    errorMessage = `Erreur: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
                
                // Afficher des donn√©es par d√©faut pour ne pas laisser l'interface vide
                updateUserInterface({
                    nom: 'Membre',
                    prenom: 'CE',
                    email: user.email || 'email@example.com',
                    points: 0,
                    tier: 'Bronze',
                    createdAt: new Date()
                });
            }
        }

        // Mettre √† jour l'interface utilisateur
        function updateUserInterface(userData) {
            console.log('üé® Mise √† jour de l\'interface avec:', userData);
            
            // V√©rifier que les √©l√©ments existent avant de les modifier
            const memberName = document.getElementById('member-name');
            const memberEmail = document.getElementById('member-email');
            const memberTier = document.getElementById('member-tier');
            const memberSince = document.getElementById('member-since');
            const pointsBalance = document.getElementById('points-balance');
            
            if (memberName) {
                memberName.textContent = `${userData.prenom || 'Membre'} ${userData.nom || 'CE'}`;
                console.log('‚úÖ Nom mis √† jour:', memberName.textContent);
            }
            
            if (memberEmail) {
                memberEmail.textContent = userData.email || 'email@example.com';
                console.log('‚úÖ Email mis √† jour:', memberEmail.textContent);
            }
            
            if (memberTier) {
                memberTier.textContent = userData.tier || 'Bronze';
                console.log('‚úÖ Niveau mis √† jour:', memberTier.textContent);
            }
            
            // Date d'inscription avec gestion am√©lior√©e
            if (memberSince) {
                if (userData.createdAt && userData.createdAt.toDate) {
                    try {
                        const date = userData.createdAt.toDate();
                        const options = { year: 'numeric', month: 'short' };
                        memberSince.textContent = date.toLocaleDateString('fr-FR', options);
                        console.log('‚úÖ Date d\'inscription mise √† jour:', memberSince.textContent);
                    } catch (error) {
                        console.error('‚ùå Erreur conversion date:', error);
                        memberSince.textContent = new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' });
                    }
                } else {
                    // Fallback pour les nouveaux comptes ou dates manquantes
                    memberSince.textContent = new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' });
                    console.log('‚ö†Ô∏è Date fallback utilis√©e:', memberSince.textContent);
                }
            }
            
            // Points avec animation
            if (pointsBalance) {
                const currentPoints = parseInt(pointsBalance.textContent) || 0;
                const newPoints = userData.points || 0;
                console.log('üí∞ Animation points:', currentPoints, '->', newPoints);
                animateNumber('points-balance', currentPoints, newPoints, 1000);
            }
            
            // Progression du niveau
            updateLevelProgress(userData.points || 0);
            
            console.log('‚úÖ Interface utilisateur mise √† jour compl√®tement');
        }

        // Charger l'activit√© r√©cente avec gestion des permissions
        async function loadRecentActivity() {
            if (!currentUser) {
                console.log('‚ö†Ô∏è Aucun utilisateur connect√© pour charger l\'activit√©');
                return;
            }
            
            console.log('üìä Chargement de l\'activit√© r√©cente...');
            
            const activityContainer = document.getElementById('recent-activity');
            if (!activityContainer) {
                console.error('‚ùå Container d\'activit√© non trouv√©');
                return;
            }
            
            try {
                const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('history')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                activityContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    console.log('üìù Aucune activit√© trouv√©e, affichage du message par d√©faut');
                    activityContainer.innerHTML = `
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm font-medium">Bienvenue dans le Club !</span>
                            </div>
                            <span class="text-sm text-gray-600">+50 pts</span>
                        </div>
                    `;
                } else {
                    console.log('‚úÖ Activit√©s trouv√©es:', querySnapshot.size);
                    querySnapshot.forEach((doc) => {
                        const activity = doc.data();
                        const activityElement = createActivityElement(activity);
                        activityContainer.appendChild(activityElement);
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement activit√©:', error);
                
                // Afficher un message par d√©faut m√™me en cas d'erreur
                activityContainer.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm font-medium">Membre du Club Avantage CE</span>
                        </div>
                        <span class="text-sm text-gray-600">üéâ</span>
                    </div>
                `;
                
                // Ne pas afficher d'erreur √† l'utilisateur pour l'historique
                console.log('‚ÑπÔ∏è Historique non disponible, affichage du message par d√©faut');
            }
        }

        // Cr√©er un √©l√©ment d'activit√©
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
            
            const typeColors = {
                'inscription': 'bg-green-500',
                'achat': 'bg-blue-500',
                'bonus': 'bg-yellow-500',
                'reduction': 'bg-purple-500'
            };
            
            const color = typeColors[activity.type] || 'bg-gray-500';
            
            div.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 ${color} rounded-full"></div>
                    <span class="text-sm font-medium">${activity.description}</span>
                </div>
                <span class="text-sm text-gray-600">${activity.points > 0 ? '+' : ''}${activity.points} pts</span>
            `;
            
            return div;
        }

        // Valider le format du ticket
        function validateTicketFormat(ticket) {
            const pattern1 = /^S\d{5}$/; // S suivi de 5 chiffres
            const pattern2 = /^\d{5}-\d{3}-\d{4}$/; // 00000-003-0012
            return pattern1.test(ticket) || pattern2.test(ticket);
        }
        
        // V√©rifier si un ticket existe d√©j√†
        async function checkTicketExists(ticketNumber) {
            try {
                const doc = await db.collection('usedTickets').doc(ticketNumber).get();
                return doc.exists;
            } catch (error) {
                console.error('Erreur v√©rification ticket:', error);
                return false;
            }
        }
        
        // V√©rifier l'√©tat du QR Code
        async function checkQRCodeStatus() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                const ticketForm = document.getElementById('ticket-validation-form');
                const qrSection = document.getElementById('qr-code-section');
                
                if (userData.qrCodeExpiry && userData.qrCodeExpiry.toDate() > new Date()) {
                    // QR Code encore valide
                    ticketForm.classList.add('hidden');
                    qrSection.classList.remove('hidden');
                    
                    const expiryDate = userData.qrCodeExpiry.toDate();
                    document.getElementById('qr-expiry').textContent = expiryDate.toLocaleString('fr-FR');
                    
                    generateQRCode(currentUser.uid, userData.lastTicket);
                } else {
                    // QR Code expir√© ou inexistant
                    ticketForm.classList.remove('hidden');
                    qrSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur v√©rification QR Code:', error);
            }
        }
        
        // Valider le ticket et afficher le QR Code
        async function validateTicketAndShowQR() {
            const ticketNumber = document.getElementById('new-ticket-number').value.trim();
            
            if (!ticketNumber) {
                showMessage('Veuillez saisir un num√©ro de facture.', 'error');
                return;
            }
            
            if (!validateTicketFormat(ticketNumber)) {
                showMessage('Format invalide. Utilisez: S suivi de 5 chiffres (ex: S01032) ou format 00000-003-0012', 'error');
                return;
            }
            
            // V√©rifier si le ticket existe d√©j√†
            const ticketExists = await checkTicketExists(ticketNumber);
            if (ticketExists) {
                showMessage('Ce num√©ro de facture a d√©j√† √©t√© utilis√©.', 'error');
                return;
            }
            
            try {
                showMessage('Validation du ticket en cours...', 'info');
                
                // Calculer l'expiration (24h)
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 24);
                
                // Mettre √† jour l'utilisateur
                await db.collection('users').doc(currentUser.uid).update({
                    lastTicket: ticketNumber,
                    qrCodeExpiry: expiry,
                    lastQRGeneration: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Enregistrer le ticket comme utilis√©
                await db.collection('usedTickets').doc(ticketNumber).set({
                    userId: currentUser.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'reduction'
                });
                
                // Ajouter √† l'historique
                await db.collection('users').doc(currentUser.uid).collection('history').add({
                    type: 'reduction',
                    points: 0,
                    description: `R√©duction 5% - Ticket ${ticketNumber}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Afficher le QR Code
                const ticketForm = document.getElementById('ticket-validation-form');
                const qrSection = document.getElementById('qr-code-section');
                
                ticketForm.classList.add('hidden');
                qrSection.classList.remove('hidden');
                
                document.getElementById('qr-expiry').textContent = expiry.toLocaleString('fr-FR');
                
                generateQRCode(currentUser.uid, ticketNumber);
                
                showMessage('‚úÖ Ticket valid√© ! Votre QR Code est pr√™t.', 'success');
                
            } catch (error) {
                console.error('Erreur validation ticket:', error);
                showMessage('Erreur lors de la validation du ticket.', 'error');
            }
        }
        
        // G√©n√©rer le QR Code personnel - Version s√©curis√©e
        function generateQRCode(userId, ticketNumber) {
            if (!userId) {
                console.error('‚ùå Aucun userId fourni pour generateQRCode');
                return;
            }
            
            console.log('üî≤ G√©n√©ration du QR Code pour:', userId, 'ticket:', ticketNumber);
            
            const container = document.getElementById('qrcode-container');
            if (!container) {
                console.error('‚ùå Container QR Code non trouv√©');
                setTimeout(() => generateQRCode(userId, ticketNumber), 1000);
                return;
            }
            
            // V√©rifier que QRCode est disponible
            if (typeof QRCode === 'undefined') {
                console.error('‚ùå Librairie QRCode non charg√©e');
                showMessage('Erreur: QR Code non disponible', 'error');
                return;
            }
            
            const qrData = {
                userId: userId,
                ticketNumber: ticketNumber,
                type: 'club_reduction',
                timestamp: Date.now(),
                app: 'ClubAvantage-CE',
                discount: '5%'
            };
            
            const qrString = JSON.stringify(qrData);
            console.log('üìù Donn√©es QR Code:', qrString);
            
            // Nettoyer le container
            container.innerHTML = '';
            
            // G√©n√©rer le QR Code dans le container
            QRCode.toCanvas(qrString, {
                width: 200,
                height: 200,
                margin: 2,
                color: {
                    dark: '#22a8dc',
                    light: '#ffffff'
                },
                errorCorrectionLevel: 'M'
            }, (error, canvas) => {
                if (error) {
                    console.error('‚ùå Erreur g√©n√©ration QR Code:', error);
                    showMessage('Erreur g√©n√©ration QR Code: ' + error.message, 'error');
                    
                    // Fallback
                    container.innerHTML = `
                        <div class="w-48 h-48 bg-gray-200 rounded-lg flex items-center justify-center">
                            <div class="text-center text-gray-600">
                                <div class="text-2xl mb-2">üì±</div>
                                <div class="text-sm">QR Code</div>
                                <div class="text-xs">Indisponible</div>
                            </div>
                        </div>
                    `;
                } else {
                    console.log('‚úÖ QR Code g√©n√©r√© avec succ√®s !');
                    container.appendChild(canvas);
                }
            });
        }

        // Mettre √† jour la progression du niveau
        function updateLevelProgress(points) {
            let currentLevel, nextLevel, progress, pointsToNext;
            
            if (points < 50) {
                currentLevel = 'Bronze';
                nextLevel = 'Argent';
                progress = (points / 50) * 100;
                pointsToNext = 50 - points;
            } else if (points < 100) {
                currentLevel = 'Argent';
                nextLevel = 'Or';
                progress = ((points - 50) / 50) * 100;
                pointsToNext = 100 - points;
            } else {
                currentLevel = 'Or';
                nextLevel = 'VIP';
                progress = 100;
                pointsToNext = 0;
            }
            
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('next-level').textContent = nextLevel;
            document.getElementById('level-progress').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('points-to-next').textContent = 
                pointsToNext > 0 ? `${pointsToNext} points pour le niveau suivant` : 'Niveau maximum atteint !';
        }

        // Animation des nombres
        function animateNumber(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 16);
        }

        // Actualiser les donn√©es - Version optimis√©e
        function refreshData() {
            if (!currentUser) {
                console.error('‚ùå Aucun utilisateur connect√© pour actualiser');
                showMessage('Erreur: Aucun utilisateur connect√©', 'error');
                return;
            }
            
            console.log('üîÑ Actualisation des donn√©es utilisateur...');
            showMessage('üîÑ Actualisation des donn√©es...', 'info');
            
            // Recharger les donn√©es utilisateur
            loadUserData(currentUser);
            
            setTimeout(() => {
                showMessage('‚úÖ Donn√©es actualis√©es !', 'success');
                console.log('‚úÖ Actualisation termin√©e');
            }, 1500);
        }

        // Partager l'application
        function shareApp() {
            const shareText = `üéâ Rejoignez-moi dans le Club Avantage CE ! Points de fid√©lit√©, r√©ductions exclusives et bien plus. Inscrivez-vous : ${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Club Avantage CE',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('üìã Lien copi√© ! Partagez-le avec vos amis.', 'success');
                });
            }
        }

        // D√©connexion - Version optimis√©e
        function logout() {
            console.log('üö™ D√©connexion en cours...');
            
            // Afficher l'√©cran de chargement pendant la d√©connexion
            showLoadingScreen();
            
            auth.signOut().then(() => {
                console.log('‚úÖ D√©connexion r√©ussie');
                
                // Nettoyer les √©couteurs
                if (userDataListener) {
                    userDataListener();
                    userDataListener = null;
                }
                
                // R√©initialiser les variables
                currentUser = null;
                
                showMessage('üëã √Ä bient√¥t !', 'info');
                
            }).catch((error) => {
                console.error('‚ùå Erreur lors de la d√©connexion:', error);
                hideLoadingScreen();
                showMessage('Erreur lors de la d√©connexion', 'error');
            });
        }

        // Fonctions d'affichage/masquage des √©crans - Version optimis√©e
        function showLoadingScreen() {
            console.log('‚è≥ Affichage de l\'√©cran de chargement');
            if (loadingScreen) {
                loadingScreen.classList.remove('hidden');
                loadingScreen.style.display = 'flex';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
        }

        function hideLoadingScreen() {
            console.log('‚úÖ Masquage de l\'√©cran de chargement');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
        }

        function showAuthScreen() {
            console.log('üîê Affichage de l\'√©cran d\'authentification');
            if (authScreen) {
                authScreen.classList.remove('hidden');
                authScreen.style.display = 'block';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
        }

        function showCardScreen() {
            console.log('üí≥ Affichage de l\'√©cran de la carte membre');
            if (cardScreen) {
                cardScreen.classList.remove('hidden');
                cardScreen.style.display = 'block';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
        }

        // Afficher les messages d'authentification
        function showAuthMessage(message, type = 'info') {
            const messageDiv = document.getElementById('auth-message');
            let className = 'p-2 rounded-lg font-medium ';
            
            switch(type) {
                case 'success':
                    className += 'bg-green-100 text-green-700 border border-green-300';
                    break;
                case 'error':
                    className += 'bg-red-100 text-red-700 border border-red-300';
                    break;
                case 'info':
                    className += 'bg-blue-100 text-blue-700 border border-blue-300';
                    break;
                default:
                    className += 'bg-gray-100 text-gray-700 border border-gray-300';
            }
            
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 4000);
            }
        }

        // Afficher les messages g√©n√©raux
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Fonction de formatage du t√©l√©phone
        function formatPhoneNumber(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + ' ' + value.substring(2);
            }
            if (value.length >= 6) {
                value = value.substring(0, 6) + ' ' + value.substring(6);
            }
            if (value.length >= 9) {
                value = value.substring(0, 9) + ' ' + value.substring(9, 11);
            }
            
            e.target.value = value;
        }
        
        // Formatage en temps r√©el du ticket
        function formatTicketInput(e) {
            let value = e.target.value.toUpperCase();
            
            // Supprimer les caract√®res non autoris√©s
            value = value.replace(/[^S0-9-]/g, '');
            
            // Limiter la longueur selon le format
            if (value.startsWith('S')) {
                // Format S00000
                value = value.substring(0, 6);
            } else {
                // Format 00000-003-0000
                value = value.substring(0, 14);
            }
            
            e.target.value = value;
        }
        
        // Attacher le formatage aux champs ticket
        document.addEventListener('DOMContentLoaded', function() {
            const signupTicket = document.getElementById('signup-ticket');
            const newTicket = document.getElementById('new-ticket-number');
            
            if (signupTicket) {
                signupTicket.addEventListener('input', formatTicketInput);
            }
            if (newTicket) {
                newTicket.addEventListener('input', formatTicketInput);
            }
        });


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976829e05785785f',t:'MTc1NjQyOTc3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
