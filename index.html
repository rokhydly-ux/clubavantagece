<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Écran de chargement -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50">
        <img src="https://drive.google.com/uc?export=view&id=16BNfLhxK9tQKcMqOGpT_huLM9QzO129f" alt="Logo" class="h-20 mb-4 animate-pulse">
        <p class="text-gray-600">Chargement...</p>
    </div>

    <!-- Conteneur principal de l'application -->
    <div id="app" class="hidden min-h-screen bg-cover bg-center bg-fixed" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://www.groupesebi.com/wp-content/uploads/2020/04/cuisine-whole-sebi-paris-idf-normandie-1-uai-1600x685.jpg');">
        
        <!-- ÉCRAN DE CONNEXION / INSCRIPTION -->
        <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 text-center">
                <img src="https://drive.google.com/uc?export=view&id=16BNfLhxK9tQKcMqOGpT_huLM9QzO129f" alt="Logo" class="h-16 mx-auto mb-4">
                <h1 id="auth-title" class="text-2xl font-bold text-gray-800 mb-2">Rejoignez le Club !</h1>
                <p class="text-gray-500 mb-6">Inscrivez-vous pour obtenir vos avantages.</p>

                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="signup-nom" placeholder="Nom*" required class="w-full p-3 rounded-lg border">
                        <input type="text" id="signup-prenom" placeholder="Prénom*" required class="w-full p-3 rounded-lg border">
                    </div>
                    <input type="email" id="signup-email" placeholder="Email (pour vous connecter)" class="w-full p-3 rounded-lg border">
                    <input type="tel" id="signup-telephone" placeholder="Téléphone (pour vous connecter)" class="w-full p-3 rounded-lg border">
                    <input type="password" id="signup-password" placeholder="Mot de passe*" required class="w-full p-3 rounded-lg border">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">S'inscrire</button>
                </form>
                
                <p id="auth-message" class="text-sm text-red-500 mt-4 h-4"></p>
                <p class="text-sm text-gray-500 mt-4">Déjà membre ? <a href="#" id="show-login-link" class="font-semibold text-blue-600">Connectez-vous</a></p>
            </div>
        </div>

        <!-- ÉCRAN DE LA CARTE VIRTUELLE -->
        <div id="card-screen" class="hidden min-h-screen flex flex-col justify-between p-6">
            <div>
                <header class="flex justify-between items-center mb-8">
                    <h2 class="text-white text-xl font-bold">Bonjour, <span id="user-name"></span> !</h2>
                    <button id="logout-button" class="text-white text-sm opacity-80 hover:opacity-100">Déconnexion</button>
                </header>

                <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-center text-white">
                    <p class="font-semibold">Votre solde de points</p>
                    <p id="user-points" class="text-6xl font-black my-4">...</p>
                    <p class="opacity-80">Accumulez des points à chaque achat.</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 text-center mt-8">
                <p class="font-semibold text-gray-700 mb-4">Présentez ce QR Code en caisse</p>
                <div id="qrcode-container" class="bg-white p-2 rounded-xl inline-block shadow-inner"></div>
                <p class="text-xs text-gray-500 mt-4">Ce code vous identifie de manière unique.</p>
            </div>
        </div>
    </div>

    <!-- SCRIPTS FIREBASE - À PLACER AVANT VOTRE SCRIPT D'APPLICATION -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- COLLEZ VOTRE CONFIGURATION FIREBASE ICI ---
        const firebaseConfig = {
            apiKey: "VOTRE_API_KEY",
            authDomain: "VOTRE_AUTH_DOMAIN",
            projectId: "VOTRE_PROJECT_ID",
            storageBucket: "VOTRE_STORAGE_BUCKET",
            messagingSenderId: "VOTRE_MESSAGING_SENDER_ID",
            appId: "VOTRE_APP_ID"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ÉLÉMENTS DU DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app');
        const authScreen = document.getElementById('auth-screen');
        const cardScreen = document.getElementById('card-screen');
        const signupForm = document.getElementById('signup-form');
        const userNameDisplay = document.getElementById('user-name');
        const userPointsDisplay = document.getElementById('user-points');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const logoutButton = document.getElementById('logout-button');
        const authMessage = document.getElementById('auth-message');
        
        // Écouteur d'état d'authentification (le coeur de l'app)
        auth.onAuthStateChanged(user => {
            if (user) {
                // L'utilisateur est connecté
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        displayCardScreen(userData);
                    } else {
                        // Cas rare où l'utilisateur est authentifié mais n'a pas de profil
                        console.error("Aucun profil trouvé pour cet utilisateur");
                        auth.signOut();
                    }
                });
            } else {
                // L'utilisateur est déconnecté
                displayAuthScreen();
            }
            loadingScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
        });
        
        // Gestion de l'inscription
        signupForm.addEventListener('submit', e => {
            e.preventDefault();
            const nom = document.getElementById('signup-nom').value.trim();
            const prenom = document.getElementById('signup-prenom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const telephone = document.getElementById('signup-telephone').value.trim();
            const password = document.getElementById('signup-password').value;

            if (!email && !telephone) {
                authMessage.textContent = "Email ou téléphone requis.";
                return;
            }
            
            const loginIdentifier = email || telephone; // L'email est prioritaire pour la création de compte Firebase

            auth.createUserWithEmailAndPassword(loginIdentifier, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    // Créer un document dans Firestore pour stocker les infos supplémentaires
                    return db.collection('users').doc(user.uid).set({
                        nom: nom,
                        prenom: prenom,
                        email: email,
                        telephone: telephone,
                        points: 50, // Points de bienvenue
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log("Utilisateur inscrit et profil créé !");
                    // L'observateur onAuthStateChanged s'occupera d'afficher le bon écran
                })
                .catch(error => {
                    console.error(error);
                    authMessage.textContent = error.message;
                });
        });

        // Gestion de la déconnexion
        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });
        
        // --- Fonctions d'affichage ---
        function displayAuthScreen() {
            authScreen.classList.remove('hidden');
            cardScreen.classList.add('hidden');
        }

        function displayCardScreen(userData) {
            authScreen.classList.add('hidden');
            cardScreen.classList.remove('hidden');
            
            userNameDisplay.textContent = userData.prenom;
            userPointsDisplay.textContent = userData.points;
            generateQRCode(auth.currentUser.uid); // Le QR code contient l'ID utilisateur sécurisé
        }
        
        function generateQRCode(text) {
            qrcodeContainer.innerHTML = "";
            new QRCode(qrcodeContainer, {
                text: text,
                width: 180,
                height: 180
            });
        }
    </script>
</body>
</html>
