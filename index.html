<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
        /* ... Collez ici tous vos styles @keyframes ... */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="min-h-screen">
    <!-- ... Votre HTML pour loading-screen, header, auth-screen et card-screen reste EXACTEMENT le même ... -->
    <!-- ... Assurez-vous que le conteneur du QR Code est un DIV vide : <div id="qrcode-container"></div> ... -->

    <!-- ======================= SECTION SCRIPTS ======================= -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- UN SEUL ET UNIQUE SCRIPT POUR TOUTE L'APPLICATION -->
    <script>
        // --- 1. CONFIGURATION ET INITIALISATION DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be"
        };
        firebase.initializeApp(firebaseConfig);

        // --- 2. VARIABLES GLOBALES (maintenant que firebase est prêt) ---
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let userDataListener = null;

        // --- 3. POINT D'ENTRÉE PRINCIPAL (attend que le HTML soit prêt) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attacher les gestionnaires d'événements
            document.getElementById('signup-form')?.addEventListener('submit', handleSignup);
            document.getElementById('signin-form')?.addEventListener('submit', handleSignin);
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('signup-tab')?.addEventListener('click', () => switchTab('signup'));
            document.getElementById('signin-tab')?.addEventListener('click', () => switchTab('signin'));
            
            // Démarrer l'écouteur d'authentification
            auth.onAuthStateChanged(handleAuthStateChange);
        });

        // --- 4. LOGIQUE PRINCIPALE ---
        function handleAuthStateChange(user) {
            hideLoadingScreen();
            const logoutBtn = document.getElementById('logout-btn');

            if (user) {
                currentUser = user;
                showCardScreen();
                loadUserData(user); // Charger les données ET le QR Code
                if(logoutBtn) logoutBtn.style.display = 'flex';
            } else {
                if (userDataListener) userDataListener(); // Détache l'écouteur si l'utilisateur se déconnecte
                currentUser = null;
                showAuthScreen();
                if(logoutBtn) logoutBtn.style.display = 'none';
            }
        }

        // --- 5. GESTION DES FORMULAIRES ---
        async function handleSignup(e) {
            e.preventDefault();
            const prenom = document.getElementById('signup-prenom').value.trim();
            const nom = document.getElementById('signup-nom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const telephone = document.getElementById('signup-telephone').value.trim();
            const password = document.getElementById('signup-password').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Mettre à jour le profil d'authentification est crucial
                await user.updateProfile({ displayName: `${prenom} ${nom}` });

                await db.collection('users').doc(user.uid).set({
                    prenom, nom, email, telephone,
                    points: 50, // Points de bienvenue
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Erreur d'inscription:", error);
                // Gérer l'affichage des erreurs à l'utilisateur
            }
        }

        async function handleSignin(e) {
            e.preventDefault();
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Erreur de connexion:", error);
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        // --- 6. FONCTIONS UTILITAIRES ---
        function loadUserData(user) {
            if (!user) return;

            // Appeler la génération du QR Code immédiatement avec l'ID de l'utilisateur
            generateQRCode(user.uid);

            if (userDataListener) userDataListener(); // Détache l'ancien écouteur
            
            userDataListener = db.collection('users').doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    updateUserInterface(user, doc.data()); // Passer l'objet 'user' et les données
                } else {
                     console.log("Le document n'existe pas encore, il sera créé.");
                }
            });
        }
        
        function updateUserInterface(user, userData) {
            // CORRECTION : Utiliser le displayName du profil d'authentification comme source fiable
            const displayName = user.displayName || `${userData.prenom} ${userData.nom}`;
            document.getElementById('member-name').textContent = displayName;
            document.getElementById('member-email').textContent = user.email;
            
            // CORRECTION : Logique de la date d'inscription fiabilisée
            const memberSince = document.getElementById('member-since');
            if (userData.createdAt && userData.createdAt.toDate) {
                const date = userData.createdAt.toDate();
                memberSince.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            } else {
                 memberSince.textContent = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            }

            document.getElementById('points-balance').textContent = userData.points || 0;
            // ... Mettre à jour le reste de l'interface (niveaux, etc.)
        }

        function generateQRCode(userId) {
            const qrcodeContainer = document.getElementById('qrcode-container');
            if (!qrcodeContainer) {
                console.error("ERREUR: Le conteneur '#qrcode-container' est introuvable dans le HTML !");
                return;
            }
            qrcodeContainer.innerHTML = ''; // Vider avant de générer
            new QRCode(qrcodeContainer, {
                text: userId,
                width: 180,
                height: 180,
            });
            console.log("QR Code généré pour l'ID:", userId);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            document.getElementById('app-header')?.classList.remove('hidden');
            document.getElementById('app-content')?.classList.remove('hidden');
        }

        // ... Collez ici le reste de vos fonctions (showAuthScreen, showCardScreen, switchTab, etc.) ...
    </script>
</body>
</html>
