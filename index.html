<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-spinner { animation: spin 1s linear infinite; }
        /* ... Collez ici le reste de vos styles @keyframes ... */
    </style>
</head>
<body class="min-h-screen">

    <!-- √âcran de chargement -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner w-16 h-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Club Avantage CE</h2>
            <p class="text-blue-200">Chargement de votre espace membre...</p>
        </div>
    </div>

    <!-- Header (g√©r√© par JS) -->
    <header id="app-header" class="bg-white shadow-lg p-4 text-center hidden">
         <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="w-24 md:w-32"></div>
            <div class="text-center">
                <h2 class="text-lg font-bold text-black">Club Avantage CE</h2>
                <p class="text-xs text-gray-600">Votre fid√©lit√© r√©compens√©e</p>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm" style="display: none;">D√©connexion</button>
        </div>
    </header>

    <!-- Contenu Principal (g√©r√© par JS) -->
    <main id="app-content" class="hidden min-h-screen" style="background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://deegreez.fr/wp-content/uploads/2023/10/quel-budget-pour-une-cuisine-professionnelle-scaled.jpeg'); background-size: cover; background-position: center; background-attachment: fixed;">
        <!-- √âcran d'authentification -->
        <div id="auth-screen">
            <!-- ... Votre HTML pour la section #auth-screen ... -->
        </div>

        <!-- √âcran de la carte membre -->
        <div id="card-screen" class="hidden">
            <div class="min-h-screen p-6">
                <div class="max-w-md mx-auto space-y-6 pt-4">
                    <!-- ... Votre HTML pour la carte, les points ... -->

                    <!-- QR Code personnel -->
                    <div class="glass-effect rounded-2xl p-6">
                        <div class="text-center space-y-4">
                            <h3 class="text-xl font-bold" style="color: #22a8dc;">üì± Votre QR Code Personnel</h3>
                            <p class="text-sm text-gray-600">Pr√©sentez ce code en caisse pour identifier votre compte</p>
                            
                            <!-- CORRECTION : Le conteneur du QR Code doit √™tre un DIV simple pour que la librairie fonctionne -->
                            <div class="qr-container rounded-xl p-4 mx-auto w-fit">
                                <div id="qrcode-container" class="mx-auto"></div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <p class="text-xs text-blue-800 font-medium">
                                    üîí Ce QR code est unique et s√©curis√©.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- ... Votre HTML pour les actions et l'historique ... -->
                </div>
            </div>
        </div>
    </main>

    <!-- ======================= SECTION SCRIPTS ======================= -->
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- A. CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be",
            measurementId: "G-Y0187YGWCT"
        };
        firebase.initializeApp(firebaseConfig);

        // --- B. VARIABLES GLOBALES ---
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let userDataListener = null;

        // --- C. INITIALISATION DE L'APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attacher les gestionnaires d'√©v√©nements une fois que le DOM est pr√™t
            document.getElementById('signup-form')?.addEventListener('submit', handleSignup);
            document.getElementById('signin-form')?.addEventListener('submit', handleSignin);
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('signup-tab')?.addEventListener('click', () => switchTab('signup'));
            document.getElementById('signin-tab')?.addEventListener('click', () => switchTab('signin'));

            // D√©marrer l'√©couteur d'authentification
            auth.onAuthStateChanged(handleAuthStateChange);
        });

        // --- D. LOGIQUE PRINCIPALE ---
        function handleAuthStateChange(user) {
            hideLoadingScreen();
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                currentUser = user;
                showCardScreen();
                loadUserData(user); // Passer l'objet 'user'
                if (logoutBtn) logoutBtn.style.display = 'block';
            } else {
                currentUser = null;
                showAuthScreen();
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            const prenom = document.getElementById('signup-prenom').value.trim();
            const nom = document.getElementById('signup-nom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const telephone = document.getElementById('signup-telephone').value.trim();
            const ticketNumber = document.getElementById('signup-ticket').value.trim();
            const password = document.getElementById('signup-password').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // CORRECTION : Mettre √† jour le displayName est une bonne pratique
                await user.updateProfile({ displayName: `${prenom} ${nom}` });
                
                await db.collection('users').doc(user.uid).set({
                    prenom, nom, email, telephone,
                    points: 50, lastTicket: ticketNumber,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Erreur inscription:', error);
            }
        }

        async function handleSignin(e) {
            e.preventDefault();
            // ... Votre logique de connexion ...
        }

        function handleLogout() {
            if (userDataListener) userDataListener();
            auth.signOut();
        }

        // --- E. FONCTIONS UTILITAIRES ---
        function loadUserData(user) {
            if (!user) return;
            // CORRECTION : Appeler generateQRCode ici est plus fiable
            generateQRCode(user.uid);

            if (userDataListener) userDataListener();
            userDataListener = db.collection('users').doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    updateUserInterface(doc.data());
                } else {
                    console.log("Le profil de l'utilisateur est en cours de cr√©ation...");
                }
            });
        }
        
        function updateUserInterface(userData) {
            // CORRECTION : Gestion plus robuste des √©l√©ments
            const memberName = document.getElementById('member-name');
            const memberEmail = document.getElementById('member-email');
            const memberSince = document.getElementById('member-since');
            
            if (memberName) memberName.textContent = `${userData.prenom} ${userData.nom}`;
            if (memberEmail) memberEmail.textContent = userData.email;

            // CORRECTION : Logique de la date d'inscription fiabilis√©e
            if (memberSince) {
                if (userData.createdAt && userData.createdAt.toDate) {
                    const date = userData.createdAt.toDate();
                    memberSince.textContent = date.toLocaleDateString('fr-FR');
                } else {
                    memberSince.textContent = new Date().toLocaleDateString('fr-FR');
                }
            }
            // ... reste de votre logique d'update (points, etc.)
        }
        
        function generateQRCode(userId) {
            const qrcodeContainer = document.getElementById('qrcode-container');
            if (!qrcodeContainer) return;
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, { text: userId, width: 180, height: 180 });
        }
        
        function hideLoadingScreen() {
            // ... votre fonction hideLoadingScreen ...
        }
        
        function showAuthScreen() {
             // ... votre fonction showAuthScreen ...
        }

        function showCardScreen() {
             // ... votre fonction showCardScreen ...
        }
        
        // ... Collez ici le reste de vos fonctions (switchTab, etc.) ...
    </script>
</body>
</html>
