<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
        /* ... Collez ici tous vos styles @keyframes ... */
    </style>
</head>
<body class="min-h-screen">

    <!-- ... Votre HTML pour loading-screen et header ... -->

    <main id="app-content" class="hidden min-h-screen" style="...">
        <!-- √âcran d'authentification -->
        <div id="auth-screen">
            <!-- ... Votre HTML pour la section #auth-screen ... -->
        </div>

        <!-- √âCRAN DE LA CARTE MEMBRE (AVEC LES CORRECTIONS) -->
        <div id="card-screen" class="hidden">
            <div class="min-h-screen p-6">
                <div class="max-w-md mx-auto space-y-6 pt-4">
                    <!-- Carte de membre virtuelle -->
                    <div class="glass-effect rounded-2xl p-6 card-shine">
                        <div class="text-center space-y-4">
                             <h2 class="text-2xl font-bold" style="color: #22a8dc;">Carte Membre VIP</h2>
                             <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-white">
                                <!-- CORRECTION : Les IDs sont maintenant pr√©cis -->
                                <h3 class="text-lg font-bold" id="card-member-name">Chargement...</h3>
                                <p class="text-sm opacity-90" id="card-member-email"></p>
                                <div class="mt-3 flex justify-between items-center">
                                    <div><p class="text-xs opacity-75">Niveau</p><p class="font-bold" id="card-member-tier"></p></div>
                                    <div class="text-right"><p class="text-xs opacity-75">Membre depuis</p><p class="font-bold text-sm" id="card-member-since"></p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Solde de points -->
                    <div class="glass-effect rounded-2xl p-6">
                        <!-- ... Votre HTML pour les points ... -->
                    </div>
                    <!-- QR Code personnel -->
                    <div class="glass-effect rounded-2xl p-6">
                        <div class="text-center space-y-4">
                            <h3 class="text-xl font-bold" style="color: #22a8dc;">üì± Votre QR Code Personnel</h3>
                            <div class="qr-container rounded-xl p-4 mx-auto w-fit">
                                <!-- CORRECTION : Conteneur DIV pour le QR Code -->
                                <div id="qrcode-container" class="mx-auto"></div>
                            </div>
                        </div>
                    </div>
                    <!-- ... Votre HTML pour les actions et l'historique ... -->
                </div>
            </div>
        </div>
    </main>

    <!-- ======================= SECTION SCRIPTS ======================= -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- A. CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be"
        };
        firebase.initializeApp(firebaseConfig);

        // --- B. VARIABLES GLOBALES ---
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let userDataListener = null;

        // --- C. POINT D'ENTR√âE ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (attachement des √©v√©nements - reste inchang√©) ...
            auth.onAuthStateChanged(handleAuthStateChange);
        });

        // --- D. LOGIQUE PRINCIPALE ---
        function handleAuthStateChange(user) {
            hideLoadingScreen();
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                currentUser = user;
                showCardScreen();
                loadUserData(user);
                if (logoutBtn) logoutBtn.style.display = 'flex';
            } else {
                if (userDataListener) userDataListener();
                currentUser = null;
                showAuthScreen();
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }
        
        // --- E. GESTION DES FORMULAIRES ---
        async function handleSignup(e) {
            e.preventDefault();
            // ... (votre logique d'inscription compl√®te avec la transaction pour le memberId) ...
        }
        async function handleSignin(e) { /* ... */ }
        function handleLogout() { auth.signOut(); }

        // --- F. FONCTIONS UTILITAIRES (AVEC LES CORRECTIONS) ---
        function loadUserData(user) {
            if (!user) return;
            // On g√©n√®re le QR Code imm√©diatement
            generateQRCode(user.uid); 
            
            if (userDataListener) userDataListener();
            userDataListener = db.collection('users').doc(user.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    updateUserInterface(user, doc.data());
                }
            }, (error) => {
                console.error("Erreur Firestore onSnapshot:", error);
            });
        }
        
        // CORRECTION : La fonction updateUserInterface est maintenant plus pr√©cise
        function updateUserInterface(user, userData) {
            // 1. Mise √† jour du Nom et de l'ID Membre
            const memberNameEl = document.getElementById('card-member-name');
            if (memberNameEl) {
                const displayName = user.displayName || `${userData.prenom} ${userData.nom}`;
                const memberId = userData.memberId || ''; // R√©cup√®re le CE-XXXX
                memberNameEl.textContent = `${displayName} (${memberId})`;
            }

            // 2. Mise √† jour de l'Email
            const memberEmailEl = document.getElementById('card-member-email');
            if (memberEmailEl) memberEmailEl.textContent = user.email;

            // 3. Mise √† jour de la Date d'Inscription
            const memberSinceEl = document.getElementById('card-member-since');
            if (memberSinceEl && userData.createdAt && userData.createdAt.toDate) {
                const date = userData.createdAt.toDate();
                memberSinceEl.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            }

            // 4. Mise √† jour des autres champs (points, niveau, etc.)
            document.getElementById('points-balance').textContent = userData.points || 0;
            document.getElementById('card-member-tier').textContent = userData.tier || 'Bronze';
            // ... Mettre √† jour le reste ...
        }

        // CORRECTION : La fonction generateQRCode cible maintenant le bon conteneur
        function generateQRCode(userId) {
            const qrcodeContainer = document.getElementById('qrcode-container');
            if (!qrcodeContainer) {
                console.error("ERREUR CRITIQUE: Le conteneur '#qrcode-container' est introuvable. V√©rifiez votre HTML.");
                return;
            }
            qrcodeContainer.innerHTML = ''; // Vider avant de g√©n√©rer
            new QRCode(qrcodeContainer, {
                text: userId,
                width: 180,
                height: 180,
            });
            console.log("QR Code g√©n√©r√© pour l'ID:", userId);
        }
        
        // ... (le reste de vos fonctions : hideLoadingScreen, showAuthScreen, switchTab, etc.) ...
    </script>
</body>
</html>
