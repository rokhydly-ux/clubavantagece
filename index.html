<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    

    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
                url("https://deegreez.fr/wp-content/uploads/2023/10/quel-budget-pour-une-cuisine-professionnelle-scaled.jpeg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(34, 168, 220, 0.3); }
            to { box-shadow: 0 0 40px rgba(34, 168, 220, 0.6), 0 0 60px rgba(253, 216, 53, 0.3); }
        }
        
        .card-shine {
            position: relative;
            overflow: hidden;
        }
        
        .card-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .points-counter {
            animation: pointsGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pointsGlow {
            from { text-shadow: 0 0 10px #fdd835; }
            to { text-shadow: 0 0 20px #fdd835, 0 0 30px #fbc02d; }
        }
        
        .qr-container {
            background: linear-gradient(45deg, #ffffff, #f8f9fa);
            border: 3px solid #22a8dc;
            animation: qrPulse 3s ease-in-out infinite;
        }
        
        @keyframes qrPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(100%); 
                opacity: 0;
            }
            to { 
                transform: translateY(0); 
                opacity: 1;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- √âcran de chargement -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner w-16 h-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Club Avantage CE</h2>
            <p class="text-blue-200">Chargement de votre espace membre...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg p-4 text-center">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="w-10"></div>
            <div class="flex items-center space-x-3">
                <img src="https://jokkootech.com/wp-content/uploads/elementor/thumbs/CENTRAL_EQUIPEMENT-1-removebg-preview-qmtu95vg6ca8in6ds4b6xx9yzi550nl7zpyzehgycc.webp" 
                     alt="Central Equipements" 
                     class="h-10 w-auto object-contain"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 class="text-xl font-bold text-black hidden cursor-pointer hover:opacity-80 transition-opacity" 
                    style="color: #22a8dc;">CENTRAL EQUIPEMENTS</h1>
                <div class="text-center">
                    <h2 class="text-lg font-bold text-black">Club Avantage CE</h2>
                    <p class="text-xs text-gray-600">Votre fid√©lit√© r√©compens√©e</p>
                </div>
            </div>
            <button id="logout-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2 text-sm font-semibold" style="display: none;">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                </svg>
                <span>D√©connexion</span>
            </button>
        </div>
    </header>

    <!-- √âCRAN D'AUTHENTIFICATION -->
    <div id="auth-screen" class="min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-8">
            <!-- Titre d'accueil -->
            <div class="text-center space-y-4 fade-in">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-3xl font-black text-white">Rejoignez le Club Avantage CE !</h2>
                <p class="text-xl text-white/90 font-semibold">
                    Inscrivez-vous maintenant et recevez votre cadeau de bienvenue : <span class="text-yellow-300 font-black">-5% sur votre achat d'aujourd'hui !</span>
                </p>
            </div>

            <!-- B√©n√©fices -->
            <div class="glass-effect rounded-2xl p-6 pulse-glow">
                <h3 class="text-xl font-bold text-center mb-4" style="color: #22a8dc;">üéØ Vos Avantages Exclusifs</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3 p-2 bg-green-50 rounded-lg">
                        <div class="bg-green-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Un bonus de -5% imm√©diat</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Cumulez des points √† chaque visite</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-purple-50 rounded-lg">
                        <div class="bg-purple-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Acc√©dez √† des r√©compenses exclusives</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-yellow-50 rounded-lg">
                        <div class="bg-yellow-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Obtenez votre carte de fid√©lit√© virtuelle</span>
                    </div>
                </div>
            </div>

            <!-- Onglets Inscription/Connexion -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button id="signup-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-blue-500 text-white" onclick="switchTab('signup')">
                        Inscription
                    </button>
                    <button id="signin-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-600 hover:text-gray-800" onclick="switchTab('signin')">
                        Connexion
                    </button>
                </div>

                <!-- Formulaire d'inscription -->
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="signup-prenom" placeholder="Pr√©nom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                        <input type="text" id="signup-nom" placeholder="Nom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    </div>
                    <input type="email" id="signup-email" placeholder="Email (pour vous connecter)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <div class="relative">
                        <select id="country-code" class="absolute left-3 top-3 bg-transparent border-none text-sm font-medium text-gray-700 focus:outline-none z-10">
                            <option value="+221">üá∏üá≥ +221</option>
                            <option value="+33">üá´üá∑ +33</option>
                            <option value="+1">üá∫üá∏ +1</option>
                        </select>
                        <input type="text" id="signup-telephone" placeholder="77 123 45 67" required 
                               inputmode="tel"
                               class="w-full px-20 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    </div>
                    <input type="text" id="signup-ticket" placeholder="N¬∞ de facture (ex: S01032 ou 00000-003-0012)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                           pattern="^(S\d{5}|\d{5}-\d{3}-\d{4})$"
                           title="Format requis: S suivi de 5 chiffres (ex: S01032) ou format 00000-003-0012">
                    <input type="password" id="signup-password" placeholder="Mot de passe (min. 6 caract√®res)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <!-- Code de parrainage optionnel -->
                    <input type="text" id="signup-referral" placeholder="Code de parrainage (optionnel)" 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                           maxlength="10">
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="signup-terms" required class="rounded border-gray-300 text-blue-600">
                        <label for="signup-terms" class="text-xs text-gray-700">
                            J'accepte les conditions et de recevoir les offres exclusives
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="stay-connected" class="rounded border-gray-300 text-blue-600">
                        <label for="stay-connected" class="text-xs text-gray-700">
                            Rester connect√© sur cet appareil
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 card-shine">
                        üéÅ Je m'inscris et je re√ßois mon bonus !
                    </button>
                </form>

                <!-- Formulaire de connexion -->
                <form id="signin-form" class="space-y-4 hidden">
                    <input type="email" id="signin-email" placeholder="Email" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <input type="password" id="signin-password" placeholder="Mot de passe" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="signin-stay-connected" class="rounded border-gray-300 text-blue-600">
                        <label for="signin-stay-connected" class="text-xs text-gray-700">
                            Rester connect√© sur cet appareil
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                        üîë Me connecter √† mon compte
                    </button>
                </form>
                
                <div id="auth-message" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- √âCRAN DE CONFIRMATION D'INSCRIPTION -->
    <div id="confirmation-screen" class="hidden min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-8">
            <!-- Animation de succ√®s -->
            <div class="text-center space-y-4 fade-in">
                <div class="text-8xl mb-4">üéâ</div>
                <h2 class="text-3xl font-black text-white">F√©licitations !</h2>
                <p class="text-xl text-white/90 font-semibold">
                    Votre inscription au Club Avantage CE est confirm√©e !
                </p>
            </div>

            <!-- Carte d'ID membre -->
            <div class="glass-effect rounded-2xl p-6 card-shine">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">üèÜ Votre Carte Membre Officielle</h3>
                    
                    <!-- Num√©ro de membre -->
                    <div class="bg-blue-600 rounded-2xl p-6 text-white mb-6">
                        <p class="text-lg font-semibold mb-2">Votre Num√©ro de Membre Officiel :</p>
                        <div class="text-4xl font-black tracking-widest" id="confirmation-member-id">CE-0000</div>
                        <p class="text-sm mt-2 opacity-90">Conservez-le pr√©cieusement et pr√©sentez-le en magasin.</p>
                    </div>

                    <!-- Informations membre -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
                        <h4 class="font-bold text-lg" id="confirmation-name">Membre CE</h4>
                        <p class="text-sm opacity-90">Niveau Bronze ‚Ä¢ 50 points de bienvenue</p>
                    </div>
                </div>
            </div>

            <!-- Avantages imm√©diats -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4" style="color: #22a8dc;">üéÅ Vos Avantages Imm√©diats</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                        <div class="bg-green-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">50 points de bienvenue</p>
                            <p class="text-sm text-gray-600">D√©j√† cr√©dit√©s sur votre compte</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">R√©duction de 5% disponible</p>
                            <p class="text-sm text-gray-600">Utilisable d√®s maintenant en magasin</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 bg-purple-50 rounded-lg">
                        <div class="bg-purple-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">Carte de fid√©lit√© virtuelle</p>
                            <p class="text-sm text-gray-600">Accessible depuis votre espace membre</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4" style="color: #22a8dc;">üìã Prochaines √âtapes</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">1</div>
                        <p class="text-gray-700">Notez votre num√©ro de membre <strong id="confirmation-member-id-copy">CE-0000</strong> dans un endroit s√ªr</p>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">2</div>
                        <p class="text-gray-700">Acc√©dez √† votre espace membre pour g√©n√©rer votre QR Code de r√©duction</p>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">3</div>
                        <p class="text-gray-700">Pr√©sentez votre QR Code en caisse pour b√©n√©ficier de vos avantages</p>
                    </div>
                </div>
            </div>

            <!-- Bouton d'acc√®s √† l'espace membre -->
            <button onclick="goToMemberArea()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 card-shine">
                üöÄ Acc√©der √† mon Espace Membre
            </button>
        </div>
    </div>

    <!-- √âCRAN DE LA CARTE MEMBRE -->
    <div id="card-screen" class="hidden min-h-screen p-6">
        
    <!-- PAGE CARTE COMPL√àTE -->
    <div id="full-card-page" class="hidden fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 z-50">
        <div class="min-h-screen p-6">
            <!-- Header avec bouton retour -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="hideCardPage()" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H19V7z"/>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-white">Ma Carte Membre</h1>
                <div class="w-12"></div>
            </div>

            <div class="max-w-md mx-auto space-y-6">
                <!-- Carte membre grande -->
                <div class="relative rounded-3xl p-8 shadow-2xl overflow-hidden" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.5)), url('https://cdn.pixabay.com/photo/2020/06/10/13/30/food-5282718_1280.jpg'); background-size: cover; background-position: center;">
                    <div class="text-center space-y-6 relative z-10">
                        <!-- Logo et titre -->
                        <div class="flex items-center justify-center space-x-3 mb-6">
                            <svg class="w-10 h-10 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Club Avantage CE</h2>
                        </div>
                        
                        <!-- Informations membre -->
                        <div class="space-y-3">
                            <h3 class="text-2xl font-bold text-white" id="card-member-name">Membre CE</h3>
                            <p class="text-lg text-yellow-300 font-semibold" id="card-member-id">CE-0000</p>
                            <div class="flex justify-between items-center bg-white/20 backdrop-blur-sm rounded-xl p-4">
                                <div>
                                    <p class="text-sm text-white/80">Niveau</p>
                                    <p class="font-bold text-yellow-300" id="card-member-tier">Bronze</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-white/80">Points</p>
                                    <p class="font-bold text-yellow-300 text-xl" id="card-member-points">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Code grand -->
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <div class="text-center space-y-6">
                        <h3 class="text-2xl font-bold text-gray-800">Votre QR Code</h3>
                        <p class="text-gray-600">Pr√©sentez ce code en caisse</p>
                        
                        <div id="large-qrcode-container" class="flex justify-center">
                            <div class="bg-gray-100 rounded-2xl p-4">
                                <div class="text-center p-8">
                                    <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                                    <p class="text-gray-600">G√©n√©ration du QR Code...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-sm text-blue-800 font-medium">
                                üîí Ce code est unique et personnel. Ne le partagez pas.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3">
                    <button onclick="refreshQRCode()" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-6 rounded-xl transition-all">
                        üîÑ Actualiser le QR Code
                    </button>
                    
                    <button onclick="shareCard()" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-6 rounded-xl transition-all">
                        üì§ Partager ma carte
                    </button>
                </div>
            </div>
        </div>
    </div>
        <div class="max-w-md mx-auto space-y-6 pt-4">
            <!-- Carte de membre virtuelle -->
            <div class="glass-effect rounded-2xl p-6 card-shine">
                <div class="text-center space-y-4">
                    <div class="flex items-center justify-center space-x-2 mb-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <h2 class="text-2xl font-bold" style="color: #22a8dc;">Carte Membre VIP</h2>
                        <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                        </svg>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-white">
                        <h3 class="text-lg font-bold" id="member-name">Membre CE</h3>
                        <p class="text-sm opacity-90" id="member-email">email@example.com</p>
                        <p class="text-xs opacity-75 mt-1">N¬∞ Membre: <span class="font-bold" id="member-id-display">CE-0000</span></p>
                        <div class="mt-3 flex justify-between items-center">
                            <div>
                                <p class="text-xs opacity-75">Niveau</p>
                                <p class="font-bold" id="member-tier">Bronze</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs opacity-75">Membre depuis</p>
                                <p class="font-bold text-sm" id="member-since">2024</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Texte explicatif avec animation -->
            <div class="glass-effect rounded-2xl p-4 mb-4">
                <div class="text-center space-y-2">
                    <p class="text-sm text-gray-700">
                        üí≥ Votre carte de fid√©lit√© virtuelle avec QR Code
                    </p>
                    <p class="text-xs text-blue-600 font-semibold animate-pulse">
                        ‚ú® Pr√©sentez-la en caisse pour vos avantages ‚ú®
                    </p>
                </div>
            </div>

            <!-- Bouton Ma Carte -->
            <div class="glass-effect rounded-2xl p-4">
                <button onclick="showCardPage()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center space-x-3">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                    </svg>
                    <span class="text-xl">üì± Ma Carte Membre</span>
                </button>
            </div>

            <!-- Solde de points -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">üí∞ Vos Points</h3>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-6 text-white">
                        <div class="text-4xl font-black points-counter" id="points-balance">0</div>
                        <p class="text-sm opacity-90 mt-1">Points disponibles</p>
                    </div>
                    
                    <!-- Barre de progression niveau -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm font-semibold text-gray-600">
                            <span>Niveau: <span id="current-level">Bronze</span></span>
                            <span>Prochain: <span id="next-level">Argent</span></span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-yellow-500 h-full rounded-full transition-all duration-1000" 
                                 id="level-progress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-600 text-center" id="points-to-next">50 points pour le niveau suivant</p>
                    </div>
                </div>
            </div>



            <!-- Section Parrainage -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">üéÅ Parrainez vos amis</h3>
                    <p class="text-sm text-gray-600">Invitez un ami et gagnez 50 points chacun !</p>
                    
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-4 text-white">
                        <p class="text-sm font-medium mb-2">Votre code de parrainage :</p>
                        <div class="text-2xl font-black tracking-widest" id="referral-code-display">LOADING...</div>
                    </div>
                    
                    <button onclick="shareReferralCode()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 px-6 rounded-xl hover:from-green-600 hover:to-green-700 transition-all">
                        üì§ Partager mon code
                    </button>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="space-y-3">
                <button onclick="refreshData()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all">
                    üîÑ Actualiser mes donn√©es
                </button>
                
                <button onclick="shareApp()" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all">
                    üë• Partager l'application
                </button>
            </div>

            <!-- Historique r√©cent -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4" style="color: #22a8dc;">üìä Activit√© R√©cente</h3>
                <div id="recent-activity" class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium">Inscription</span>
                        </div>
                        <span class="text-sm text-gray-600">+50 pts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be",
            measurementId: "G-Y0187YGWCT"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentUser = null;
        let userDataListener = null;

        // Point d'entr√©e unique - Attendre que le DOM soit charg√©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM charg√©, initialisation de l\'application...');
            
            try {
                // Afficher l'√©cran de chargement
                showLoadingScreen();
                
                // Attacher les √©v√©nements
                attachEventListeners();
                
                // D√©marrer l'√©couteur d'authentification Firebase
                console.log('üî• D√©marrage de l\'√©couteur Firebase...');
                startAuthListener();
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                hideLoadingScreen();
                showMessage('Erreur de chargement. Veuillez actualiser la page.', 'error');
            }
        });

        // Fonction pour attacher tous les √©v√©nements
        function attachEventListeners() {
            console.log('üîó Attachement des √©v√©nements...');
            
            // Formulaires
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('‚úÖ √âv√©nement inscription attach√©');
            }
            
            if (signinForm) {
                signinForm.addEventListener('submit', handleSignin);
                console.log('‚úÖ √âv√©nement connexion attach√©');
            }
            
            // Bouton de d√©connexion
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
                console.log('‚úÖ √âv√©nement d√©connexion attach√©');
            }
            
            // Formatage du t√©l√©phone
            const phoneInput = document.getElementById('signup-telephone');
            const countrySelect = document.getElementById('country-code');
            if (phoneInput) {
                phoneInput.addEventListener('input', formatPhoneNumber);
                console.log('‚úÖ Formatage t√©l√©phone attach√©');
            }
            if (countrySelect) {
                countrySelect.addEventListener('change', updatePhonePlaceholder);
                console.log('‚úÖ S√©lecteur pays attach√©');
            }
            
            // Formatage des tickets
            const signupTicket = document.getElementById('signup-ticket');
            const newTicket = document.getElementById('new-ticket-number');
            
            if (signupTicket) {
                signupTicket.addEventListener('input', formatTicketInput);
            }
            if (newTicket) {
                newTicket.addEventListener('input', formatTicketInput);
            }
        }

        // √âcouteur d'√©tat d'authentification - Optimis√©
        function startAuthListener() {
            auth.onAuthStateChanged((user) => {
                console.log('üîê Changement d\'√©tat d\'authentification:', user ? 'Utilisateur connect√©' : 'Utilisateur d√©connect√©');
                
                // Masquer l'√©cran de chargement dans tous les cas
                hideLoadingScreen();
                
                if (user) {
                    console.log('üë§ Utilisateur connect√©:', user.email);
                    currentUser = user;
                    
                    // S√©quence d'affichage pour utilisateur connect√©
                    showCardScreen();
                    showLogoutButton();
                    loadUserData(user);
                    
                } else {
                    console.log('üëã Aucun utilisateur connect√©');
                    currentUser = null;
                    
                    // Nettoyer les donn√©es utilisateur
                    if (userDataListener) {
                        userDataListener();
                        userDataListener = null;
                    }
                    
                    // S√©quence d'affichage pour utilisateur d√©connect√©
                    showAuthScreen();
                    hideLogoutButton();
                }
            });
        }

        // Fonctions d'affichage/masquage du bouton de d√©connexion
        function showLogoutButton() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
                console.log('‚úÖ Bouton de d√©connexion affich√©');
            }
        }

        function hideLogoutButton() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
                console.log('‚úÖ Bouton de d√©connexion masqu√©');
            }
        }

        // Gestion des onglets
        function switchTab(tab) {
            const signupTab = document.getElementById('signup-tab');
            const signinTab = document.getElementById('signin-tab');
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            
            if (tab === 'signup') {
                signupTab.classList.add('bg-blue-500', 'text-white');
                signupTab.classList.remove('text-gray-600');
                signinTab.classList.remove('bg-blue-500', 'text-white');
                signinTab.classList.add('text-gray-600');
                signupForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
            } else {
                signinTab.classList.add('bg-blue-500', 'text-white');
                signinTab.classList.remove('text-gray-600');
                signupTab.classList.remove('bg-blue-500', 'text-white');
                signupTab.classList.add('text-gray-600');
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            }
        }

        // Fonction d'inscription avec ID membre s√©quentiel corrig√©
        async function handleSignup(e) {
            e.preventDefault();
            
            const prenom = document.getElementById('signup-prenom').value.trim();
            const nom = document.getElementById('signup-nom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('signup-telephone').value.trim().replace(/\s/g, '');
            const telephone = countryCode + phoneNumber;
            const ticketNumber = document.getElementById('signup-ticket').value.trim();
            const referralCode = document.getElementById('signup-referral').value.trim().toUpperCase();
            const password = document.getElementById('signup-password').value;
            const terms = document.getElementById('signup-terms').checked;
            const stayConnected = document.getElementById('stay-connected').checked;
            
            if (!terms) {
                showAuthMessage('Veuillez accepter les conditions.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Le mot de passe doit contenir au moins 6 caract√®res.', 'error');
                return;
            }
            
            // Validation du t√©l√©phone
            const telephoneSansEspaces = phoneNumber.replace(/\s/g, ''); 
            if (countryCode === '+221') {
                const senegalPhoneFormat = /^(70|75|76|77|78)\d{7}$/;
                if (!senegalPhoneFormat.test(telephoneSansEspaces)) {
                    showAuthMessage('Format du t√©l√©phone invalide. Ex: 77 123 45 67', 'error');
                    return;
                }
            } else if (countryCode === '+33') {
                const frenchPhoneFormat = /^0[1-9]\d{8}$/;
                if (!frenchPhoneFormat.test(telephoneSansEspaces)) {
                    showAuthMessage('Format t√©l√©phone fran√ßais invalide. Doit commencer par 0 et avoir 10 chiffres (ex: 01 23 45 67 89)', 'error');
                    return;
                }
            } else {
                if (!/^\d{7,15}$/.test(telephoneSansEspaces)) {
                    showAuthMessage('Format t√©l√©phone invalide. Entre 7 et 15 chiffres requis.', 'error');
                    return;
                }
            }
            
            // Validation du ticket
            const formatS = /^S\d{5}$/i;
            const formatLong = /^\d{5}-\d{3}-\d{4}$/;
            if (!formatS.test(ticketNumber) && !formatLong.test(ticketNumber)) {
                showAuthMessage('Format du N¬∞ de facture invalide. Ex: S01234 ou 00000-003-0012', 'error');
                return;
            }
            
            // V√©rifier si le ticket existe d√©j√†
            const ticketExists = await checkTicketExists(ticketNumber);
            if (ticketExists) {
                showAuthMessage('Ce num√©ro de facture a d√©j√† √©t√© utilis√©.', 'error');
                return;
            }

            try {
                showAuthMessage('Cr√©ation de votre compte...', 'info');
                
                // 1. Cr√©er le compte d'authentification
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await user.updateProfile({ displayName: `${prenom} ${nom}` });

                // 2. Transaction pour obtenir un ID membre s√©quentiel
                const counterRef = db.collection('counters').doc('memberCounter');
                let newMemberId;

                await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newIdNumber;
                    
                    if (!counterDoc.exists) {
                        // Si le compteur n'existe pas, on le cr√©e √† 1
                        newIdNumber = 1;
                        transaction.set(counterRef, { lastId: newIdNumber });
                    } else {
                        // Incr√©menter le compteur existant
                        newIdNumber = (counterDoc.data().lastId || 0) + 1;
                        transaction.update(counterRef, { lastId: newIdNumber });
                    }
                    
                    // Formater le num√©ro en cha√Æne de 4 chiffres
                    const formattedId = String(newIdNumber).padStart(4, '0');
                    newMemberId = `CE-${formattedId}`;
                    
                    console.log('‚úÖ Nouvel ID membre g√©n√©r√©:', newMemberId);
                });

                // 3. G√©n√©rer un code de parrainage unique format CLUBCE + 2 chiffres
                const generateReferralCode = (memberId) => {
                    // Extraire les 2 derniers chiffres de l'ID membre
                    const memberNumber = memberId.replace('CE-', '');
                    const lastTwoDigits = memberNumber.slice(-2);
                    return `CLUBCE${lastTwoDigits}`;
                };
                
                const userReferralCode = generateReferralCode(newMemberId);
                
                // 4. V√©rifier et traiter le code de parrainage si fourni
                let bonusPoints = 50; // Points de base
                let referredBy = null;
                
                if (referralCode && referralCode.length > 0) {
                    try {
                        // Chercher l'utilisateur qui a ce code de parrainage
                        const referrerQuery = await db.collection('users')
                            .where('referralCode', '==', referralCode)
                            .limit(1)
                            .get();
                        
                        if (!referrerQuery.empty) {
                            const referrerDoc = referrerQuery.docs[0];
                            const referrerId = referrerDoc.id;
                            referredBy = referrerId;
                            bonusPoints = 100; // 50 de base + 50 de parrainage
                            
                            // Cr√©diter 50 points au parrain
                            await db.collection('users').doc(referrerId).update({
                                points: firebase.firestore.FieldValue.increment(50)
                            });
                            
                            // Ajouter √† l'historique du parrain
                            await db.collection('users').doc(referrerId).collection('history').add({
                                type: 'parrainage',
                                description: `Parrainage de ${prenom} ${nom}`,
                                points: 50,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log('‚úÖ Parrainage trait√© avec succ√®s');
                        } else {
                            console.log('‚ö†Ô∏è Code de parrainage invalide:', referralCode);
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur traitement parrainage:', error);
                    }
                }

                // 5. Cr√©er le profil utilisateur avec le nouvel ID
                const userProfile = {
                    memberId: newMemberId,
                    prenom: prenom,
                    nom: nom,
                    email: email,
                    telephone: telephone,
                    points: bonusPoints,
                    lastTicket: ticketNumber,
                    tier: 'Bronze',
                    referralCode: userReferralCode,
                    referredBy: referredBy,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    qrCodeExpiry: null,
                    lastQRGeneration: null
                };
                await db.collection('users').doc(user.uid).set(userProfile);

                // 6. G√©rer la persistance de la connexion
                if (stayConnected) {
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } else {
                    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                }

                // 7. Enregistrer le ticket comme utilis√©
                await db.collection('usedTickets').doc(ticketNumber).set({
                    userId: user.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'inscription'
                });
                
                // 8. Ajouter √† l'historique
                const historyEntries = [{
                    type: 'inscription',
                    description: 'Bienvenue au Club Avantage !',
                    points: 50,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }];
                
                // Ajouter l'entr√©e de parrainage si applicable
                if (referredBy) {
                    historyEntries.push({
                        type: 'parrainage',
                        description: 'Bonus de parrainage re√ßu',
                        points: 50,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Ajouter toutes les entr√©es d'historique
                const batch = db.batch();
                historyEntries.forEach(entry => {
                    const historyRef = db.collection('users').doc(user.uid).collection('history').doc();
                    batch.set(historyRef, entry);
                });
                await batch.commit();

                // 6. Afficher la confirmation avec les bonnes donn√©es
                showConfirmationPage(prenom, nom, newMemberId);

            } catch (error) {
                console.error("Erreur d'inscription:", error);
                let message = 'Erreur lors de l\'inscription.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Cette adresse email est d√©j√† utilis√©e.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Le mot de passe est trop faible.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Adresse email invalide.';
                } else if (error.message) {
                    message = error.message;
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Fonction de connexion
        async function handleSignin(e) {
            e.preventDefault();
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            const stayConnected = document.getElementById('signin-stay-connected').checked;
            
            // Validation c√¥t√© client
            if (!email) {
                showAuthMessage('Veuillez saisir votre adresse email.', 'error');
                return;
            }
            
            if (!password) {
                showAuthMessage('Veuillez saisir votre mot de passe.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Le mot de passe doit contenir au moins 6 caract√®res.', 'error');
                return;
            }
            
            try {
                showAuthMessage('Connexion en cours...', 'info');
                console.log('üîê Tentative de connexion pour:', email);
                
                // G√©rer la persistance avant la connexion
                if (stayConnected) {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } else {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                }
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Connexion r√©ussie pour:', userCredential.user.email);
                
                // Mettre √† jour la derni√®re activit√©
                try {
                    await db.collection('users').doc(userCredential.user.uid).update({
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Derni√®re activit√© mise √† jour');
                } catch (updateError) {
                    console.warn('‚ö†Ô∏è Erreur mise √† jour activit√© (non bloquant):', updateError);
                }
                
                showAuthMessage('Connexion r√©ussie ! Redirection...', 'success');
                
            } catch (error) {
                console.error('‚ùå Erreur connexion d√©taill√©e:', error);
                console.error('‚ùå Code d\'erreur:', error.code);
                console.error('‚ùå Message d\'erreur:', error.message);
                
                let message = 'Erreur lors de la connexion.';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        message = 'Aucun compte trouv√© avec cette adresse email. V√©rifiez votre email ou inscrivez-vous.';
                        break;
                    case 'auth/wrong-password':
                        message = 'Mot de passe incorrect. V√©rifiez votre mot de passe.';
                        break;
                    case 'auth/invalid-email':
                        message = 'Format d\'adresse email invalide.';
                        break;
                    case 'auth/user-disabled':
                        message = 'Ce compte a √©t√© d√©sactiv√©. Contactez le support.';
                        break;
                    case 'auth/too-many-requests':
                        message = 'Trop de tentatives de connexion. Attendez quelques minutes avant de r√©essayer.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Erreur de connexion r√©seau. V√©rifiez votre connexion internet.';
                        break;
                    case 'auth/invalid-credential':
                        message = 'Email ou mot de passe incorrect. V√©rifiez vos informations.';
                        break;
                    default:
                        message = `Erreur de connexion: ${error.message}`;
                        break;
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Charger les donn√©es utilisateur - Version optimis√©e
        async function loadUserData(user) {
            if (!user) {
                console.error('‚ùå Aucun utilisateur fourni pour loadUserData');
                return;
            }
            
            console.log('üìä Chargement des donn√©es utilisateur pour:', user.email);
            
            // Nettoyer l'ancien √©couteur s'il existe
            if (userDataListener) {
                userDataListener();
                userDataListener = null;
            }
            
            try {
                // D'abord, essayer de lire le document une seule fois pour tester les permissions
                console.log('üîç Test de lecture du document utilisateur...');
                const docRef = db.collection('users').doc(user.uid);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) {
                    console.log('üìù Document utilisateur inexistant, cr√©ation en cours...');
                    
                    // Cr√©er le document utilisateur avec ID membre
                    const displayName = user.displayName || 'Membre CE';
                    const nameParts = displayName.split(' ');
                    
                    // G√©n√©rer un ID membre unique
                    let newMemberId = 'CE-0001'; // Valeur par d√©faut
                    
                    try {
                        // Transaction pour obtenir un nouvel ID Membre s√©quentiel
                        const counterRef = db.collection('counters').doc('memberCounter');
                        
                        await db.runTransaction(async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            let newIdNumber;
                            
                            if (!counterDoc.exists) {
                                // Cr√©er le compteur s'il n'existe pas, en commen√ßant √† 1
                                newIdNumber = 1;
                                transaction.set(counterRef, { lastId: newIdNumber });
                            } else {
                                // Incr√©menter le compteur existant
                                newIdNumber = (counterDoc.data().lastId || 0) + 1;
                                transaction.update(counterRef, { lastId: newIdNumber });
                            }
                            
                            // Formater le num√©ro en cha√Æne de 4 chiffres avec des z√©ros devant (ex: 0001, 0002, 0003)
                            const formattedId = String(newIdNumber).padStart(4, '0');
                            newMemberId = `CE-${formattedId}`;
                        });
                        
                        console.log('‚úÖ Nouvel ID membre g√©n√©r√©:', newMemberId);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur g√©n√©ration ID membre:', error);
                        // Utiliser un ID de fallback bas√© sur le timestamp
                        const timestamp = Date.now().toString().slice(-4);
                        newMemberId = `CE-${timestamp}`;
                    }
                    
                    // G√©n√©rer un code de parrainage unique format CLUBCE + 2 chiffres
                    const generateReferralCode = (memberId) => {
                        const memberNumber = memberId.replace('CE-', '');
                        const lastTwoDigits = memberNumber.slice(-2);
                        return `CLUBCE${lastTwoDigits}`;
                    };
                    
                    const userReferralCode = generateReferralCode(newMemberId);
                    
                    const newUserData = {
                        memberId: newMemberId, // ID membre ajout√©
                        nom: nameParts[1] || 'CE',
                        prenom: nameParts[0] || 'Membre',
                        email: user.email,
                        telephone: '', // Champ t√©l√©phone inclus par d√©faut
                        points: 50,
                        lastTicket: '',
                        tier: 'Bronze',
                        referralCode: userReferralCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                        qrCodeExpiry: null,
                        lastQRGeneration: null
                    };
                    
                    console.log('üíæ Donn√©es √† sauvegarder:', newUserData);
                    await docRef.set(newUserData);
                    console.log('‚úÖ Document utilisateur cr√©√© avec succ√®s avec ID:', newMemberId);
                    
                    // Mettre √† jour l'interface avec les nouvelles donn√©es imm√©diatement
                    const immediateData = {
                        ...newUserData,
                        createdAt: new Date(), // Pour l'affichage imm√©diat
                        memberId: newMemberId // S'assurer que l'ID est pr√©sent
                    };
                    updateUserInterface(immediateData);
                    
                    // Ajouter l'√©v√©nement d'inscription √† l'historique
                    try {
                        await docRef.collection('history').add({
                            type: 'inscription',
                            points: 50,
                            description: 'Inscription au Club Avantage CE',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('‚úÖ Historique d\'inscription ajout√©');
                    } catch (historyError) {
                        console.error('‚ö†Ô∏è Erreur ajout historique:', historyError);
                        // Ne pas bloquer pour l'historique
                    }
                    
                } else {
                    console.log('‚úÖ Document utilisateur trouv√©');
                    const userData = docSnapshot.data();
                    console.log('üìä Donn√©es r√©cup√©r√©es:', userData);
                    updateUserInterface(userData);
                }
                
                // Maintenant configurer l'√©couteur en temps r√©el
                console.log('üëÇ Configuration de l\'√©couteur temps r√©el...');
                userDataListener = docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        console.log('üîÑ Mise √† jour temps r√©el re√ßue');
                        const userData = doc.data();
                        updateUserInterface(userData);
                    } else {
                        console.log('‚ö†Ô∏è Document n\'existe plus dans l\'√©couteur');
                    }
                }, (error) => {
                    console.error('‚ùå Erreur √©couteur temps r√©el:', error);
                    // Ne pas afficher d'erreur pour l'√©couteur, les donn√©es sont d√©j√† charg√©es
                });
                
                // Charger l'activit√© r√©cente
                loadRecentActivity();
                
                showMessage('‚úÖ Donn√©es charg√©es avec succ√®s !', 'success');
                
            } catch (error) {
                console.error('‚ùå ERREUR CRITIQUE lors du chargement des donn√©es:', error);
                console.error('‚ùå Code d\'erreur:', error.code);
                console.error('‚ùå Message d\'erreur:', error.message);
                
                let errorMessage = 'Erreur de chargement des donn√©es';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permissions insuffisantes. Veuillez vous reconnecter.';
                    console.log('üîÑ Tentative de reconnexion automatique...');
                    
                    // Essayer de se reconnecter
                    setTimeout(() => {
                        auth.signOut().then(() => {
                            showMessage('Reconnexion n√©cessaire, veuillez vous connecter √† nouveau.', 'info');
                        });
                    }, 2000);
                    
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Service temporairement indisponible. R√©essayez dans quelques instants.';
                } else {
                    errorMessage = `Erreur: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
                
                // Afficher des donn√©es par d√©faut pour ne pas laisser l'interface vide
                console.log('üîß Affichage des donn√©es par d√©faut...');
                const fallbackData = {
                    memberId: 'CE-0000',
                    nom: 'Membre',
                    prenom: 'CE',
                    email: user.email || 'email@example.com',
                    points: 0,
                    tier: 'Bronze',
                    createdAt: new Date()
                };
                updateUserInterface(fallbackData);
            }
        }

        // Mettre √† jour l'interface utilisateur
        function updateUserInterface(userData) {
            console.log('üé® Mise √† jour de l\'interface avec:', userData);
            
            // Nom complet avec num√©ro de membre
            const memberName = document.getElementById('member-name');
            if (memberName) {
                let displayName = '';
                
                // Priorit√© au nom complet depuis les donn√©es Firestore
                if (userData.prenom && userData.nom) {
                    displayName = `${userData.prenom} ${userData.nom}`;
                } 
                // Sinon utiliser displayName de Firebase Auth
                else if (currentUser && currentUser.displayName) {
                    displayName = currentUser.displayName;
                } 
                // Fallback avec email
                else if (userData.email) {
                    displayName = userData.email.split('@')[0];
                }
                // Dernier fallback
                else {
                    displayName = 'Membre CE';
                }
                
                memberName.textContent = displayName;
                console.log('‚úÖ Nom affich√©:', displayName);
                
                // Mettre √† jour aussi le nom dans la page carte compl√®te
                const cardMemberName = document.getElementById('card-member-name');
                if (cardMemberName) {
                    cardMemberName.textContent = displayName;
                }
            }
            
            // Afficher le num√©ro de membre s√©par√©ment s'il existe
            const memberIdDisplay = document.getElementById('member-id-display');
            if (memberIdDisplay && userData.memberId) {
                memberIdDisplay.textContent = userData.memberId;
            }
            
            // Email
            const memberEmail = document.getElementById('member-email');
            if (memberEmail) {
                memberEmail.textContent = userData.email || (currentUser ? currentUser.email : 'email@example.com');
            }
            
            // Niveau/Tier
            const memberTier = document.getElementById('member-tier');
            if (memberTier) {
                memberTier.textContent = userData.tier || 'Bronze';
            }
            
            // Date d'inscription
            const memberSince = document.getElementById('member-since');
            if (memberSince) {
                let dateText = '';
                
                if (userData.createdAt) {
                    try {
                        // Si c'est un timestamp Firestore
                        if (userData.createdAt.toDate) {
                            const date = userData.createdAt.toDate();
                            dateText = date.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                        // Si c'est d√©j√† un objet Date
                        else if (userData.createdAt instanceof Date) {
                            dateText = userData.createdAt.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                        // Si c'est une cha√Æne de date
                        else if (typeof userData.createdAt === 'string') {
                            const date = new Date(userData.createdAt);
                            dateText = date.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur conversion date:', error);
                        dateText = new Date().toLocaleDateString('fr-FR', { 
                            year: 'numeric', 
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                } else {
                    // Fallback pour les nouveaux comptes
                    dateText = new Date().toLocaleDateString('fr-FR', { 
                        year: 'numeric', 
                        month: 'short',
                        day: 'numeric'
                    });
                }
                
                memberSince.textContent = dateText;
            }
            
            // Points avec animation
            const pointsBalance = document.getElementById('points-balance');
            if (pointsBalance) {
                const currentPoints = parseInt(pointsBalance.textContent) || 0;
                const newPoints = parseInt(userData.points) || 0;
                
                if (currentPoints !== newPoints) {
                    animateNumber('points-balance', currentPoints, newPoints, 1000);
                } else {
                    pointsBalance.textContent = newPoints;
                }
            }
            
            // Niveau actuel
            const currentLevel = document.getElementById('current-level');
            if (currentLevel) {
                currentLevel.textContent = userData.tier || 'Bronze';
            }
            
            // Code de parrainage - G√©n√©rer s'il n'existe pas
            const referralCodeDisplay = document.getElementById('referral-code-display');
            if (referralCodeDisplay) {
                if (userData.referralCode) {
                    referralCodeDisplay.textContent = userData.referralCode;
                } else if (userData.memberId && userData.memberId !== 'CE-0000') {
                    // G√©n√©rer le code de parrainage √† partir de l'ID membre
                    const memberNumber = userData.memberId.replace('CE-', '');
                    const lastTwoDigits = memberNumber.slice(-2);
                    const generatedCode = `CLUBCE${lastTwoDigits}`;
                    referralCodeDisplay.textContent = generatedCode;
                    
                    // Sauvegarder le code g√©n√©r√© dans Firestore
                    if (currentUser) {
                        db.collection('users').doc(currentUser.uid).update({
                            referralCode: generatedCode
                        }).catch(error => console.error('Erreur sauvegarde code parrainage:', error));
                    }
                } else {
                    referralCodeDisplay.textContent = 'LOADING...';
                }
            }
            
            // Progression du niveau
            updateLevelProgress(userData.points || 0);
        }

        // Charger l'activit√© r√©cente avec gestion des permissions
        async function loadRecentActivity() {
            if (!currentUser) {
                console.log('‚ö†Ô∏è Aucun utilisateur connect√© pour charger l\'activit√©');
                return;
            }
            
            console.log('üìä Chargement de l\'activit√© r√©cente...');
            
            const activityContainer = document.getElementById('recent-activity');
            if (!activityContainer) {
                console.error('‚ùå Container d\'activit√© non trouv√©');
                return;
            }
            
            try {
                const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('history')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                activityContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    console.log('üìù Aucune activit√© trouv√©e, affichage du message par d√©faut');
                    activityContainer.innerHTML = `
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm font-medium">Bienvenue dans le Club !</span>
                            </div>
                            <span class="text-sm text-gray-600">+50 pts</span>
                        </div>
                    `;
                } else {
                    console.log('‚úÖ Activit√©s trouv√©es:', querySnapshot.size);
                    querySnapshot.forEach((doc) => {
                        const activity = doc.data();
                        const activityElement = createActivityElement(activity);
                        activityContainer.appendChild(activityElement);
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement activit√©:', error);
                
                // Afficher un message par d√©faut m√™me en cas d'erreur
                activityContainer.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm font-medium">Membre du Club Avantage CE</span>
                        </div>
                        <span class="text-sm text-gray-600">üéâ</span>
                    </div>
                `;
                
                // Ne pas afficher d'erreur √† l'utilisateur pour l'historique
                console.log('‚ÑπÔ∏è Historique non disponible, affichage du message par d√©faut');
            }
        }

        // Cr√©er un √©l√©ment d'activit√© avec date
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-50 rounded-lg space-y-1';
            
            const typeColors = {
                'inscription': 'bg-green-500',
                'achat': 'bg-blue-500',
                'bonus': 'bg-yellow-500',
                'reduction': 'bg-purple-500'
            };
            
            const color = typeColors[activity.type] || 'bg-gray-500';
            
            // Formater la date
            let dateText = '';
            if (activity.timestamp) {
                try {
                    const date = activity.timestamp.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
                    dateText = date.toLocaleDateString('fr-FR', { 
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    dateText = 'Date inconnue';
                }
            } else {
                dateText = 'Aujourd\'hui';
            }
            
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 ${color} rounded-full"></div>
                        <span class="text-sm font-medium">${activity.description}</span>
                    </div>
                    <span class="text-sm text-gray-600 font-semibold">${activity.points > 0 ? '+' : ''}${activity.points} pts</span>
                </div>
                <div class="text-xs text-gray-500 ml-4">
                    ${dateText}
                </div>
            `;
            
            return div;
        }

        // Valider le format du ticket
        function validateTicketFormat(ticket) {
            const pattern1 = /^S\d{5}$/; // S suivi de 5 chiffres
            const pattern2 = /^\d{5}-\d{3}-\d{4}$/; // 00000-003-0012
            return pattern1.test(ticket) || pattern2.test(ticket);
        }
        
        // V√©rifier si un ticket existe d√©j√†
        async function checkTicketExists(ticketNumber) {
            try {
                const doc = await db.collection('usedTickets').doc(ticketNumber).get();
                return doc.exists;
            } catch (error) {
                console.error('Erreur v√©rification ticket:', error);
                return false;
            }
        }
        

        
        // Fonctions pour la page carte compl√®te
        function showCardPage() {
            console.log('üì± Affichage de la page carte compl√®te...');
            const fullCardPage = document.getElementById('full-card-page');
            if (fullCardPage) {
                fullCardPage.classList.remove('hidden');
                fullCardPage.style.display = 'block';
                
                // Forcer le scroll en haut de la page
                fullCardPage.scrollTop = 0;
                document.body.style.overflow = 'hidden';
                
                // Mettre √† jour les informations de la carte
                setTimeout(() => {
                    updateCardPageData();
                    
                    // G√©n√©rer le QR Code grand avec un d√©lai pour s'assurer que la page est affich√©e
                    if (currentUser) {
                        setTimeout(() => {
                            generateLargeQRCode(currentUser.uid);
                        }, 500);
                    }
                }, 100);
            }
        }

        function hideCardPage() {
            console.log('üîô Fermeture de la page carte...');
            const fullCardPage = document.getElementById('full-card-page');
            if (fullCardPage) {
                fullCardPage.classList.add('hidden');
                fullCardPage.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function updateCardPageData() {
            if (!currentUser) return;
            
            // R√©cup√©rer les donn√©es depuis l'interface principale
            const memberName = document.getElementById('member-name')?.textContent || 'Membre CE';
            const memberId = document.getElementById('member-id-display')?.textContent || 'CE-0000';
            const memberTier = document.getElementById('member-tier')?.textContent || 'Bronze';
            const pointsBalance = document.getElementById('points-balance')?.textContent || '0';
            
            // Mettre √† jour la page carte
            const cardMemberName = document.getElementById('card-member-name');
            const cardMemberId = document.getElementById('card-member-id');
            const cardMemberTier = document.getElementById('card-member-tier');
            const cardMemberPoints = document.getElementById('card-member-points');
            
            if (cardMemberName) cardMemberName.textContent = memberName;
            if (cardMemberId) cardMemberId.textContent = memberId;
            if (cardMemberTier) cardMemberTier.textContent = memberTier;
            if (cardMemberPoints) cardMemberPoints.textContent = pointsBalance;
            
            console.log('‚úÖ Donn√©es de la carte mises √† jour:', {
                nom: memberName,
                id: memberId,
                niveau: memberTier,
                points: pointsBalance
            });
        }

        function refreshQRCode() {
            if (currentUser) {
                console.log('üîÑ Actualisation du QR Code...');
                generateLargeQRCode(currentUser.uid);
            }
        }

        function shareCard() {
            const memberName = document.getElementById('card-member-name')?.textContent || 'Membre CE';
            const memberId = document.getElementById('card-member-id')?.textContent || 'CE-0000';
            
            const shareText = `üéâ Je suis membre du Club Avantage CE !\n\nMon num√©ro de membre : ${memberId}\n\nRejoignez-moi et b√©n√©ficiez d'avantages exclusifs !\n\n${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ma Carte Club Avantage CE',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('üìã Informations de carte copi√©es !', 'success');
                });
            }
        }

        // G√©n√©rer le QR Code grand pour la page carte - Version forc√©e
        async function generateLargeQRCode(userId, retryCount = 0) {
            console.log('üîÑ G√©n√©ration FORC√âE du QR Code grand pour userId:', userId);
            const qrcodeDiv = document.getElementById('large-qrcode-container');
            if (!qrcodeDiv) {
                console.error('‚ùå Container QR Code grand non trouv√©');
                return;
            }
            
            // Afficher un message de chargement
            qrcodeDiv.innerHTML = `
                <div class="bg-gray-100 rounded-2xl p-8">
                    <div class="text-center">
                        <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-600">G√©n√©ration du QR Code...</p>
                    </div>
                </div>
            `;
            
            let memberId = null;
            
            try {
                // 1. Essayer de r√©cup√©rer l'ID membre depuis l'interface d'abord
                const memberIdElement = document.getElementById('member-id-display');
                if (memberIdElement && memberIdElement.textContent && memberIdElement.textContent !== 'CE-0000') {
                    memberId = memberIdElement.textContent;
                    console.log('‚úÖ ID membre r√©cup√©r√© depuis l\'interface:', memberId);
                } else {
                    // 2. Essayer depuis la page carte
                    const cardMemberIdElement = document.getElementById('card-member-id');
                    if (cardMemberIdElement && cardMemberIdElement.textContent && cardMemberIdElement.textContent !== 'CE-0000') {
                        memberId = cardMemberIdElement.textContent;
                        console.log('‚úÖ ID membre r√©cup√©r√© depuis la carte:', memberId);
                    } else {
                        // 3. R√©cup√©rer depuis Firestore
                        console.log('üîç R√©cup√©ration ID membre depuis Firestore...');
                        const userDoc = await db.collection('users').doc(userId).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            memberId = userData?.memberId;
                            console.log('üìä Donn√©es Firestore:', userData);
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erreur r√©cup√©ration ID membre:', error);
            }
            
            // 4. Si toujours pas d'ID membre, g√©n√©rer un fallback IMM√âDIATEMENT
            if (!memberId || memberId === 'CE-0000' || memberId === 'undefined') {
                console.warn('‚ö†Ô∏è G√©n√©ration d\'un ID de fallback imm√©diat');
                const timestamp = Date.now().toString().slice(-4);
                const userIdSuffix = userId.slice(-4).toUpperCase();
                memberId = `CE-${userIdSuffix}`;
                console.log('üÜî ID de fallback g√©n√©r√©:', memberId);
            }
            
            // 5. FORCER la g√©n√©ration du QR Code maintenant
            console.log('üöÄ G√âN√âRATION FORC√âE du QR Code pour:', memberId);
            
            try {
                // Vider le container et cr√©er le nouveau QR Code
                qrcodeDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div id="large-qr-display"></div>
                    </div>
                `;
                
                // Attendre que le DOM soit mis √† jour
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const qrContainer = document.getElementById('large-qr-display');
                if (qrContainer) {
                    // G√©n√©rer le QR Code avec gestion d'erreur
                    new QRCode(qrContainer, {
                        text: memberId,
                        width: 250,
                        height: 250,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    console.log('‚úÖ QR Code FORC√â g√©n√©r√© avec succ√®s pour:', memberId);
                    
                    // Mettre √† jour l'ID membre dans l'interface si c'√©tait un fallback
                    if (memberId.includes(userId.slice(-4))) {
                        const memberIdDisplay = document.getElementById('member-id-display');
                        const cardMemberIdDisplay = document.getElementById('card-member-id');
                        if (memberIdDisplay) memberIdDisplay.textContent = memberId;
                        if (cardMemberIdDisplay) cardMemberIdDisplay.textContent = memberId;
                        
                        // Sauvegarder dans Firestore
                        if (currentUser) {
                            db.collection('users').doc(currentUser.uid).update({
                                memberId: memberId
                            }).catch(error => console.error('Erreur sauvegarde ID membre:', error));
                        }
                    }
                    
                    return;
                } else {
                    throw new Error('Container QR Code non trouv√© apr√®s cr√©ation');
                }
                
            } catch (qrError) {
                console.error('‚ùå Erreur cr√©ation QR Code:', qrError);
                
                // Derni√®re tentative avec un QR Code simple
                qrcodeDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div class="text-center space-y-4">
                            <div class="w-64 h-64 bg-gray-200 rounded-lg flex items-center justify-center mx-auto">
                                <div class="text-center">
                                    <div class="text-4xl font-bold text-gray-600 mb-2">${memberId}</div>
                                    <div class="text-sm text-gray-500">Code Membre</div>
                                    <div class="text-xs text-gray-400 mt-2">Pr√©sentez ce code en caisse</div>
                                </div>
                            </div>
                            <button onclick="generateLargeQRCode('${userId}', 0)" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-all">
                                üîÑ G√©n√©rer le QR Code
                            </button>
                        </div>
                    </div>
                `;
                
                console.log('‚ö†Ô∏è QR Code de fallback affich√© avec le code membre');
            }
        }



        // Mettre √† jour la progression du niveau
        function updateLevelProgress(points) {
            let currentLevel, nextLevel, progress, pointsToNext;
            
            if (points < 50) {
                currentLevel = 'Bronze';
                nextLevel = 'Argent';
                progress = (points / 50) * 100;
                pointsToNext = 50 - points;
            } else if (points < 100) {
                currentLevel = 'Argent';
                nextLevel = 'Or';
                progress = ((points - 50) / 50) * 100;
                pointsToNext = 100 - points;
            } else {
                currentLevel = 'Or';
                nextLevel = 'VIP';
                progress = 100;
                pointsToNext = 0;
            }
            
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('next-level').textContent = nextLevel;
            document.getElementById('level-progress').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('points-to-next').textContent = 
                pointsToNext > 0 ? `${pointsToNext} points pour le niveau suivant` : 'Niveau maximum atteint !';
        }

        // Animation des nombres
        function animateNumber(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 16);
        }

        // Actualiser les donn√©es - Version optimis√©e
        function refreshData() {
            if (!currentUser) {
                console.error('‚ùå Aucun utilisateur connect√© pour actualiser');
                showMessage('Erreur: Aucun utilisateur connect√©', 'error');
                return;
            }
            
            console.log('üîÑ Actualisation des donn√©es utilisateur...');
            showMessage('üîÑ Actualisation des donn√©es...', 'info');
            
            // Recharger les donn√©es utilisateur
            loadUserData(currentUser);
            
            setTimeout(() => {
                showMessage('‚úÖ Donn√©es actualis√©es !', 'success');
                console.log('‚úÖ Actualisation termin√©e');
            }, 1500);
        }

        // Partager l'application avec options r√©seaux sociaux
        function shareApp() {
            const shareText = `üéâ Rejoignez-moi dans le Club Avantage CE ! Points de fid√©lit√©, r√©ductions exclusives et bien plus. Inscrivez-vous : ${window.location.href}`;
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(window.location.href);
            
            // Cr√©er un menu de partage pour l'application
            const shareMenu = document.createElement('div');
            shareMenu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50';
            shareMenu.innerHTML = `
                <div class="bg-white rounded-t-3xl p-6 w-full max-w-md animate-slide-up">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Partager l'application</h3>
                        <p class="text-sm text-gray-600 mt-2">Invitez vos amis √† rejoindre le Club Avantage CE</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <!-- WhatsApp -->
                        <a href="https://wa.me/?text=${encodedText}" target="_blank" 
                           class="flex flex-col items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">WhatsApp</span>
                        </a>
                        
                        <!-- Facebook -->
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Facebook</span>
                        </a>
                        
                        <!-- Twitter -->
                        <a href="https://twitter.com/intent/tweet?text=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-all">
                            <div class="w-12 h-12 bg-sky-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Twitter</span>
                        </a>
                        
                        <!-- Telegram -->
                        <a href="https://t.me/share/url?url=${encodedUrl}&text=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Telegram</span>
                        </a>
                        
                        <!-- LinkedIn -->
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-700 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">LinkedIn</span>
                        </a>
                        
                        <!-- Copier -->
                        <button onclick="copyAppLink('${shareText}')"
                                class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all">
                            <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Copier</span>
                        </button>
                    </div>
                    
                    <button onclick="closeShareMenu()" 
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                        Fermer
                    </button>
                </div>
            `;
            
            document.body.appendChild(shareMenu);
            
            // Fermer en cliquant √† l'ext√©rieur
            shareMenu.addEventListener('click', (e) => {
                if (e.target === shareMenu) {
                    closeShareMenu();
                }
            });
        }
        
        // Copier le lien de l'application
        function copyAppLink(shareText) {
            navigator.clipboard.writeText(shareText).then(() => {
                showMessage('üìã Lien de l\'application copi√© !', 'success');
                closeShareMenu();
            });
        }

        // Partager le code de parrainage avec options r√©seaux sociaux
        function shareReferralCode() {
            const referralCode = document.getElementById('referral-code-display').textContent;
            
            if (referralCode && referralCode !== 'LOADING...') {
                const shareText = `üéÅ Rejoignez le Club Avantage CE avec mon code de parrainage : ${referralCode}\n\nVous recevrez 50 points bonus √† l'inscription et moi aussi ! üéâ\n\nInscrivez-vous ici : ${window.location.href}`;
                const encodedText = encodeURIComponent(shareText);
                const encodedUrl = encodeURIComponent(window.location.href);
                
                // Cr√©er un menu de partage
                const shareMenu = document.createElement('div');
                shareMenu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50';
                shareMenu.innerHTML = `
                    <div class="bg-white rounded-t-3xl p-6 w-full max-w-md animate-slide-up">
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Partager mon code</h3>
                            <p class="text-sm text-gray-600 mt-2">Code: <span class="font-bold text-blue-600">${referralCode}</span></p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <!-- WhatsApp -->
                            <a href="https://wa.me/?text=${encodedText}" target="_blank" 
                               class="flex flex-col items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">WhatsApp</span>
                            </a>
                            
                            <!-- Facebook -->
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Facebook</span>
                            </a>
                            
                            <!-- Twitter -->
                            <a href="https://twitter.com/intent/tweet?text=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-all">
                                <div class="w-12 h-12 bg-sky-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Twitter</span>
                            </a>
                            
                            <!-- Telegram -->
                            <a href="https://t.me/share/url?url=${encodedUrl}&text=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Telegram</span>
                            </a>
                            
                            <!-- LinkedIn -->
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-700 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">LinkedIn</span>
                            </a>
                            
                            <!-- Copier -->
                            <button onclick="copyReferralCode('${referralCode}', '${shareText}')"
                                    class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all">
                                <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Copier</span>
                            </button>
                        </div>
                        
                        <button onclick="closeShareMenu()" 
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                            Fermer
                        </button>
                    </div>
                `;
                
                document.body.appendChild(shareMenu);
                
                // Fermer en cliquant √† l'ext√©rieur
                shareMenu.addEventListener('click', (e) => {
                    if (e.target === shareMenu) {
                        closeShareMenu();
                    }
                });
                
            } else {
                showMessage('‚è≥ Code de parrainage en cours de chargement...', 'info');
            }
        }
        
        // Copier le code de parrainage
        function copyReferralCode(code, fullText) {
            navigator.clipboard.writeText(fullText).then(() => {
                showMessage('üìã Code de parrainage copi√© !', 'success');
                closeShareMenu();
            });
        }
        
        // Fermer le menu de partage
        function closeShareMenu() {
            const shareMenu = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (shareMenu) {
                shareMenu.remove();
            }
        }

        // D√©connexion - Version optimis√©e
        function logout() {
            console.log('üö™ D√©connexion en cours...');
            
            // Afficher l'√©cran de chargement pendant la d√©connexion
            showLoadingScreen();
            
            // Nettoyer les √©couteurs avant la d√©connexion
            if (userDataListener) {
                console.log('üßπ Nettoyage de l\'√©couteur Firestore...');
                userDataListener();
                userDataListener = null;
            }
            
            auth.signOut().then(() => {
                console.log('‚úÖ D√©connexion r√©ussie');
                
                // R√©initialiser les variables
                currentUser = null;
                
                showMessage('üëã √Ä bient√¥t !', 'info');
                
            }).catch((error) => {
                console.error('‚ùå Erreur lors de la d√©connexion:', error);
                hideLoadingScreen();
                showMessage('Erreur lors de la d√©connexion', 'error');
            });
        }

        // Fonctions d'affichage/masquage des √©crans - Version optimis√©e
        function showLoadingScreen() {
            console.log('‚è≥ Affichage de l\'√©cran de chargement');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (loadingScreen) {
                loadingScreen.classList.remove('hidden');
                loadingScreen.style.display = 'flex';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        function hideLoadingScreen() {
            console.log('‚úÖ Masquage de l\'√©cran de chargement');
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
        }

        function showAuthScreen() {
            console.log('üîê Affichage de l\'√©cran d\'authentification');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (authScreen) {
                authScreen.classList.remove('hidden');
                authScreen.style.display = 'block';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        function showCardScreen() {
            console.log('üí≥ Affichage de l\'√©cran de la carte membre');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (cardScreen) {
                cardScreen.classList.remove('hidden');
                cardScreen.style.display = 'block';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        // Afficher les messages d'authentification
        function showAuthMessage(message, type = 'info') {
            const messageDiv = document.getElementById('auth-message');
            let className = 'p-2 rounded-lg font-medium ';
            
            switch(type) {
                case 'success':
                    className += 'bg-green-100 text-green-700 border border-green-300';
                    break;
                case 'error':
                    className += 'bg-red-100 text-red-700 border border-red-300';
                    break;
                case 'info':
                    className += 'bg-blue-100 text-blue-700 border border-blue-300';
                    break;
                default:
                    className += 'bg-gray-100 text-gray-700 border border-gray-300';
            }
            
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 4000);
            }
        }

        // Afficher les messages g√©n√©raux
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Afficher la page de confirmation d'inscription
        function showConfirmationPage(prenom, nom, memberId) {
            console.log('üéâ Affichage de la page de confirmation pour:', prenom, nom, memberId);
            
            // Masquer tous les autres √©crans
            hideAllScreens();
            
            // Afficher l'√©cran de confirmation
            const confirmationScreen = document.getElementById('confirmation-screen');
            if (confirmationScreen) {
                confirmationScreen.classList.remove('hidden');
                confirmationScreen.style.display = 'block';
            }
            
            // Mettre √† jour les informations
            const memberIdDisplay = document.getElementById('confirmation-member-id');
            const memberIdCopy = document.getElementById('confirmation-member-id-copy');
            const confirmationName = document.getElementById('confirmation-name');
            
            if (memberIdDisplay) {
                memberIdDisplay.textContent = memberId;
            }
            if (memberIdCopy) {
                memberIdCopy.textContent = memberId;
            }
            if (confirmationName) {
                confirmationName.textContent = `${prenom} ${nom}`;
            }
            
            console.log('‚úÖ Page de confirmation affich√©e avec succ√®s');
        }

        // Aller vers l'espace membre depuis la confirmation
        function goToMemberArea() {
            console.log('üöÄ Redirection vers l\'espace membre...');
            
            // L'utilisateur est d√©j√† connect√© gr√¢ce √† l'inscription
            // On peut directement afficher l'√©cran de la carte
            showCardScreen();
            
            // Charger les donn√©es utilisateur si pas d√©j√† fait
            if (currentUser) {
                loadUserData(currentUser);
            }
        }

        // Masquer tous les √©crans
        function hideAllScreens() {
            const screens = ['loading-screen', 'auth-screen', 'confirmation-screen', 'card-screen'];
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                }
            });
        }

        // Fonction de formatage du t√©l√©phone avec validation s√©n√©galaise
        function formatPhoneNumber(e) {
            const countryCode = document.getElementById('country-code').value;
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (countryCode === '+221') {
                // Format s√©n√©galais: 7X XXX XX XX (9 chiffres: 70/75/76/77/78 + 7 chiffres)
                // Limiter √† 9 chiffres
                value = value.substring(0, 9);
                
                // Formatage visuel: 7X XXX XX XX
                if (value.length >= 2) {
                    value = value.substring(0, 2) + ' ' + value.substring(2);
                }
                if (value.length >= 7) {
                    value = value.substring(0, 7) + ' ' + value.substring(7);
                }
                if (value.length >= 10) {
                    value = value.substring(0, 10) + ' ' + value.substring(10);
                }
            } else if (countryCode === '+33') {
                // Format fran√ßais: 0X XX XX XX XX
                value = value.substring(0, 10);
                if (value.length >= 2) {
                    value = value.substring(0, 2) + ' ' + value.substring(2);
                }
                if (value.length >= 6) {
                    value = value.substring(0, 6) + ' ' + value.substring(6);
                }
                if (value.length >= 9) {
                    value = value.substring(0, 9) + ' ' + value.substring(9);
                }
            } else {
                // Format international g√©n√©rique
                value = value.substring(0, 15);
            }
            
            e.target.value = value;
        }
        
        // Fonction pour changer le placeholder selon le pays
        function updatePhonePlaceholder() {
            const countryCode = document.getElementById('country-code').value;
            const phoneInput = document.getElementById('signup-telephone');
            
            if (countryCode === '+221') {
                phoneInput.placeholder = '77 123 45 67';
            } else if (countryCode === '+33') {
                phoneInput.placeholder = '01 23 45 67 89';
            } else {
                phoneInput.placeholder = 'Num√©ro de t√©l√©phone';
            }
            
            // Vider le champ lors du changement de pays
            phoneInput.value = '';
        }
        
        // Formatage en temps r√©el du ticket
        function formatTicketInput(e) {
            let value = e.target.value.toUpperCase();
            
            // Supprimer les caract√®res non autoris√©s
            value = value.replace(/[^S0-9-]/g, '');
            
            // Limiter la longueur selon le format
            if (value.startsWith('S')) {
                // Format S00000
                value = value.substring(0, 6);
            } else {
                // Format 00000-003-0000
                value = value.substring(0, 14);
            }
            
            e.target.value = value;
        }


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9774f3eaa228d6ae',t:'MTc1NjU2Mzg3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
