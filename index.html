<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Avantage CE - Central Equipements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    

    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
                url("https://www.dropbox.com/scl/fi/1p58zvtcf7ir6b818lgy2/Google_AI_Studio_2025-08-20T21_10_49.935Z.png?rlkey=61js5qxy41clfdlvi1h3yjrah&st=w2ry7rbi&dl=1");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(34, 168, 220, 0.3); }
            to { box-shadow: 0 0 40px rgba(34, 168, 220, 0.6), 0 0 60px rgba(253, 216, 53, 0.3); }
        }
        
        .card-shine {
            position: relative;
            overflow: hidden;
        }
        
        .card-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .points-counter {
            animation: pointsGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pointsGlow {
            from { text-shadow: 0 0 10px #fdd835; }
            to { text-shadow: 0 0 20px #fdd835, 0 0 30px #fbc02d; }
        }
        
        .qr-container {
            background: linear-gradient(45deg, #ffffff, #f8f9fa);
            border: 3px solid #22a8dc;
            animation: qrPulse 3s ease-in-out infinite;
        }
        
        @keyframes qrPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(100%); 
                opacity: 0;
            }
            to { 
                transform: translateY(0); 
                opacity: 1;
            }
        }
        
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #22a8dc, #1e90ff);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(34, 168, 220, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scroll-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 168, 220, 0.4);
        }
        
        .scroll-to-top.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Écran de chargement -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-spinner w-16 h-16 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Club Avantage CE</h2>
            <p class="text-blue-200">Chargement de votre espace membre...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg py-2 px-4 text-center relative">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <!-- Menu burger pour mobile/tablette -->
            <button id="menu-toggle" class="lg:hidden bg-gray-100 hover:bg-gray-200 p-2 rounded-lg transition-all">
                <svg class="w-6 h-6 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            
            <!-- Logo responsive -->
            <div class="flex items-center space-x-3">
                <img src="https://www.dropbox.com/scl/fi/oqga476z2lnio05z32j75/CE-KM-CARTE-DE-FIDELITE.png?rlkey=erdsd0tbf71bsojqwx7joyba9&st=u8lf642c&dl=1" 
                     alt="Club Avantage CE" 
                     class="h-12 w-auto object-contain sm:h-16 lg:h-20 xl:h-24"
                     style="max-width: 150px; min-width: 100px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 class="text-lg font-bold text-black hidden cursor-pointer hover:opacity-80 transition-opacity sm:text-xl lg:text-2xl" 
                    style="color: #22a8dc;">CLUB AVANTAGE CE</h1>
                <div class="text-center hidden sm:block">
                    <p class="text-xs text-gray-600 lg:text-sm">Cumulez des points, gagnez des récompenses</p>
                </div>
            </div>
            
            <!-- Menu desktop -->
            <div class="hidden lg:flex items-center space-x-4">
                <div class="relative">
                    <button id="desktop-menu-toggle" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center space-x-2 text-sm font-semibold">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span>Menu</span>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </button>
                    
                    <!-- Dropdown menu desktop -->
                    <div id="desktop-dropdown" class="hidden absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 z-50">
                        <div class="py-2">
                            <button onclick="showCardPage()" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-all flex items-center space-x-3">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                                </svg>
                                <span class="font-medium text-gray-700">Ma Carte Membre</span>
                            </button>
                            <button onclick="showRewardsPage()" class="w-full text-left px-4 py-3 hover:bg-purple-50 transition-all flex items-center space-x-3">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                                <span class="font-medium text-gray-700">Récompenses</span>
                            </button>
                            <button onclick="shareReferralCode()" class="w-full text-left px-4 py-3 hover:bg-green-50 transition-all flex items-center space-x-3">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                                </svg>
                                <span class="font-medium text-gray-700">Parrainage</span>
                            </button>
                            <button onclick="refreshData()" class="w-full text-left px-4 py-3 hover:bg-yellow-50 transition-all flex items-center space-x-3">
                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                                <span class="font-medium text-gray-700">Actualiser</span>
                            </button>
                            <div class="border-t border-gray-200 my-2"></div>
                            <button onclick="shareApp()" class="w-full text-left px-4 py-3 hover:bg-gray-50 transition-all flex items-center space-x-3">
                                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                                </svg>
                                <span class="font-medium text-gray-700">Partager l'app</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button id="logout-btn" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2 text-sm font-semibold" style="display: none;">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                    </svg>
                    <span>Déconnexion</span>
                </button>
            </div>
            
            <!-- Bouton déconnexion mobile -->
            <button id="logout-btn-mobile" class="lg:hidden bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-2 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" style="display: none;">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                </svg>
            </button>
        </div>
        
        <!-- Menu latéral mobile/tablette -->
        <div id="mobile-sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 lg:hidden">
            <div class="flex flex-col h-full">
                <!-- Header du menu -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <div>
                                <h2 class="text-lg font-bold">Club Avantage CE</h2>
                                <p class="text-sm text-blue-200" id="sidebar-member-name">Membre CE</p>
                            </div>
                        </div>
                        <button id="close-sidebar" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Points dans le sidebar -->
                    <div class="mt-4 bg-white/20 rounded-xl p-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-blue-200">Mes points</span>
                            <span class="text-xl font-bold text-yellow-300" id="sidebar-points">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Menu items -->
                <div class="flex-1 py-6">
                    <nav class="space-y-2 px-4">
                        <button onclick="showCardPage(); closeSidebar();" class="w-full text-left px-4 py-4 hover:bg-blue-50 rounded-xl transition-all flex items-center space-x-4">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">Ma Carte Membre</div>
                                <div class="text-sm text-gray-500">Voir ma carte et QR code</div>
                            </div>
                        </button>
                        
                        <button onclick="showRewardsPage(); closeSidebar();" class="w-full text-left px-4 py-4 hover:bg-purple-50 rounded-xl transition-all flex items-center space-x-4">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">Récompenses</div>
                                <div class="text-sm text-gray-500">Échanger mes points</div>
                            </div>
                        </button>
                        
                        <button onclick="shareReferralCode(); closeSidebar();" class="w-full text-left px-4 py-4 hover:bg-green-50 rounded-xl transition-all flex items-center space-x-4">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">Parrainage</div>
                                <div class="text-sm text-gray-500">Inviter des amis</div>
                            </div>
                        </button>
                        
                        <button onclick="refreshData(); closeSidebar();" class="w-full text-left px-4 py-4 hover:bg-yellow-50 rounded-xl transition-all flex items-center space-x-4">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">Actualiser</div>
                                <div class="text-sm text-gray-500">Mettre à jour mes données</div>
                            </div>
                        </button>
                        
                        <div class="border-t border-gray-200 my-4"></div>
                        
                        <button onclick="shareApp(); closeSidebar();" class="w-full text-left px-4 py-4 hover:bg-gray-50 rounded-xl transition-all flex items-center space-x-4">
                            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">Partager l'app</div>
                                <div class="text-sm text-gray-500">Inviter d'autres personnes</div>
                            </div>
                        </button>
                    </nav>
                </div>
                
                <!-- Footer du menu -->
                <div class="p-4 border-t border-gray-200">
                    <button onclick="logout(); closeSidebar();" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H4v16h10v-2h2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h10z"/>
                        </svg>
                        <span>Déconnexion</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Overlay pour fermer le menu -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
    </header>

    <!-- ÉCRAN D'AUTHENTIFICATION -->
    <div id="auth-screen" class="min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-8">
            <!-- Titre d'accueil -->
            <div class="text-center space-y-4 fade-in">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-3xl font-black text-white">Rejoignez le Club Avantage CE !</h2>
                <p class="text-xl text-white/90 font-semibold">
                    Inscrivez-vous maintenant et recevez votre cadeau de bienvenue : <span class="text-yellow-400 font-black" style="text-shadow: 0 0 10px rgba(255,255,255,0.8);">50 points + réduction immédiate !</span>
                </p>
            </div>

            <!-- Bénéfices -->
            <div class="glass-effect rounded-2xl p-6 pulse-glow">
                <h3 class="text-xl font-bold text-center mb-4" style="color: #1e3a8a;">🎯 Vos Avantages Exclusifs</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3 p-2 bg-green-50 rounded-lg">
                        <div class="bg-green-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Un bonus de -5% immédiat</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Cumulez des points à chaque visite</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-purple-50 rounded-lg">
                        <div class="bg-purple-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Accédez à des récompenses exclusives</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-2 bg-yellow-50 rounded-lg">
                        <div class="bg-yellow-500 rounded-full p-1">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="font-semibold text-gray-800 text-sm">Obtenez votre carte de fidélité virtuelle</span>
                    </div>
                </div>
            </div>

            <!-- Onglets Inscription/Connexion -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button id="signup-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-blue-500 text-white" onclick="switchTab('signup')">
                        Inscription
                    </button>
                    <button id="signin-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-600 hover:text-gray-800" onclick="switchTab('signin')">
                        Connexion
                    </button>
                </div>

                <!-- Formulaire d'inscription -->
                <form id="signup-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="signup-prenom" placeholder="Prénom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                        <input type="text" id="signup-nom" placeholder="Nom" required 
                               class="px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    </div>
                    <input type="email" id="signup-email" placeholder="Email (pour vous connecter)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <div class="relative">
                        <select id="country-code" class="absolute left-3 top-3 bg-transparent border-none text-sm font-medium text-gray-700 focus:outline-none z-10">
                            <option value="+221">🇸🇳 +221</option>
                            <option value="+33">🇫🇷 +33</option>
                            <option value="+1">🇺🇸 +1</option>
                        </select>
                        <input type="text" id="signup-telephone" placeholder="77 123 45 67" required 
                               inputmode="tel"
                               class="w-full px-20 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    </div>
                    <input type="text" id="signup-ticket" placeholder="N° de facture (ex: S01032 ou 00000-003-0012)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                           pattern="^(S\d{5}|\d{5}-\d{3}-\d{4})$"
                           title="Format requis: S suivi de 5 chiffres (ex: S01032) ou format 00000-003-0012">
                    <input type="password" id="signup-password" placeholder="Mot de passe (min. 6 caractères)" required 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <!-- Code de parrainage optionnel -->
                    <input type="text" id="signup-referral" placeholder="Code de parrainage (optionnel)" 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm"
                           maxlength="10">
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="signup-terms" required class="rounded border-gray-300 text-blue-600">
                        <label for="signup-terms" class="text-xs text-gray-700">
                            J'accepte les conditions et de recevoir les offres exclusives
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="stay-connected" class="rounded border-gray-300 text-blue-600">
                        <label for="stay-connected" class="text-xs text-gray-700">
                            Rester connecté sur cet appareil
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 card-shine">
                        🎁 Je m'inscris et je reçois mon bonus !
                    </button>
                </form>

                <!-- Formulaire de connexion -->
                <form id="signin-form" class="space-y-4 hidden">
                    <input type="email" id="signin-email" placeholder="Email" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    <input type="password" id="signin-password" placeholder="Mot de passe" required 
                           class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm">
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="signin-stay-connected" class="rounded border-gray-300 text-blue-600">
                        <label for="signin-stay-connected" class="text-xs text-gray-700">
                            Rester connecté sur cet appareil
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                        🔑 Me connecter à mon compte
                    </button>
                </form>
                
                <div id="auth-message" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- ÉCRAN DE CONFIRMATION D'INSCRIPTION -->
    <div id="confirmation-screen" class="hidden min-h-screen p-6">
        <div class="max-w-md mx-auto space-y-6 pt-8">
            <!-- Animation de succès -->
            <div class="text-center space-y-4 fade-in">
                <div class="text-8xl mb-4">🎉</div>
                <h2 class="text-3xl font-black text-white">Félicitations !</h2>
                <p class="text-xl text-white/90 font-semibold">
                    Votre inscription au Club Avantage CE est confirmée !
                </p>
            </div>

            <!-- Carte d'ID membre -->
            <div class="glass-effect rounded-2xl p-6 card-shine">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #22a8dc;">🏆 Votre Carte Membre Officielle</h3>
                    
                    <!-- Numéro de membre -->
                    <div class="bg-blue-600 rounded-2xl p-6 text-white mb-6">
                        <p class="text-lg font-semibold mb-2">Votre Numéro de Membre Officiel :</p>
                        <div class="text-4xl font-black tracking-widest" id="confirmation-member-id">CE-0000</div>
                        <p class="text-sm mt-2 opacity-90">Conservez-le précieusement et présentez-le en magasin.</p>
                    </div>

                    <!-- Informations membre -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
                        <h4 class="font-bold text-lg" id="confirmation-name">Membre CE</h4>
                        <p class="text-sm opacity-90">Niveau Bronze • 50 points de bienvenue</p>
                    </div>
                </div>
            </div>

            <!-- Avantages immédiats -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4" style="color: #22a8dc;">🎁 Vos Avantages Immédiats</h3>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                        <div class="bg-green-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">50 points de bienvenue</p>
                            <p class="text-sm text-gray-600">Déjà crédités sur votre compte</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">Réduction de 5% disponible</p>
                            <p class="text-sm text-gray-600">Utilisable dès maintenant en magasin</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 bg-purple-50 rounded-lg">
                        <div class="bg-purple-500 rounded-full p-2">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">Carte de fidélité virtuelle</p>
                            <p class="text-sm text-gray-600">Accessible depuis votre espace membre</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4" style="color: #1e3a8a;">📋 Prochaines Étapes</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">1</div>
                        <p class="text-gray-700">Notez votre numéro de membre <strong id="confirmation-member-id-copy">CE-0000</strong> dans un endroit sûr</p>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">2</div>
                        <p class="text-gray-700">Accédez à votre espace membre pour générer votre QR Code de réduction</p>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs">3</div>
                        <p class="text-gray-700">Présentez votre QR Code en caisse pour bénéficier de vos avantages</p>
                    </div>
                </div>
            </div>

            <!-- Bouton d'accès à l'espace membre -->
            <button onclick="goToMemberArea()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 card-shine">
                🚀 Accéder à mon Espace Membre
            </button>
        </div>
    </div>

    <!-- ÉCRAN DE LA CARTE MEMBRE -->
    <div id="card-screen" class="hidden min-h-screen p-6">
        
    <!-- PAGE DES RÉCOMPENSES -->
    <div id="rewards-page" class="hidden fixed inset-0 z-50" style="background-image: linear-gradient(rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.9)), url('https://cdn.pixabay.com/photo/2014/11/27/22/44/gift-548290_1280.jpg'); background-size: cover; background-position: center; background-attachment: fixed;">
        <div class="min-h-screen p-6">
            <!-- Header avec bouton retour -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="hideRewardsPage()" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H19V7z"/>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-white">🎁 Catalogue de Récompenses</h1>
                <button onclick="hideRewardsPage()" class="bg-white hover:bg-gray-100 text-gray-800 px-4 py-2 rounded-full font-semibold transition-all text-sm">
                    🏠 Accueil
                </button>
            </div>

            <!-- Solde de points en haut -->
            <div class="max-w-md mx-auto mb-6">
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 text-center">
                    <p class="text-white/80 text-sm mb-1">Vos points disponibles</p>
                    <div class="text-3xl font-black text-yellow-300" id="rewards-points-balance">0</div>
                </div>
            </div>

            <div class="max-w-md mx-auto space-y-4" id="rewards-container">
                <!-- Les récompenses seront chargées ici -->
                <div class="text-center py-8">
                    <div class="loading-spinner w-12 h-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-white">Chargement des récompenses...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE CARTE COMPLÈTE -->
    <div id="full-card-page" class="hidden fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 z-50">
        <div class="min-h-screen p-6">
            <!-- Header avec bouton retour -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="hideCardPage()" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H19V7z"/>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-white">Ma Carte Membre</h1>
                <button onclick="hideCardPage()" class="bg-white hover:bg-gray-100 text-gray-800 px-4 py-2 rounded-full font-semibold transition-all text-sm">
                    🏠 Accueil
                </button>
            </div>

            <div class="max-w-md mx-auto space-y-6">
                <!-- Carte membre grande -->
                <div class="relative rounded-3xl p-8 shadow-2xl overflow-hidden" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.5)), url('https://cdn.pixabay.com/photo/2020/06/10/13/30/food-5282718_1280.jpg'); background-size: cover; background-position: center;">
                    <div class="text-center space-y-6 relative z-10">
                        <!-- Logo et titre -->
                        <div class="flex items-center justify-center space-x-3 mb-6">
                            <svg class="w-10 h-10 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Club Avantage CE</h2>
                        </div>
                        
                        <!-- Informations membre -->
                        <div class="space-y-3">
                            <h3 class="text-2xl font-bold text-white" id="card-member-name">Membre CE</h3>
                            <p class="text-lg text-yellow-300 font-semibold" id="card-member-id">CE-0000</p>
                            <div class="flex justify-between items-center bg-white/20 backdrop-blur-sm rounded-xl p-4">
                                <div>
                                    <p class="text-sm text-white/80">Niveau</p>
                                    <p class="font-bold text-yellow-300" id="card-member-tier">Bronze</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-white/80">Points</p>
                                    <p class="font-bold text-yellow-300 text-xl" id="card-member-points">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QR Code grand -->
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <div class="text-center space-y-6">
                        <h3 class="text-2xl font-bold text-gray-800">Votre QR Code</h3>
                        <p class="text-gray-600">Présentez ce code en caisse</p>
                        
                        <div id="large-qrcode-container" class="flex justify-center">
                            <div class="bg-gray-100 rounded-2xl p-4">
                                <div class="text-center p-8">
                                    <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                                    <p class="text-gray-600">Génération du QR Code...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-sm text-blue-800 font-medium">
                                🔒 Ce code est unique et personnel. Ne le partagez pas.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3">
                    <button onclick="refreshQRCode()" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-6 rounded-xl transition-all">
                        🔄 Actualiser le QR Code
                    </button>
                    
                    <button onclick="shareCard()" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-6 rounded-xl transition-all">
                        📤 Partager ma carte
                    </button>
                </div>
            </div>
        </div>
    </div>
        <div class="max-w-md mx-auto space-y-6 pt-4">
            <!-- Carte de membre virtuelle -->
            <div class="glass-effect rounded-2xl p-6 card-shine">
                <div class="text-center space-y-4">
                    <div class="flex items-center justify-center space-x-2 mb-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <h2 class="text-2xl font-bold" style="color: #1e3a8a;">Carte Membre VIP</h2>
                        <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                        </svg>
                    </div>
                    
                    <div id="member-card-bg" class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 text-white relative overflow-hidden" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://atlas-content-cdn.pixelsquid.com/stock-images/bronze-icon-trophy-cup-logo-YeemkE0-600.jpg'); background-size: cover; background-position: center;">
                        <div class="relative z-10">
                            <h3 class="text-lg font-bold" id="member-name">Membre CE</h3>
                            <p class="text-sm opacity-90" id="member-email">email@example.com</p>
                            <p class="text-xs opacity-75 mt-1">N° Membre: <span class="font-bold" id="member-id-display">CE-0000</span></p>
                            <div class="mt-3 flex justify-between items-center">
                                <div>
                                    <p class="text-xs opacity-75">Niveau</p>
                                    <p class="font-bold" id="member-tier">Bronze</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs opacity-75">Membre depuis</p>
                                    <p class="font-bold text-sm" id="member-since">2024</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Texte explicatif avec animation -->
            <div class="glass-effect rounded-2xl p-4 mb-4">
                <div class="text-center space-y-2">
                    <p class="text-sm text-gray-700">
                        💳 Votre carte de fidélité virtuelle avec QR Code
                    </p>
                    <p class="text-xs text-blue-600 font-semibold animate-pulse">
                        ✨ Présentez-la en caisse pour vos avantages ✨
                    </p>
                </div>
            </div>

            <!-- Bouton Ma Carte -->
            <div class="glass-effect rounded-2xl p-4">
                <button onclick="showCardPage()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center space-x-3">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                    </svg>
                    <span class="text-xl">📱 Ma Carte Membre</span>
                </button>
            </div>

            <!-- Section Flash Alertes / Promos -->
            <div class="glass-effect rounded-2xl p-6 mb-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #1e3a8a;">⚡ Flash Alertes / Promos</h3>
                    <div id="flash-promos-container" class="space-y-3">
                        <!-- Les promos seront chargées ici -->
                        <div class="text-center py-4">
                            <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                            <p class="text-sm text-gray-600">Chargement des promos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solde de points -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #1e3a8a;">💰 Vos Points</h3>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-6 text-white">
                        <div class="text-4xl font-black points-counter" id="points-balance">0</div>
                        <p class="text-sm opacity-90 mt-1">Points disponibles</p>
                    </div>
                    
                    <!-- Barre de progression niveau -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm font-semibold text-gray-600">
                            <span>Niveau: <span id="current-level">Bronze</span></span>
                            <span>Prochain: <span id="next-level">Argent</span></span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-yellow-500 h-full rounded-full transition-all duration-1000" 
                                 id="level-progress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-600 text-center" id="points-to-next">50 points pour le niveau suivant</p>
                    </div>
                </div>
            </div>



            <!-- Catalogue de Récompenses -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #1e3a8a;">🎁 Catalogue de Récompenses</h3>
                    <p class="text-sm text-gray-600">Échangez vos points contre des récompenses exclusives !</p>
                    
                    <button onclick="showRewardsPage()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center space-x-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                        </svg>
                        <span>🛍️ Voir les Récompenses</span>
                    </button>
                </div>
            </div>

            <!-- Section Parrainage -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-bold" style="color: #1e3a8a;">🎁 Parrainez vos amis</h3>
                    <p class="text-sm text-gray-600">Invitez un ami et gagnez 50 points chacun !</p>
                    
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl p-4 text-white">
                        <p class="text-sm font-medium mb-2">Votre code de parrainage :</p>
                        <div class="text-2xl font-black tracking-widest" id="referral-code-display">LOADING...</div>
                    </div>
                    
                    <button onclick="shareReferralCode()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 px-6 rounded-xl hover:from-green-600 hover:to-green-700 transition-all">
                        📤 Partager mon code
                    </button>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="space-y-3">
                <button onclick="refreshData()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all">
                    🔄 Actualiser mes données
                </button>
                
                <button onclick="shareApp()" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all">
                    👥 Partager l'application
                </button>
            </div>

            <!-- Historique récent -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4" style="color: #1e3a8a;">📊 Activité Récente</h3>
                <div id="recent-activity" class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium">Inscription</span>
                        </div>
                        <span class="text-sm text-gray-600">+50 pts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutons Scroll vers le haut -->
    <button id="scroll-to-top-auth" class="scroll-to-top hidden" onclick="scrollToTop('auth-screen')" title="Retour en haut">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>
    
    <button id="scroll-to-top-card" class="scroll-to-top hidden" onclick="scrollToTop('card-screen')" title="Retour en haut">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>
    
    <button id="scroll-to-top-rewards" class="scroll-to-top hidden" onclick="scrollToTop('rewards-page')" title="Retour en haut">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>
    
    <button id="scroll-to-top-full-card" class="scroll-to-top hidden" onclick="scrollToTop('full-card-page')" title="Retour en haut">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDFuZRS1M_ATwTRxsbW8Jlv0m7H9dnjxjY",
            authDomain: "clubavantage-52aed.firebaseapp.com",
            projectId: "clubavantage-52aed",
            storageBucket: "clubavantage-52aed.appspot.com",
            messagingSenderId: "655040433691",
            appId: "1:655040433691:web:e3492b4fb64333ff01b2be",
            measurementId: "G-Y0187YGWCT"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentUser = null;
        let userDataListener = null;

        // Point d'entrée unique - Attendre que le DOM soit chargé
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM chargé, initialisation de l\'application...');
            
            try {
                // Afficher l'écran de chargement
                showLoadingScreen();
                
                // Attacher les événements
                attachEventListeners();
                
                // Initialiser les boutons de scroll
                initScrollButtons();
                
                // Démarrer l'écouteur d'authentification Firebase
                console.log('🔥 Démarrage de l\'écouteur Firebase...');
                startAuthListener();
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
                hideLoadingScreen();
                showMessage('Erreur de chargement. Veuillez actualiser la page.', 'error');
            }
        });

        // Fonction pour attacher tous les événements
        function attachEventListeners() {
            console.log('🔗 Attachement des événements...');
            
            // Formulaires
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('✅ Événement inscription attaché');
            }
            
            if (signinForm) {
                signinForm.addEventListener('submit', handleSignin);
                console.log('✅ Événement connexion attaché');
            }
            
            // Boutons de déconnexion
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
                console.log('✅ Événement déconnexion desktop attaché');
            }
            
            const logoutBtnMobile = document.getElementById('logout-btn-mobile');
            if (logoutBtnMobile) {
                logoutBtnMobile.addEventListener('click', logout);
                console.log('✅ Événement déconnexion mobile attaché');
            }
            
            // Menu burger mobile
            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', openSidebar);
                console.log('✅ Événement menu burger attaché');
            }
            
            // Fermer sidebar
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', closeSidebar);
                console.log('✅ Événement fermeture sidebar attaché');
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', closeSidebar);
                console.log('✅ Événement overlay sidebar attaché');
            }
            
            // Menu dropdown desktop
            const desktopMenuToggle = document.getElementById('desktop-menu-toggle');
            if (desktopMenuToggle) {
                desktopMenuToggle.addEventListener('click', toggleDesktopDropdown);
                console.log('✅ Événement menu dropdown desktop attaché');
            }
            
            // Fermer dropdown en cliquant ailleurs
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('desktop-dropdown');
                const menuToggle = document.getElementById('desktop-menu-toggle');
                
                if (dropdown && menuToggle && !menuToggle.contains(e.target) && !dropdown.contains(e.target)) {
                    closeDesktopDropdown();
                }
            });
            
            // Formatage du téléphone
            const phoneInput = document.getElementById('signup-telephone');
            const countrySelect = document.getElementById('country-code');
            if (phoneInput) {
                phoneInput.addEventListener('input', formatPhoneNumber);
                console.log('✅ Formatage téléphone attaché');
            }
            if (countrySelect) {
                countrySelect.addEventListener('change', updatePhonePlaceholder);
                console.log('✅ Sélecteur pays attaché');
            }
            
            // Formatage des tickets
            const signupTicket = document.getElementById('signup-ticket');
            const newTicket = document.getElementById('new-ticket-number');
            
            if (signupTicket) {
                signupTicket.addEventListener('input', formatTicketInput);
            }
            if (newTicket) {
                newTicket.addEventListener('input', formatTicketInput);
            }
        }

        // Écouteur d'état d'authentification - Optimisé
        function startAuthListener() {
            auth.onAuthStateChanged((user) => {
                console.log('🔐 Changement d\'état d\'authentification:', user ? 'Utilisateur connecté' : 'Utilisateur déconnecté');
                
                // Masquer l'écran de chargement dans tous les cas
                hideLoadingScreen();
                
                if (user) {
                    console.log('👤 Utilisateur connecté:', user.email);
                    currentUser = user;
                    
                    // Séquence d'affichage pour utilisateur connecté
                    showCardScreen();
                    showLogoutButton();
                    loadUserData(user);
                    
                } else {
                    console.log('👋 Aucun utilisateur connecté');
                    currentUser = null;
                    
                    // Nettoyer les données utilisateur
                    if (userDataListener) {
                        userDataListener();
                        userDataListener = null;
                    }
                    
                    // Séquence d'affichage pour utilisateur déconnecté
                    showAuthScreen();
                    hideLogoutButton();
                }
            });
        }

        // Fonctions d'affichage/masquage du bouton de déconnexion
        function showLogoutButton() {
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnMobile = document.getElementById('logout-btn-mobile');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
                console.log('✅ Bouton de déconnexion desktop affiché');
            }
            if (logoutBtnMobile) {
                logoutBtnMobile.style.display = 'flex';
                console.log('✅ Bouton de déconnexion mobile affiché');
            }
        }

        function hideLogoutButton() {
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnMobile = document.getElementById('logout-btn-mobile');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
                console.log('✅ Bouton de déconnexion desktop masqué');
            }
            if (logoutBtnMobile) {
                logoutBtnMobile.style.display = 'none';
                console.log('✅ Bouton de déconnexion mobile masqué');
            }
        }

        // Fonctions pour le menu latéral mobile
        function openSidebar() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Mettre à jour les informations du sidebar
                updateSidebarInfo();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }

        function updateSidebarInfo() {
            // Mettre à jour le nom dans le sidebar
            const sidebarName = document.getElementById('sidebar-member-name');
            const memberName = document.getElementById('member-name');
            if (sidebarName && memberName) {
                sidebarName.textContent = memberName.textContent || 'Membre CE';
            }
            
            // Mettre à jour les points dans le sidebar
            const sidebarPoints = document.getElementById('sidebar-points');
            const pointsBalance = document.getElementById('points-balance');
            if (sidebarPoints && pointsBalance) {
                sidebarPoints.textContent = pointsBalance.textContent || '0';
            }
        }

        // Fonctions pour le menu dropdown desktop
        function toggleDesktopDropdown() {
            const dropdown = document.getElementById('desktop-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }

        function closeDesktopDropdown() {
            const dropdown = document.getElementById('desktop-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        // Gestion des onglets
        function switchTab(tab) {
            const signupTab = document.getElementById('signup-tab');
            const signinTab = document.getElementById('signin-tab');
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            
            if (tab === 'signup') {
                signupTab.classList.add('bg-blue-500', 'text-white');
                signupTab.classList.remove('text-gray-600');
                signinTab.classList.remove('bg-blue-500', 'text-white');
                signinTab.classList.add('text-gray-600');
                signupForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
            } else {
                signinTab.classList.add('bg-blue-500', 'text-white');
                signinTab.classList.remove('text-gray-600');
                signupTab.classList.remove('bg-blue-500', 'text-white');
                signupTab.classList.add('text-gray-600');
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            }
        }

        // Fonction d'inscription avec ID membre séquentiel corrigé
        async function handleSignup(e) {
            e.preventDefault();
            
            const prenom = document.getElementById('signup-prenom').value.trim();
            const nom = document.getElementById('signup-nom').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('signup-telephone').value.trim().replace(/\s/g, '');
            const telephone = countryCode + phoneNumber;
            const ticketNumber = document.getElementById('signup-ticket').value.trim();
            const referralCode = document.getElementById('signup-referral').value.trim().toUpperCase();
            const password = document.getElementById('signup-password').value;
            const terms = document.getElementById('signup-terms').checked;
            const stayConnected = document.getElementById('stay-connected').checked;
            
            if (!terms) {
                showAuthMessage('Veuillez accepter les conditions.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Le mot de passe doit contenir au moins 6 caractères.', 'error');
                return;
            }
            
            // Validation du téléphone
            const telephoneSansEspaces = phoneNumber.replace(/\s/g, ''); 
            if (countryCode === '+221') {
                const senegalPhoneFormat = /^(70|75|76|77|78)\d{7}$/;
                if (!senegalPhoneFormat.test(telephoneSansEspaces)) {
                    showAuthMessage('Format du téléphone invalide. Ex: 77 123 45 67', 'error');
                    return;
                }
            } else if (countryCode === '+33') {
                const frenchPhoneFormat = /^0[1-9]\d{8}$/;
                if (!frenchPhoneFormat.test(telephoneSansEspaces)) {
                    showAuthMessage('Format téléphone français invalide. Doit commencer par 0 et avoir 10 chiffres (ex: 01 23 45 67 89)', 'error');
                    return;
                }
            } else {
                if (!/^\d{7,15}$/.test(telephoneSansEspaces)) {
                    showAuthMessage('Format téléphone invalide. Entre 7 et 15 chiffres requis.', 'error');
                    return;
                }
            }
            
            // Validation du ticket
            const formatS = /^S\d{5}$/i;
            const formatLong = /^\d{5}-\d{3}-\d{4}$/;
            if (!formatS.test(ticketNumber) && !formatLong.test(ticketNumber)) {
                showAuthMessage('Format du N° de facture invalide. Ex: S01234 ou 00000-003-0012', 'error');
                return;
            }
            
            // Vérifier si le ticket existe déjà
            const ticketExists = await checkTicketExists(ticketNumber);
            if (ticketExists) {
                showAuthMessage('Ce numéro de facture a déjà été utilisé.', 'error');
                return;
            }

            try {
                showAuthMessage('Création de votre compte...', 'info');
                
                // 1. Créer le compte d'authentification
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await user.updateProfile({ displayName: `${prenom} ${nom}` });

                // 2. Transaction pour obtenir un ID membre séquentiel
                const counterRef = db.collection('counters').doc('memberCounter');
                let newMemberId;

                await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newIdNumber;
                    
                    if (!counterDoc.exists) {
                        // Si le compteur n'existe pas, on le crée à 1
                        newIdNumber = 1;
                        transaction.set(counterRef, { lastId: newIdNumber });
                    } else {
                        // Incrémenter le compteur existant
                        newIdNumber = (counterDoc.data().lastId || 0) + 1;
                        transaction.update(counterRef, { lastId: newIdNumber });
                    }
                    
                    // Formater le numéro en chaîne de 4 chiffres
                    const formattedId = String(newIdNumber).padStart(4, '0');
                    newMemberId = `CE-${formattedId}`;
                    
                    console.log('✅ Nouvel ID membre généré:', newMemberId);
                });

                // 3. Générer un code de parrainage unique format CLUBCE + 2 chiffres
                const generateReferralCode = (memberId) => {
                    // Extraire les 2 derniers chiffres de l'ID membre
                    const memberNumber = memberId.replace('CE-', '');
                    const lastTwoDigits = memberNumber.slice(-2);
                    return `CLUBCE${lastTwoDigits}`;
                };
                
                const userReferralCode = generateReferralCode(newMemberId);
                
                // 4. Vérifier et traiter le code de parrainage si fourni
                let bonusPoints = 50; // Points de base
                let referredBy = null;
                
                if (referralCode && referralCode.length > 0) {
                    try {
                        // Chercher l'utilisateur qui a ce code de parrainage
                        const referrerQuery = await db.collection('users')
                            .where('referralCode', '==', referralCode)
                            .limit(1)
                            .get();
                        
                        if (!referrerQuery.empty) {
                            const referrerDoc = referrerQuery.docs[0];
                            const referrerId = referrerDoc.id;
                            referredBy = referrerId;
                            bonusPoints = 100; // 50 de base + 50 de parrainage
                            
                            // Créditer 50 points au parrain
                            await db.collection('users').doc(referrerId).update({
                                points: firebase.firestore.FieldValue.increment(50)
                            });
                            
                            // Ajouter à l'historique du parrain
                            await db.collection('users').doc(referrerId).collection('history').add({
                                type: 'parrainage',
                                description: `Parrainage de ${prenom} ${nom}`,
                                points: 50,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log('✅ Parrainage traité avec succès');
                        } else {
                            console.log('⚠️ Code de parrainage invalide:', referralCode);
                        }
                    } catch (error) {
                        console.error('❌ Erreur traitement parrainage:', error);
                    }
                }

                // 5. Créer le profil utilisateur avec le nouvel ID
                const userProfile = {
                    memberId: newMemberId,
                    prenom: prenom,
                    nom: nom,
                    email: email,
                    telephone: telephone,
                    points: bonusPoints,
                    lastTicket: ticketNumber,
                    tier: 'Bronze',
                    referralCode: userReferralCode,
                    referredBy: referredBy,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    qrCodeExpiry: null,
                    lastQRGeneration: null
                };
                await db.collection('users').doc(user.uid).set(userProfile);

                // 6. Gérer la persistance de la connexion
                if (stayConnected) {
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } else {
                    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                }

                // 7. Enregistrer le ticket comme utilisé
                await db.collection('usedTickets').doc(ticketNumber).set({
                    userId: user.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'inscription'
                });
                
                // 8. Ajouter à l'historique
                const historyEntries = [{
                    type: 'inscription',
                    description: 'Bienvenue au Club Avantage !',
                    points: 50,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }];
                
                // Ajouter l'entrée de parrainage si applicable
                if (referredBy) {
                    historyEntries.push({
                        type: 'parrainage',
                        description: 'Bonus de parrainage reçu',
                        points: 50,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Ajouter toutes les entrées d'historique
                const batch = db.batch();
                historyEntries.forEach(entry => {
                    const historyRef = db.collection('users').doc(user.uid).collection('history').doc();
                    batch.set(historyRef, entry);
                });
                await batch.commit();

                // 6. Afficher la confirmation avec les bonnes données
                showConfirmationPage(prenom, nom, newMemberId);

            } catch (error) {
                console.error("Erreur d'inscription:", error);
                let message = 'Erreur lors de l\'inscription.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Cette adresse email est déjà utilisée.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Le mot de passe est trop faible.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Adresse email invalide.';
                } else if (error.message) {
                    message = error.message;
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Fonction de connexion
        async function handleSignin(e) {
            e.preventDefault();
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            const stayConnected = document.getElementById('signin-stay-connected').checked;
            
            // Validation côté client
            if (!email) {
                showAuthMessage('Veuillez saisir votre adresse email.', 'error');
                return;
            }
            
            if (!password) {
                showAuthMessage('Veuillez saisir votre mot de passe.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Le mot de passe doit contenir au moins 6 caractères.', 'error');
                return;
            }
            
            try {
                showAuthMessage('Connexion en cours...', 'info');
                console.log('🔐 Tentative de connexion pour:', email);
                
                // Gérer la persistance avant la connexion
                if (stayConnected) {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } else {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                }
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('✅ Connexion réussie pour:', userCredential.user.email);
                
                // Mettre à jour la dernière activité
                try {
                    await db.collection('users').doc(userCredential.user.uid).update({
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('✅ Dernière activité mise à jour');
                } catch (updateError) {
                    console.warn('⚠️ Erreur mise à jour activité (non bloquant):', updateError);
                }
                
                showAuthMessage('Connexion réussie ! Redirection...', 'success');
                
            } catch (error) {
                console.error('❌ Erreur connexion détaillée:', error);
                console.error('❌ Code d\'erreur:', error.code);
                console.error('❌ Message d\'erreur:', error.message);
                
                let message = 'Erreur lors de la connexion.';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        message = 'Aucun compte trouvé avec cette adresse email. Vérifiez votre email ou inscrivez-vous.';
                        break;
                    case 'auth/wrong-password':
                        message = 'Mot de passe incorrect. Vérifiez votre mot de passe.';
                        break;
                    case 'auth/invalid-email':
                        message = 'Format d\'adresse email invalide.';
                        break;
                    case 'auth/user-disabled':
                        message = 'Ce compte a été désactivé. Contactez le support.';
                        break;
                    case 'auth/too-many-requests':
                        message = 'Trop de tentatives de connexion. Attendez quelques minutes avant de réessayer.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Erreur de connexion réseau. Vérifiez votre connexion internet.';
                        break;
                    case 'auth/invalid-credential':
                        message = 'Email ou mot de passe incorrect. Vérifiez vos informations.';
                        break;
                    default:
                        message = `Erreur de connexion: ${error.message}`;
                        break;
                }
                
                showAuthMessage(message, 'error');
            }
        }

        // Charger les données utilisateur - Version optimisée
        async function loadUserData(user) {
            if (!user) {
                console.error('❌ Aucun utilisateur fourni pour loadUserData');
                return;
            }
            
            console.log('📊 Chargement des données utilisateur pour:', user.email);
            
            // Nettoyer l'ancien écouteur s'il existe
            if (userDataListener) {
                userDataListener();
                userDataListener = null;
            }
            
            try {
                // D'abord, essayer de lire le document une seule fois pour tester les permissions
                console.log('🔍 Test de lecture du document utilisateur...');
                const docRef = db.collection('users').doc(user.uid);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) {
                    console.log('📝 Document utilisateur inexistant, création en cours...');
                    
                    // Créer le document utilisateur avec ID membre
                    const displayName = user.displayName || 'Membre CE';
                    const nameParts = displayName.split(' ');
                    
                    // Générer un ID membre unique
                    let newMemberId = 'CE-0001'; // Valeur par défaut
                    
                    try {
                        // Transaction pour obtenir un nouvel ID Membre séquentiel
                        const counterRef = db.collection('counters').doc('memberCounter');
                        
                        await db.runTransaction(async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            let newIdNumber;
                            
                            if (!counterDoc.exists) {
                                // Créer le compteur s'il n'existe pas, en commençant à 1
                                newIdNumber = 1;
                                transaction.set(counterRef, { lastId: newIdNumber });
                            } else {
                                // Incrémenter le compteur existant
                                newIdNumber = (counterDoc.data().lastId || 0) + 1;
                                transaction.update(counterRef, { lastId: newIdNumber });
                            }
                            
                            // Formater le numéro en chaîne de 4 chiffres avec des zéros devant (ex: 0001, 0002, 0003)
                            const formattedId = String(newIdNumber).padStart(4, '0');
                            newMemberId = `CE-${formattedId}`;
                        });
                        
                        console.log('✅ Nouvel ID membre généré:', newMemberId);
                        
                    } catch (error) {
                        console.error('❌ Erreur génération ID membre:', error);
                        // Utiliser un ID de fallback basé sur le timestamp
                        const timestamp = Date.now().toString().slice(-4);
                        newMemberId = `CE-${timestamp}`;
                    }
                    
                    // Générer un code de parrainage unique format CLUBCE + 2 chiffres
                    const generateReferralCode = (memberId) => {
                        const memberNumber = memberId.replace('CE-', '');
                        const lastTwoDigits = memberNumber.slice(-2);
                        return `CLUBCE${lastTwoDigits}`;
                    };
                    
                    const userReferralCode = generateReferralCode(newMemberId);
                    
                    const newUserData = {
                        memberId: newMemberId, // ID membre ajouté
                        nom: nameParts[1] || 'CE',
                        prenom: nameParts[0] || 'Membre',
                        email: user.email,
                        telephone: '', // Champ téléphone inclus par défaut
                        points: 50,
                        lastTicket: '',
                        tier: 'Bronze',
                        referralCode: userReferralCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                        qrCodeExpiry: null,
                        lastQRGeneration: null
                    };
                    
                    console.log('💾 Données à sauvegarder:', newUserData);
                    await docRef.set(newUserData);
                    console.log('✅ Document utilisateur créé avec succès avec ID:', newMemberId);
                    
                    // Mettre à jour l'interface avec les nouvelles données immédiatement
                    const immediateData = {
                        ...newUserData,
                        createdAt: new Date(), // Pour l'affichage immédiat
                        memberId: newMemberId // S'assurer que l'ID est présent
                    };
                    updateUserInterface(immediateData);
                    
                    // Ajouter l'événement d'inscription à l'historique
                    try {
                        await docRef.collection('history').add({
                            type: 'inscription',
                            points: 50,
                            description: 'Inscription au Club Avantage CE',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('✅ Historique d\'inscription ajouté');
                    } catch (historyError) {
                        console.error('⚠️ Erreur ajout historique:', historyError);
                        // Ne pas bloquer pour l'historique
                    }
                    
                } else {
                    console.log('✅ Document utilisateur trouvé');
                    const userData = docSnapshot.data();
                    console.log('📊 Données récupérées:', userData);
                    updateUserInterface(userData);
                }
                
                // Maintenant configurer l'écouteur en temps réel
                console.log('👂 Configuration de l\'écouteur temps réel...');
                userDataListener = docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        console.log('🔄 Mise à jour temps réel reçue');
                        const userData = doc.data();
                        updateUserInterface(userData);
                    } else {
                        console.log('⚠️ Document n\'existe plus dans l\'écouteur');
                    }
                }, (error) => {
                    console.error('❌ Erreur écouteur temps réel:', error);
                    // Ne pas afficher d'erreur pour l'écouteur, les données sont déjà chargées
                });
                
                // Charger l'activité récente
                loadRecentActivity();
                
                // Charger les promos flash
                loadFlashPromos();
                
                showMessage('✅ Données chargées avec succès !', 'success');
                
            } catch (error) {
                console.error('❌ ERREUR CRITIQUE lors du chargement des données:', error);
                console.error('❌ Code d\'erreur:', error.code);
                console.error('❌ Message d\'erreur:', error.message);
                
                let errorMessage = 'Erreur de chargement des données';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permissions insuffisantes. Veuillez vous reconnecter.';
                    console.log('🔄 Tentative de reconnexion automatique...');
                    
                    // Essayer de se reconnecter
                    setTimeout(() => {
                        auth.signOut().then(() => {
                            showMessage('Reconnexion nécessaire, veuillez vous connecter à nouveau.', 'info');
                        });
                    }, 2000);
                    
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Service temporairement indisponible. Réessayez dans quelques instants.';
                } else {
                    errorMessage = `Erreur: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
                
                // Afficher des données par défaut pour ne pas laisser l'interface vide
                console.log('🔧 Affichage des données par défaut...');
                const fallbackData = {
                    memberId: 'CE-0000',
                    nom: 'Membre',
                    prenom: 'CE',
                    email: user.email || 'email@example.com',
                    points: 0,
                    tier: 'Bronze',
                    createdAt: new Date()
                };
                updateUserInterface(fallbackData);
            }
        }

        // Mettre à jour l'interface utilisateur
        function updateUserInterface(userData) {
            console.log('🎨 Mise à jour de l\'interface avec:', userData);
            
            // Nom complet avec numéro de membre - Forcer l'affichage du nom réel
            let displayName = '';
            
            // Priorité absolue au nom complet depuis les données Firestore
            if (userData.prenom && userData.nom) {
                displayName = `${userData.prenom} ${userData.nom}`;
            } 
            // Sinon utiliser displayName de Firebase Auth
            else if (currentUser && currentUser.displayName) {
                displayName = currentUser.displayName;
            } 
            // Fallback avec email mais extraire un nom plus lisible
            else if (userData.email) {
                const emailPart = userData.email.split('@')[0];
                // Capitaliser la première lettre et remplacer les points/underscores par des espaces
                displayName = emailPart.replace(/[._]/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
            }
            // Dernier fallback - mais essayer de récupérer depuis le profil utilisateur
            else {
                displayName = 'Membre CE';
                
                // Essayer de récupérer le nom depuis le profil Firebase Auth
                if (currentUser && currentUser.email) {
                    const emailName = currentUser.email.split('@')[0];
                    if (emailName && emailName !== 'user' && emailName.length > 2) {
                        displayName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
                    }
                }
            }
            
            console.log('✅ Nom calculé:', displayName);
            
            // Mettre à jour TOUS les éléments de nom
            const memberNameElements = [
                'member-name',
                'card-member-name', 
                'confirmation-name'
            ];
            
            memberNameElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = displayName;
                    console.log(`✅ Nom mis à jour pour ${elementId}:`, displayName);
                }
            });
            
            // Afficher le numéro de membre séparément s'il existe
            const memberIdDisplay = document.getElementById('member-id-display');
            if (memberIdDisplay && userData.memberId) {
                memberIdDisplay.textContent = userData.memberId;
            }
            
            // Email
            const memberEmail = document.getElementById('member-email');
            if (memberEmail) {
                memberEmail.textContent = userData.email || (currentUser ? currentUser.email : 'email@example.com');
            }
            
            // Niveau/Tier avec mise à jour de l'image de fond
            const memberTier = document.getElementById('member-tier');
            if (memberTier) {
                const tier = userData.tier || 'Bronze';
                memberTier.textContent = tier;
                
                // Mettre à jour l'image de fond de la carte selon le niveau
                const memberCardBg = document.getElementById('member-card-bg');
                if (memberCardBg) {
                    let backgroundImage = '';
                    let gradientColor = '';
                    
                    switch(tier) {
                        case 'Bronze':
                            backgroundImage = 'https://atlas-content-cdn.pixelsquid.com/stock-images/bronze-icon-trophy-cup-logo-YeemkE0-600.jpg';
                            gradientColor = 'from-amber-700 to-amber-800';
                            break;
                        case 'Argent':
                        case 'Silver':
                            backgroundImage = 'https://elements-resized.envatousercontent.com/elements-cover-images/8e2e9767-5fe7-4cb5-8de7-12ac5737035d?w=433&cf_fit=scale-down&q=85&format=auto&s=dccd6a8bf3bd8b92eb6ac512dc788b6a3cdfc6db4f4556c2ce06249eadcb8df2';
                            gradientColor = 'from-gray-400 to-gray-600';
                            break;
                        case 'Or':
                        case 'Gold':
                            backgroundImage = 'https://atlas-content-cdn.pixelsquid.com/stock-images/bronze-icon-trophy-cup-logo-YeemkE0-600.jpg';
                            gradientColor = 'from-yellow-500 to-yellow-700';
                            break;
                        default:
                            backgroundImage = 'https://atlas-content-cdn.pixelsquid.com/stock-images/bronze-icon-trophy-cup-logo-YeemkE0-600.jpg';
                            gradientColor = 'from-blue-600 to-blue-700';
                    }
                    
                    memberCardBg.className = `bg-gradient-to-r ${gradientColor} rounded-xl p-4 text-white relative overflow-hidden`;
                    memberCardBg.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${backgroundImage}')`;
                    memberCardBg.style.backgroundSize = 'cover';
                    memberCardBg.style.backgroundPosition = 'center';
                }
            }
            
            // Date d'inscription
            const memberSince = document.getElementById('member-since');
            if (memberSince) {
                let dateText = '';
                
                if (userData.createdAt) {
                    try {
                        // Si c'est un timestamp Firestore
                        if (userData.createdAt.toDate) {
                            const date = userData.createdAt.toDate();
                            dateText = date.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                        // Si c'est déjà un objet Date
                        else if (userData.createdAt instanceof Date) {
                            dateText = userData.createdAt.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                        // Si c'est une chaîne de date
                        else if (typeof userData.createdAt === 'string') {
                            const date = new Date(userData.createdAt);
                            dateText = date.toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    } catch (error) {
                        console.error('❌ Erreur conversion date:', error);
                        dateText = new Date().toLocaleDateString('fr-FR', { 
                            year: 'numeric', 
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                } else {
                    // Fallback pour les nouveaux comptes
                    dateText = new Date().toLocaleDateString('fr-FR', { 
                        year: 'numeric', 
                        month: 'short',
                        day: 'numeric'
                    });
                }
                
                memberSince.textContent = dateText;
            }
            
            // Points avec animation
            const pointsBalance = document.getElementById('points-balance');
            if (pointsBalance) {
                const currentPoints = parseInt(pointsBalance.textContent) || 0;
                const newPoints = parseInt(userData.points) || 0;
                
                if (currentPoints !== newPoints) {
                    animateNumber('points-balance', currentPoints, newPoints, 1000);
                } else {
                    pointsBalance.textContent = newPoints;
                }
            }
            
            // Niveau actuel
            const currentLevel = document.getElementById('current-level');
            if (currentLevel) {
                currentLevel.textContent = userData.tier || 'Bronze';
            }
            
            // Code de parrainage - Générer s'il n'existe pas
            const referralCodeDisplay = document.getElementById('referral-code-display');
            if (referralCodeDisplay) {
                if (userData.referralCode) {
                    referralCodeDisplay.textContent = userData.referralCode;
                } else if (userData.memberId && userData.memberId !== 'CE-0000') {
                    // Générer le code de parrainage à partir de l'ID membre
                    const memberNumber = userData.memberId.replace('CE-', '');
                    const lastTwoDigits = memberNumber.slice(-2);
                    const generatedCode = `CLUBCE${lastTwoDigits}`;
                    referralCodeDisplay.textContent = generatedCode;
                    
                    // Sauvegarder le code généré dans Firestore
                    if (currentUser) {
                        db.collection('users').doc(currentUser.uid).update({
                            referralCode: generatedCode
                        }).catch(error => console.error('Erreur sauvegarde code parrainage:', error));
                    }
                } else {
                    referralCodeDisplay.textContent = 'LOADING...';
                }
            }
            
            // Progression du niveau
            updateLevelProgress(userData.points || 0);
            
            // Mettre à jour le sidebar si ouvert
            updateSidebarInfo();
        }

        // Charger l'activité récente avec gestion des permissions
        async function loadRecentActivity() {
            if (!currentUser) {
                console.log('⚠️ Aucun utilisateur connecté pour charger l\'activité');
                return;
            }
            
            console.log('📊 Chargement de l\'activité récente...');
            
            const activityContainer = document.getElementById('recent-activity');
            if (!activityContainer) {
                console.error('❌ Container d\'activité non trouvé');
                return;
            }
            
            try {
                const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('history')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                activityContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    console.log('📝 Aucune activité trouvée, affichage du message par défaut');
                    activityContainer.innerHTML = `
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm font-medium">Bienvenue dans le Club !</span>
                            </div>
                            <span class="text-sm text-gray-600">+50 pts</span>
                        </div>
                    `;
                } else {
                    console.log('✅ Activités trouvées:', querySnapshot.size);
                    querySnapshot.forEach((doc) => {
                        const activity = doc.data();
                        const activityElement = createActivityElement(activity);
                        activityContainer.appendChild(activityElement);
                    });
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement activité:', error);
                
                // Afficher un message par défaut même en cas d'erreur
                activityContainer.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm font-medium">Membre du Club Avantage CE</span>
                        </div>
                        <span class="text-sm text-gray-600">🎉</span>
                    </div>
                `;
                
                // Ne pas afficher d'erreur à l'utilisateur pour l'historique
                console.log('ℹ️ Historique non disponible, affichage du message par défaut');
            }
        }

        // Créer un élément d'activité avec date
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-50 rounded-lg space-y-1';
            
            const typeColors = {
                'inscription': 'bg-green-500',
                'achat': 'bg-blue-500',
                'bonus': 'bg-yellow-500',
                'reduction': 'bg-purple-500'
            };
            
            const color = typeColors[activity.type] || 'bg-gray-500';
            
            // Formater la date
            let dateText = '';
            if (activity.timestamp) {
                try {
                    const date = activity.timestamp.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
                    dateText = date.toLocaleDateString('fr-FR', { 
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    dateText = 'Date inconnue';
                }
            } else {
                dateText = 'Aujourd\'hui';
            }
            
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 ${color} rounded-full"></div>
                        <span class="text-sm font-medium">${activity.description}</span>
                    </div>
                    <span class="text-sm text-gray-600 font-semibold">${activity.points > 0 ? '+' : ''}${activity.points} pts</span>
                </div>
                <div class="text-xs text-gray-500 ml-4">
                    ${dateText}
                </div>
            `;
            
            return div;
        }

        // Valider le format du ticket
        function validateTicketFormat(ticket) {
            const pattern1 = /^S\d{5}$/; // S suivi de 5 chiffres
            const pattern2 = /^\d{5}-\d{3}-\d{4}$/; // 00000-003-0012
            return pattern1.test(ticket) || pattern2.test(ticket);
        }
        
        // Vérifier si un ticket existe déjà
        async function checkTicketExists(ticketNumber) {
            try {
                const doc = await db.collection('usedTickets').doc(ticketNumber).get();
                return doc.exists;
            } catch (error) {
                console.error('Erreur vérification ticket:', error);
                return false;
            }
        }
        

        
        // Fonctions pour la page carte complète
        function showCardPage() {
            console.log('📱 Affichage de la page carte complète...');
            const fullCardPage = document.getElementById('full-card-page');
            if (fullCardPage) {
                fullCardPage.classList.remove('hidden');
                fullCardPage.style.display = 'block';
                
                // Permettre le défilement dans la page carte
                fullCardPage.style.overflow = 'auto';
                fullCardPage.style.height = '100vh';
                
                // Forcer le scroll en haut de la page carte
                setTimeout(() => {
                    fullCardPage.scrollTop = 0;
                }, 50);
                
                // Bloquer le défilement du body principal
                document.body.style.overflow = 'hidden';
                
                // Mettre à jour les informations de la carte
                setTimeout(() => {
                    updateCardPageData();
                    
                    // Générer le QR Code grand avec un délai pour s'assurer que la page est affichée
                    if (currentUser) {
                        setTimeout(() => {
                            generateLargeQRCode(currentUser.uid);
                        }, 500);
                    }
                }, 100);
            }
        }

        function hideCardPage() {
            console.log('🔙 Fermeture de la page carte...');
            const fullCardPage = document.getElementById('full-card-page');
            if (fullCardPage) {
                fullCardPage.classList.add('hidden');
                fullCardPage.style.display = 'none';
                
                // Restaurer le défilement du body principal
                document.body.style.overflow = 'auto';
            }
        }

        function updateCardPageData() {
            if (!currentUser) return;
            
            // Récupérer les données depuis l'interface principale
            let memberName = document.getElementById('member-name')?.textContent || 'Membre CE';
            const memberId = document.getElementById('member-id-display')?.textContent || 'CE-0000';
            const memberTier = document.getElementById('member-tier')?.textContent || 'Bronze';
            const pointsBalance = document.getElementById('points-balance')?.textContent || '0';
            
            // Si le nom est encore générique, essayer de le récupérer depuis les données utilisateur
            if (memberName === 'Membre CE' && currentUser) {
                // Essayer de récupérer depuis Firebase Auth
                if (currentUser.displayName) {
                    memberName = currentUser.displayName;
                } else if (currentUser.email) {
                    memberName = currentUser.email.split('@')[0];
                }
            }
            
            // Mettre à jour la page carte
            const cardMemberName = document.getElementById('card-member-name');
            const cardMemberId = document.getElementById('card-member-id');
            const cardMemberTier = document.getElementById('card-member-tier');
            const cardMemberPoints = document.getElementById('card-member-points');
            
            if (cardMemberName) cardMemberName.textContent = memberName;
            if (cardMemberId) cardMemberId.textContent = memberId;
            if (cardMemberTier) cardMemberTier.textContent = memberTier;
            if (cardMemberPoints) cardMemberPoints.textContent = pointsBalance;
            
            console.log('✅ Données de la carte mises à jour:', {
                nom: memberName,
                id: memberId,
                niveau: memberTier,
                points: pointsBalance
            });
        }

        function refreshQRCode() {
            if (currentUser) {
                console.log('🔄 Actualisation du QR Code...');
                generateLargeQRCode(currentUser.uid);
            }
        }

        function shareCard() {
            const memberName = document.getElementById('card-member-name')?.textContent || 'Membre CE';
            const memberId = document.getElementById('card-member-id')?.textContent || 'CE-0000';
            
            const shareText = `🎉 Je suis membre du Club Avantage CE !\n\nMon numéro de membre : ${memberId}\n\nRejoignez-moi et bénéficiez d'avantages exclusifs !\n\n${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ma Carte Club Avantage CE',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('📋 Informations de carte copiées !', 'success');
                });
            }
        }

        // Générer le QR Code grand pour la page carte - Version corrigée
        async function generateLargeQRCode(userId, retryCount = 0) {
            console.log('🔄 Génération du QR Code grand pour userId:', userId);
            const qrcodeDiv = document.getElementById('large-qrcode-container');
            if (!qrcodeDiv) {
                console.error('❌ Container QR Code grand non trouvé');
                return;
            }
            
            // Afficher un message de chargement
            qrcodeDiv.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <div class="text-center">
                        <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-600">Génération du QR Code...</p>
                    </div>
                </div>
            `;
            
            let memberId = null;
            
            try {
                // 1. Essayer de récupérer l'ID membre depuis l'interface d'abord
                const memberIdElement = document.getElementById('member-id-display');
                if (memberIdElement && memberIdElement.textContent && memberIdElement.textContent !== 'CE-0000') {
                    memberId = memberIdElement.textContent;
                    console.log('✅ ID membre récupéré depuis l\'interface:', memberId);
                } else {
                    // 2. Essayer depuis la page carte
                    const cardMemberIdElement = document.getElementById('card-member-id');
                    if (cardMemberIdElement && cardMemberIdElement.textContent && cardMemberIdElement.textContent !== 'CE-0000') {
                        memberId = cardMemberIdElement.textContent;
                        console.log('✅ ID membre récupéré depuis la carte:', memberId);
                    } else {
                        // 3. Récupérer depuis Firestore
                        console.log('🔍 Récupération ID membre depuis Firestore...');
                        const userDoc = await db.collection('users').doc(userId).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            memberId = userData?.memberId;
                            console.log('📊 Données Firestore:', userData);
                        }
                    }
                }
                
            } catch (error) {
                console.error('❌ Erreur récupération ID membre:', error);
            }
            
            // 4. Si toujours pas d'ID membre, générer un fallback
            if (!memberId || memberId === 'CE-0000' || memberId === 'undefined') {
                console.warn('⚠️ Génération d\'un ID de fallback');
                const timestamp = Date.now().toString().slice(-4);
                const userIdSuffix = userId.slice(-4).toUpperCase();
                memberId = `CE-${userIdSuffix}`;
                console.log('🆔 ID de fallback généré:', memberId);
            }
            
            // 5. Générer le QR Code avec Canvas (méthode alternative)
            console.log('🚀 Génération du QR Code pour:', memberId);
            
            try {
                // Créer le container pour le QR Code
                qrcodeDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div class="flex justify-center">
                            <div id="large-qr-display" class="qr-container rounded-xl p-4 bg-white"></div>
                        </div>
                    </div>
                `;
                
                // Attendre que le DOM soit mis à jour
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const qrContainer = document.getElementById('large-qr-display');
                if (qrContainer) {
                    // Vider le container avant de générer le QR Code
                    qrContainer.innerHTML = '';
                    
                    // Vérifier que QRCode est disponible et générer
                    if (typeof QRCode !== 'undefined') {
                        try {
                            // Créer une nouvelle instance QRCode
                            const qrCode = new QRCode(qrContainer, {
                                text: memberId,
                                width: 200,
                                height: 200,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.M
                            });
                            
                            console.log('✅ QR Code généré avec succès pour:', memberId);
                            
                        } catch (qrLibError) {
                            console.error('❌ Erreur librairie QRCode:', qrLibError);
                            throw qrLibError;
                        }
                        
                    } else {
                        console.error('❌ Librairie QRCode non disponible');
                        throw new Error('Librairie QRCode non disponible');
                    }
                    
                } else {
                    throw new Error('Container QR Code non trouvé après création');
                }
                
            } catch (qrError) {
                console.error('❌ Erreur création QR Code:', qrError);
                
                // Affichage de fallback avec le code membre en grand
                qrcodeDiv.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div class="text-center space-y-4">
                            <div class="w-64 h-64 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl flex items-center justify-center mx-auto">
                                <div class="text-center">
                                    <div class="text-3xl font-black text-blue-600 mb-2">${memberId}</div>
                                    <div class="text-sm text-blue-500 font-semibold">Code Membre</div>
                                    <div class="text-xs text-gray-500 mt-2">Présentez ce code en caisse</div>
                                </div>
                            </div>
                            <button onclick="generateLargeQRCode('${userId}', ${retryCount + 1})" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-all">
                                🔄 Réessayer le QR Code
                            </button>
                            <p class="text-xs text-gray-500">Le QR Code n'a pas pu être généré, mais votre code membre fonctionne parfaitement</p>
                        </div>
                    </div>
                `;
                
                console.log('⚠️ Affichage de fallback avec le code membre');
            }
        }



        // Mettre à jour la progression du niveau
        function updateLevelProgress(points) {
            let currentLevel, nextLevel, progress, pointsToNext;
            
            if (points < 50) {
                currentLevel = 'Bronze';
                nextLevel = 'Argent';
                progress = (points / 50) * 100;
                pointsToNext = 50 - points;
            } else if (points < 100) {
                currentLevel = 'Argent';
                nextLevel = 'Or';
                progress = ((points - 50) / 50) * 100;
                pointsToNext = 100 - points;
            } else {
                currentLevel = 'Or';
                nextLevel = 'VIP';
                progress = 100;
                pointsToNext = 0;
            }
            
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('next-level').textContent = nextLevel;
            document.getElementById('level-progress').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('points-to-next').textContent = 
                pointsToNext > 0 ? `${pointsToNext} points pour le niveau suivant` : 'Niveau maximum atteint !';
        }

        // Animation des nombres
        function animateNumber(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 16);
        }

        // Actualiser les données - Version optimisée
        function refreshData() {
            if (!currentUser) {
                console.error('❌ Aucun utilisateur connecté pour actualiser');
                showMessage('Erreur: Aucun utilisateur connecté', 'error');
                return;
            }
            
            console.log('🔄 Actualisation des données utilisateur...');
            showMessage('🔄 Actualisation des données...', 'info');
            
            // Recharger les données utilisateur
            loadUserData(currentUser);
            
            setTimeout(() => {
                showMessage('✅ Données actualisées !', 'success');
                console.log('✅ Actualisation terminée');
            }, 1500);
        }

        // Partager l'application avec options réseaux sociaux
        function shareApp() {
            const shareText = `🎉 Rejoignez-moi dans le Club Avantage CE ! Points de fidélité, réductions exclusives et bien plus. Inscrivez-vous : ${window.location.href}`;
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(window.location.href);
            
            // Créer un menu de partage pour l'application
            const shareMenu = document.createElement('div');
            shareMenu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50';
            shareMenu.innerHTML = `
                <div class="bg-white rounded-t-3xl p-6 w-full max-w-md animate-slide-up">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Partager l'application</h3>
                        <p class="text-sm text-gray-600 mt-2">Invitez vos amis à rejoindre le Club Avantage CE</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <!-- WhatsApp -->
                        <a href="https://wa.me/?text=${encodedText}" target="_blank" 
                           class="flex flex-col items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">WhatsApp</span>
                        </a>
                        
                        <!-- Facebook -->
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Facebook</span>
                        </a>
                        
                        <!-- Twitter -->
                        <a href="https://twitter.com/intent/tweet?text=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-all">
                            <div class="w-12 h-12 bg-sky-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Twitter</span>
                        </a>
                        
                        <!-- Telegram -->
                        <a href="https://t.me/share/url?url=${encodedUrl}&text=${encodedText}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Telegram</span>
                        </a>
                        
                        <!-- LinkedIn -->
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}" target="_blank"
                           class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                            <div class="w-12 h-12 bg-blue-700 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">LinkedIn</span>
                        </a>
                        
                        <!-- Copier -->
                        <button onclick="copyAppLink('${shareText}')"
                                class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all">
                            <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </div>
                            <span class="text-xs font-medium text-gray-700">Copier</span>
                        </button>
                    </div>
                    
                    <button onclick="closeShareMenu()" 
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                        Fermer
                    </button>
                </div>
            `;
            
            document.body.appendChild(shareMenu);
            
            // Fermer en cliquant à l'extérieur
            shareMenu.addEventListener('click', (e) => {
                if (e.target === shareMenu) {
                    closeShareMenu();
                }
            });
        }
        
        // Copier le lien de l'application
        function copyAppLink(shareText) {
            navigator.clipboard.writeText(shareText).then(() => {
                showMessage('📋 Lien de l\'application copié !', 'success');
                closeShareMenu();
            });
        }

        // Partager le code de parrainage avec options réseaux sociaux
        function shareReferralCode() {
            const referralCode = document.getElementById('referral-code-display').textContent;
            
            if (referralCode && referralCode !== 'LOADING...') {
                const shareText = `🎁 Rejoignez le Club Avantage CE avec mon code de parrainage : ${referralCode}\n\nVous recevrez 50 points bonus à l'inscription et moi aussi ! 🎉\n\nInscrivez-vous ici : ${window.location.href}`;
                const encodedText = encodeURIComponent(shareText);
                const encodedUrl = encodeURIComponent(window.location.href);
                
                // Créer un menu de partage
                const shareMenu = document.createElement('div');
                shareMenu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50';
                shareMenu.innerHTML = `
                    <div class="bg-white rounded-t-3xl p-6 w-full max-w-md animate-slide-up">
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Partager mon code</h3>
                            <p class="text-sm text-gray-600 mt-2">Code: <span class="font-bold text-blue-600">${referralCode}</span></p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <!-- WhatsApp -->
                            <a href="https://wa.me/?text=${encodedText}" target="_blank" 
                               class="flex flex-col items-center p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">WhatsApp</span>
                            </a>
                            
                            <!-- Facebook -->
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Facebook</span>
                            </a>
                            
                            <!-- Twitter -->
                            <a href="https://twitter.com/intent/tweet?text=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-all">
                                <div class="w-12 h-12 bg-sky-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Twitter</span>
                            </a>
                            
                            <!-- Telegram -->
                            <a href="https://t.me/share/url?url=${encodedUrl}&text=${encodedText}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Telegram</span>
                            </a>
                            
                            <!-- LinkedIn -->
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}" target="_blank"
                               class="flex flex-col items-center p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                                <div class="w-12 h-12 bg-blue-700 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">LinkedIn</span>
                            </a>
                            
                            <!-- Copier -->
                            <button onclick="copyReferralCode('${referralCode}', '${shareText}')"
                                    class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all">
                                <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Copier</span>
                            </button>
                        </div>
                        
                        <button onclick="closeShareMenu()" 
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                            Fermer
                        </button>
                    </div>
                `;
                
                document.body.appendChild(shareMenu);
                
                // Fermer en cliquant à l'extérieur
                shareMenu.addEventListener('click', (e) => {
                    if (e.target === shareMenu) {
                        closeShareMenu();
                    }
                });
                
            } else {
                showMessage('⏳ Code de parrainage en cours de chargement...', 'info');
            }
        }
        
        // Copier le code de parrainage
        function copyReferralCode(code, fullText) {
            navigator.clipboard.writeText(fullText).then(() => {
                showMessage('📋 Code de parrainage copié !', 'success');
                closeShareMenu();
            });
        }
        
        // Fermer le menu de partage
        function closeShareMenu() {
            const shareMenu = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (shareMenu) {
                shareMenu.remove();
            }
        }

        // Fonctions pour le catalogue de récompenses
        function showRewardsPage() {
            console.log('🎁 Affichage de la page des récompenses...');
            const rewardsPage = document.getElementById('rewards-page');
            if (rewardsPage) {
                rewardsPage.classList.remove('hidden');
                rewardsPage.style.display = 'block';
                
                // Bloquer le défilement du body principal
                document.body.style.overflow = 'hidden';
                
                // Charger les récompenses et mettre à jour le solde
                loadRewards();
                updateRewardsPointsBalance();
            }
        }

        function hideRewardsPage() {
            console.log('🔙 Fermeture de la page des récompenses...');
            const rewardsPage = document.getElementById('rewards-page');
            if (rewardsPage) {
                rewardsPage.classList.add('hidden');
                rewardsPage.style.display = 'none';
                
                // Restaurer le défilement du body principal
                document.body.style.overflow = 'auto';
            }
        }

        function updateRewardsPointsBalance() {
            const pointsElement = document.getElementById('points-balance');
            const rewardsPointsElement = document.getElementById('rewards-points-balance');
            
            if (pointsElement && rewardsPointsElement) {
                const currentPoints = pointsElement.textContent || '0';
                rewardsPointsElement.textContent = currentPoints;
            }
        }

        // Charger les récompenses depuis Firestore
        async function loadRewards() {
            console.log('📦 Chargement des récompenses...');
            const rewardsContainer = document.getElementById('rewards-container');
            
            if (!rewardsContainer) {
                console.error('❌ Container des récompenses non trouvé');
                return;
            }

            try {
                // Afficher le chargement
                rewardsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="loading-spinner w-12 h-12 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-white">Chargement des récompenses...</p>
                    </div>
                `;

                // Essayer de charger depuis Firestore
                const rewardsSnapshot = await db.collection('rewards').orderBy('cout', 'asc').get();
                
                rewardsContainer.innerHTML = '';
                
                if (rewardsSnapshot.empty) {
                    // Si pas de récompenses dans Firestore, créer des récompenses par défaut
                    console.log('📝 Création des récompenses par défaut...');
                    await createDefaultRewards();
                    // Recharger après création
                    loadRewards();
                    return;
                }

                // Afficher les récompenses
                rewardsSnapshot.forEach((doc) => {
                    const reward = doc.data();
                    const rewardElement = createRewardElement(doc.id, reward);
                    rewardsContainer.appendChild(rewardElement);
                });

                console.log('✅ Récompenses chargées:', rewardsSnapshot.size);

            } catch (error) {
                console.error('❌ Erreur chargement récompenses:', error);
                
                // Afficher des récompenses par défaut en cas d'erreur
                rewardsContainer.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 text-center">
                        <p class="text-white mb-4">⚠️ Impossible de charger les récompenses</p>
                        <button onclick="loadRewards()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all">
                            🔄 Réessayer
                        </button>
                    </div>
                `;
            }
        }

        // Créer des récompenses par défaut
        async function createDefaultRewards() {
            const defaultRewards = [
                {
                    nom: "Bon de réduction -5%",
                    description: "Réduction de 5% sur votre prochain achat",
                    cout: 100,
                    type: "reduction",
                    valeur: "5%",
                    emoji: "🎫"
                },
                {
                    nom: "Spatule Professionnelle",
                    description: "Spatule en inox de qualité professionnelle",
                    cout: 200,
                    type: "produit",
                    valeur: "1 unité",
                    emoji: "🍳"
                },
                {
                    nom: "Bon de réduction -10%",
                    description: "Réduction de 10% sur votre prochain achat",
                    cout: 300,
                    type: "reduction",
                    valeur: "10%",
                    emoji: "🎟️"
                },
                {
                    nom: "Set de 3 Couteaux",
                    description: "Set de couteaux de cuisine professionnels",
                    cout: 500,
                    type: "produit",
                    valeur: "1 set",
                    emoji: "🔪"
                },
                {
                    nom: "Bon de réduction -15%",
                    description: "Réduction de 15% sur votre prochain achat",
                    cout: 600,
                    type: "reduction",
                    valeur: "15%",
                    emoji: "🎊"
                },
                {
                    nom: "Tablier Professionnel CE",
                    description: "Tablier de cuisine Central Equipements",
                    cout: 400,
                    type: "produit",
                    valeur: "1 unité",
                    emoji: "👨‍🍳"
                }
            ];

            try {
                const batch = db.batch();
                defaultRewards.forEach((reward, index) => {
                    const rewardRef = db.collection('rewards').doc(`reward_${index + 1}`);
                    batch.set(rewardRef, {
                        ...reward,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        active: true
                    });
                });
                
                await batch.commit();
                console.log('✅ Récompenses par défaut créées');
                
            } catch (error) {
                console.error('❌ Erreur création récompenses par défaut:', error);
            }
        }

        // Créer un élément de récompense
        function createRewardElement(rewardId, reward) {
            const div = document.createElement('div');
            div.className = 'bg-white/10 backdrop-blur-sm rounded-2xl p-6 border border-white/20';
            
            const userPoints = parseInt(document.getElementById('points-balance')?.textContent || '0');
            const canAfford = userPoints >= reward.cout;
            const buttonClass = canAfford 
                ? 'bg-green-500 hover:bg-green-600 text-white' 
                : 'bg-gray-400 text-gray-200 cursor-not-allowed';
            
            div.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="text-4xl">${reward.emoji || '🎁'}</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-1">${reward.nom}</h3>
                        <p class="text-white/80 text-sm mb-3">${reward.description}</p>
                        <div class="flex items-center justify-between">
                            <div class="text-yellow-300 font-bold text-lg">${reward.cout} points</div>
                            <button onclick="exchangeReward('${rewardId}', '${reward.nom}', ${reward.cout})" 
                                    class="${buttonClass} px-4 py-2 rounded-lg font-semibold transition-all text-sm"
                                    ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? '✨ Échanger' : '❌ Pas assez de points'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Échanger une récompense
        async function exchangeReward(rewardId, rewardName, cost) {
            if (!currentUser) {
                showMessage('❌ Vous devez être connecté pour échanger des récompenses', 'error');
                return;
            }

            const userPoints = parseInt(document.getElementById('points-balance')?.textContent || '0');
            
            if (userPoints < cost) {
                showMessage('❌ Vous n\'avez pas assez de points pour cette récompense', 'error');
                return;
            }

            // Confirmation
            const confirmed = confirm(`Voulez-vous échanger ${cost} points contre "${rewardName}" ?`);
            if (!confirmed) return;

            try {
                showMessage('⏳ Échange en cours...', 'info');

                // Générer un code unique de récompense
                const rewardCode = generateRewardCode();
                
                // Transaction pour déduire les points et enregistrer l'échange
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    const userDoc = await transaction.get(userRef);
                    
                    if (!userDoc.exists) {
                        throw new Error('Utilisateur non trouvé');
                    }
                    
                    const userData = userDoc.data();
                    const currentPoints = userData.points || 0;
                    
                    if (currentPoints < cost) {
                        throw new Error('Points insuffisants');
                    }
                    
                    // Déduire les points
                    transaction.update(userRef, {
                        points: currentPoints - cost
                    });
                    
                    // Enregistrer l'échange
                    const exchangeRef = db.collection('users').doc(currentUser.uid).collection('exchanges').doc();
                    transaction.set(exchangeRef, {
                        rewardId: rewardId,
                        rewardName: rewardName,
                        cost: cost,
                        rewardCode: rewardCode,
                        status: 'active',
                        exchangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        usedAt: null
                    });
                    
                    // Ajouter à l'historique
                    const historyRef = db.collection('users').doc(currentUser.uid).collection('history').doc();
                    transaction.set(historyRef, {
                        type: 'echange',
                        description: `Échange: ${rewardName}`,
                        points: -cost,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                showMessage('🎉 Échange réussi ! Votre code de récompense a été généré.', 'success');
                
                // Afficher le code de récompense
                showRewardCode(rewardName, rewardCode);
                
                // Actualiser l'affichage des points
                updateRewardsPointsBalance();
                
                // Recharger les récompenses pour mettre à jour les boutons
                setTimeout(() => {
                    loadRewards();
                }, 1000);

            } catch (error) {
                console.error('❌ Erreur échange récompense:', error);
                showMessage('❌ Erreur lors de l\'échange. Veuillez réessayer.', 'error');
            }
        }

        // Générer un code de récompense unique
        function generateRewardCode() {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `CE-${timestamp}-${random}`;
        }

        // Afficher le code de récompense
        function showRewardCode(rewardName, rewardCode) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center animate-slide-up">
                    <div class="text-6xl mb-4">🎉</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Échange Réussi !</h2>
                    <p class="text-gray-600 mb-6">Votre récompense "${rewardName}" est prête !</p>
                    
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
                        <p class="text-sm opacity-90 mb-2">Votre Code de Récompense :</p>
                        <div class="text-2xl font-black tracking-wider">${rewardCode}</div>
                        <p class="text-xs opacity-80 mt-2">Présentez ce code en magasin</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="copyRewardCode('${rewardCode}')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition-all">
                            📋 Copier le Code
                        </button>
                        <button onclick="closeRewardModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                            Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fermer en cliquant à l'extérieur
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeRewardModal();
                }
            });
        }

        // Copier le code de récompense
        function copyRewardCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showMessage('📋 Code de récompense copié !', 'success');
                closeRewardModal();
            });
        }

        // Fermer la modal de récompense
        function closeRewardModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        // Charger les promos flash depuis Firestore
        async function loadFlashPromos() {
            console.log('⚡ Chargement des promos flash...');
            const promosContainer = document.getElementById('flash-promos-container');
            
            if (!promosContainer) {
                console.error('❌ Container des promos flash non trouvé');
                return;
            }

            try {
                // Afficher le chargement
                promosContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                        <p class="text-sm text-gray-600">Chargement des promos...</p>
                    </div>
                `;

                // Récupérer les promos actives depuis Firestore
                const now = new Date();
                const promosSnapshot = await db.collection('promos')
                    .where('dateFin', '>', now)
                    .where('active', '==', true)
                    .orderBy('dateFin', 'asc')
                    .limit(3)
                    .get();
                
                promosContainer.innerHTML = '';
                
                if (promosSnapshot.empty) {
                    // Si pas de promos dans Firestore, créer des promos par défaut
                    console.log('📝 Création des promos par défaut...');
                    await createDefaultPromos();
                    // Recharger après création
                    setTimeout(() => loadFlashPromos(), 1000);
                    return;
                }

                // Afficher les promos
                promosSnapshot.forEach((doc) => {
                    const promo = doc.data();
                    const promoElement = createPromoElement(doc.id, promo);
                    promosContainer.appendChild(promoElement);
                });

                console.log('✅ Promos flash chargées:', promosSnapshot.size);

            } catch (error) {
                console.error('❌ Erreur chargement promos flash:', error);
                
                // Afficher un message d'erreur avec bouton de rechargement
                promosContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                        <p class="text-red-600 text-sm mb-2">⚠️ Impossible de charger les promos</p>
                        <button onclick="loadFlashPromos()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-all">
                            🔄 Réessayer
                        </button>
                    </div>
                `;
            }
        }

        // Créer des promos par défaut
        async function createDefaultPromos() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(23, 59, 59, 999);
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            nextWeek.setHours(23, 59, 59, 999);

            const defaultPromos = [
                {
                    titre: "🔥 Flash Sale - 20% sur tout !",
                    description: "Réduction exceptionnelle sur tous nos équipements de cuisine professionnelle",
                    dateFin: firebase.firestore.Timestamp.fromDate(tomorrow),
                    imageURL: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=400",
                    active: true,
                    type: "flash",
                    reduction: "20%"
                },
                {
                    titre: "⭐ Nouveautés Arrivées !",
                    description: "Découvrez notre nouvelle gamme d'équipements professionnels",
                    dateFin: firebase.firestore.Timestamp.fromDate(nextWeek),
                    imageURL: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400",
                    active: true,
                    type: "nouveaute",
                    reduction: null
                },
                {
                    titre: "🎁 Double Points Aujourd'hui",
                    description: "Gagnez le double de points sur tous vos achats aujourd'hui seulement !",
                    dateFin: firebase.firestore.Timestamp.fromDate(tomorrow),
                    imageURL: "https://images.unsplash.com/photo-1607083206869-4c7672e72a8a?w=400",
                    active: true,
                    type: "points",
                    reduction: null
                }
            ];

            try {
                const batch = db.batch();
                defaultPromos.forEach((promo, index) => {
                    const promoRef = db.collection('promos').doc(`promo_${index + 1}`);
                    batch.set(promoRef, {
                        ...promo,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                console.log('✅ Promos par défaut créées');
                
            } catch (error) {
                console.error('❌ Erreur création promos par défaut:', error);
            }
        }

        // Créer un élément de promo
        function createPromoElement(promoId, promo) {
            const div = document.createElement('div');
            div.className = 'bg-gradient-to-r from-red-500 to-pink-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-all cursor-pointer transform hover:scale-105';
            
            // Calculer le temps restant
            const now = new Date();
            const endDate = promo.dateFin.toDate ? promo.dateFin.toDate() : new Date(promo.dateFin);
            const timeLeft = endDate - now;
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            let timeLeftText = '';
            if (hoursLeft > 24) {
                const daysLeft = Math.floor(hoursLeft / 24);
                timeLeftText = `${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''}`;
            } else if (hoursLeft > 0) {
                timeLeftText = `${hoursLeft}h ${minutesLeft}min restantes`;
            } else if (minutesLeft > 0) {
                timeLeftText = `${minutesLeft} minutes restantes`;
            } else {
                timeLeftText = 'Expire bientôt !';
            }
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-1">${promo.titre}</h4>
                        <p class="text-white/90 text-sm mb-2">${promo.description}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">⏰ ${timeLeftText}</span>
                            ${promo.reduction ? `<span class="text-xl font-black">${promo.reduction}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-2xl">
                        ${promo.type === 'flash' ? '🔥' : promo.type === 'nouveaute' ? '⭐' : '🎁'}
                    </div>
                </div>
            `;
            
            // Ajouter un événement de clic pour plus de détails
            div.addEventListener('click', () => {
                showPromoDetails(promoId, promo);
            });
            
            return div;
        }

        // Afficher les détails d'une promo
        function showPromoDetails(promoId, promo) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const endDate = promo.dateFin.toDate ? promo.dateFin.toDate() : new Date(promo.dateFin);
            const formattedDate = endDate.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center animate-slide-up">
                    <div class="text-6xl mb-4">
                        ${promo.type === 'flash' ? '🔥' : promo.type === 'nouveaute' ? '⭐' : '🎁'}
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${promo.titre}</h2>
                    <p class="text-gray-600 mb-6">${promo.description}</p>
                    
                    ${promo.reduction ? `
                        <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl p-6 text-white mb-6">
                            <p class="text-sm opacity-90 mb-2">Réduction Exceptionnelle</p>
                            <div class="text-4xl font-black">${promo.reduction}</div>
                            <p class="text-xs opacity-80 mt-2">Sur tous les produits éligibles</p>
                        </div>
                    ` : ''}
                    
                    <div class="bg-gray-100 rounded-xl p-4 mb-6">
                        <p class="text-sm text-gray-600 mb-1">Valable jusqu'au :</p>
                        <p class="font-bold text-gray-800">${formattedDate}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="visitStore()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all">
                            🏪 Visiter le Magasin
                        </button>
                        <button onclick="closePromoModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all">
                            Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fermer en cliquant à l'extérieur
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePromoModal();
                }
            });
        }

        // Visiter le magasin (action fictive)
        function visitStore() {
            showMessage('🏪 Redirection vers le magasin...', 'info');
            closePromoModal();
            // Ici vous pourriez rediriger vers une page de catalogue ou ouvrir un lien externe
        }

        // Fermer la modal de promo
        function closePromoModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                modal.remove();
            }
        }

        // Déconnexion - Version optimisée
        function logout() {
            console.log('🚪 Déconnexion en cours...');
            
            // Afficher l'écran de chargement pendant la déconnexion
            showLoadingScreen();
            
            // Nettoyer les écouteurs avant la déconnexion
            if (userDataListener) {
                console.log('🧹 Nettoyage de l\'écouteur Firestore...');
                userDataListener();
                userDataListener = null;
            }
            
            auth.signOut().then(() => {
                console.log('✅ Déconnexion réussie');
                
                // Réinitialiser les variables
                currentUser = null;
                
                showMessage('👋 À bientôt !', 'info');
                
            }).catch((error) => {
                console.error('❌ Erreur lors de la déconnexion:', error);
                hideLoadingScreen();
                showMessage('Erreur lors de la déconnexion', 'error');
            });
        }

        // Fonctions d'affichage/masquage des écrans - Version optimisée
        function showLoadingScreen() {
            console.log('⏳ Affichage de l\'écran de chargement');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (loadingScreen) {
                loadingScreen.classList.remove('hidden');
                loadingScreen.style.display = 'flex';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        function hideLoadingScreen() {
            console.log('✅ Masquage de l\'écran de chargement');
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
        }

        function showAuthScreen() {
            console.log('🔐 Affichage de l\'écran d\'authentification');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (authScreen) {
                authScreen.classList.remove('hidden');
                authScreen.style.display = 'block';
            }
            if (cardScreen) {
                cardScreen.classList.add('hidden');
                cardScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        function showCardScreen() {
            console.log('💳 Affichage de l\'écran de la carte membre');
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const cardScreen = document.getElementById('card-screen');
            const confirmationScreen = document.getElementById('confirmation-screen');
            
            if (cardScreen) {
                cardScreen.classList.remove('hidden');
                cardScreen.style.display = 'block';
            }
            if (authScreen) {
                authScreen.classList.add('hidden');
                authScreen.style.display = 'none';
            }
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                loadingScreen.style.display = 'none';
            }
            if (confirmationScreen) {
                confirmationScreen.classList.add('hidden');
                confirmationScreen.style.display = 'none';
            }
        }

        // Afficher les messages d'authentification
        function showAuthMessage(message, type = 'info') {
            const messageDiv = document.getElementById('auth-message');
            let className = 'p-2 rounded-lg font-medium ';
            
            switch(type) {
                case 'success':
                    className += 'bg-green-100 text-green-700 border border-green-300';
                    break;
                case 'error':
                    className += 'bg-red-100 text-red-700 border border-red-300';
                    break;
                case 'info':
                    className += 'bg-blue-100 text-blue-700 border border-blue-300';
                    break;
                default:
                    className += 'bg-gray-100 text-gray-700 border border-gray-300';
            }
            
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 4000);
            }
        }

        // Afficher les messages généraux
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Afficher la page de confirmation d'inscription
        function showConfirmationPage(prenom, nom, memberId) {
            console.log('🎉 Affichage de la page de confirmation pour:', prenom, nom, memberId);
            
            // Masquer tous les autres écrans
            hideAllScreens();
            
            // Afficher l'écran de confirmation
            const confirmationScreen = document.getElementById('confirmation-screen');
            if (confirmationScreen) {
                confirmationScreen.classList.remove('hidden');
                confirmationScreen.style.display = 'block';
            }
            
            // Mettre à jour les informations
            const memberIdDisplay = document.getElementById('confirmation-member-id');
            const memberIdCopy = document.getElementById('confirmation-member-id-copy');
            const confirmationName = document.getElementById('confirmation-name');
            
            if (memberIdDisplay) {
                memberIdDisplay.textContent = memberId;
            }
            if (memberIdCopy) {
                memberIdCopy.textContent = memberId;
            }
            if (confirmationName) {
                confirmationName.textContent = `${prenom} ${nom}`;
            }
            
            console.log('✅ Page de confirmation affichée avec succès');
        }

        // Aller vers l'espace membre depuis la confirmation
        function goToMemberArea() {
            console.log('🚀 Redirection vers l\'espace membre...');
            
            // L'utilisateur est déjà connecté grâce à l'inscription
            // On peut directement afficher l'écran de la carte
            showCardScreen();
            
            // Charger les données utilisateur si pas déjà fait
            if (currentUser) {
                loadUserData(currentUser);
            }
        }

        // Masquer tous les écrans
        function hideAllScreens() {
            const screens = ['loading-screen', 'auth-screen', 'confirmation-screen', 'card-screen'];
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('hidden');
                    screen.style.display = 'none';
                }
            });
        }

        // Fonction de formatage du téléphone avec validation sénégalaise
        function formatPhoneNumber(e) {
            const countryCode = document.getElementById('country-code').value;
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (countryCode === '+221') {
                // Format sénégalais: 7X XXX XX XX (9 chiffres: 70/75/76/77/78 + 7 chiffres)
                // Limiter à 9 chiffres
                value = value.substring(0, 9);
                
                // Formatage visuel: 7X XXX XX XX
                if (value.length >= 2) {
                    value = value.substring(0, 2) + ' ' + value.substring(2);
                }
                if (value.length >= 7) {
                    value = value.substring(0, 7) + ' ' + value.substring(7);
                }
                if (value.length >= 10) {
                    value = value.substring(0, 10) + ' ' + value.substring(10);
                }
            } else if (countryCode === '+33') {
                // Format français: 0X XX XX XX XX
                value = value.substring(0, 10);
                if (value.length >= 2) {
                    value = value.substring(0, 2) + ' ' + value.substring(2);
                }
                if (value.length >= 6) {
                    value = value.substring(0, 6) + ' ' + value.substring(6);
                }
                if (value.length >= 9) {
                    value = value.substring(0, 9) + ' ' + value.substring(9);
                }
            } else {
                // Format international générique
                value = value.substring(0, 15);
            }
            
            e.target.value = value;
        }
        
        // Fonction pour changer le placeholder selon le pays
        function updatePhonePlaceholder() {
            const countryCode = document.getElementById('country-code').value;
            const phoneInput = document.getElementById('signup-telephone');
            
            if (countryCode === '+221') {
                phoneInput.placeholder = '77 123 45 67';
            } else if (countryCode === '+33') {
                phoneInput.placeholder = '01 23 45 67 89';
            } else {
                phoneInput.placeholder = 'Numéro de téléphone';
            }
            
            // Vider le champ lors du changement de pays
            phoneInput.value = '';
        }
        
        // Formatage en temps réel du ticket
        function formatTicketInput(e) {
            let value = e.target.value.toUpperCase();
            
            // Supprimer les caractères non autorisés
            value = value.replace(/[^S0-9-]/g, '');
            
            // Limiter la longueur selon le format
            if (value.startsWith('S')) {
                // Format S00000
                value = value.substring(0, 6);
            } else {
                // Format 00000-003-0000
                value = value.substring(0, 14);
            }
            
            e.target.value = value;
        }

        // Initialiser les boutons de scroll
        function initScrollButtons() {
            // Gérer le scroll pour chaque page
            const pages = [
                { pageId: 'auth-screen', buttonId: 'scroll-to-top-auth' },
                { pageId: 'card-screen', buttonId: 'scroll-to-top-card' },
                { pageId: 'rewards-page', buttonId: 'scroll-to-top-rewards' },
                { pageId: 'full-card-page', buttonId: 'scroll-to-top-full-card' }
            ];

            pages.forEach(({ pageId, buttonId }) => {
                const page = document.getElementById(pageId);
                const button = document.getElementById(buttonId);
                
                if (page && button) {
                    page.addEventListener('scroll', () => {
                        if (page.scrollTop > 300) {
                            button.classList.remove('hidden');
                        } else {
                            button.classList.add('hidden');
                        }
                    });
                }
            });

            // Gérer le scroll pour le body principal (pour les pages non-fixed)
            window.addEventListener('scroll', () => {
                const authScreen = document.getElementById('auth-screen');
                const cardScreen = document.getElementById('card-screen');
                const authButton = document.getElementById('scroll-to-top-auth');
                const cardButton = document.getElementById('scroll-to-top-card');
                
                if (authScreen && !authScreen.classList.contains('hidden') && authButton) {
                    if (window.scrollY > 300) {
                        authButton.classList.remove('hidden');
                    } else {
                        authButton.classList.add('hidden');
                    }
                }
                
                if (cardScreen && !cardScreen.classList.contains('hidden') && cardButton) {
                    if (window.scrollY > 300) {
                        cardButton.classList.remove('hidden');
                    } else {
                        cardButton.classList.add('hidden');
                    }
                }
            });
        }

        // Fonction pour scroller vers le haut
        function scrollToTop(pageId) {
            const page = document.getElementById(pageId);
            if (page) {
                if (page.classList.contains('fixed')) {
                    // Pour les pages fixed (rewards, full-card)
                    page.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                } else {
                    // Pour les pages normales (auth, card)
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            }
        }


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9775b488703c785f',t:'MTc1NjU3MTc2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
